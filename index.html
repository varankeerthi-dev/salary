<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
      --secondary: #06b6d4; --success: #10b981; --holiday: #f59e0b;
      --halfday: #fb923c; --danger: #ef4444; --dark: #1f2937;
      --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
      --gray-300: #d1d5db; --gray-600: #4b5563; --gray-700: #374151; --gray-800: #1f2937;
      --gradient-primary: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --gradient-secondary: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      --gradient-success: linear-gradient(135deg,#4ade80 0%,#22c55e 100%);
      --gradient-advance: linear-gradient(135deg,#f59e0b 0%,#d97706 100%);
      --gradient-settings: linear-gradient(135deg,#64748b 0%,#475569 100%);

      /* Tab theme colors */
      --tab1-color: #059669; --tab1-bg: #ecfdf5; --tab1-hover: #d1fae5; --tab1-active: #10b981;
      --tab2-color: #2563eb; --tab2-bg: #eff6ff; --tab2-hover: #dbeafe; --tab2-active: #3b82f6;
      --tab3-color: #7c3aed; --tab3-bg: #f5f3ff; --tab3-hover: #ede9fe; --tab3-active: #8b5cf6;
      --tab4-color: #b45309; --tab4-bg: #fffbeb; --tab4-hover: #fef3c7; --tab4-active: #f59e0b;
      --tab5-color: #065f46; --tab5-bg: #ecfdf5; --tab5-hover: #a7f3d0; --tab5-active: #059669;
      --tab6-color: #1e3a8a; --tab6-bg: #eff6ff; --tab6-hover: #bfdbfe; --tab6-active: #1d4ed8;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:linear-gradient(to bottom right,#f0f9ff,#e0f2fe);
      min-height:100vh; color:var(--gray-700);
    }

    /* ══════════════ NAV TABS ══════════════ */
    nav {
      background:white; border-bottom:1px solid var(--gray-200);
      display:flex; justify-content:center; gap:0; padding:0;
      position:sticky; top:0; z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    nav button {
      padding:0 22px; height:56px; border:none; background:none; cursor:pointer;
      font-weight:700; font-size:11.5px;
      display:flex; align-items:center; gap:7px;
      transition:all 0.22s cubic-bezier(0.4,0,0.2,1);
      border-bottom:4px solid transparent; position:relative;
      letter-spacing:0.5px; text-transform:uppercase;
    }

    /* Colored dot indicator always visible */
    nav button::before {
      content:'';
      width:8px; height:8px; border-radius:50%;
      display:inline-block; flex-shrink:0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    nav button .tab-icon { font-size:15px; }

    /* ─── Tab 1 – Attendance: Emerald ─── */
    nav button:nth-child(1) { color: var(--tab1-color); }
    nav button:nth-child(1)::before { background: var(--tab1-active); }
    nav button:nth-child(1):hover:not(.active) {
      background: var(--tab1-hover);
      border-bottom-color: var(--tab1-active);
      color: #064e3b;
    }
    nav button:nth-child(1):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(16,185,129,0.25);
    }
    nav button:nth-child(1).active {
      background: var(--tab1-bg);
      border-bottom-color: var(--tab1-active);
      color: #064e3b;
    }
    nav button:nth-child(1).active::before {
      box-shadow: 0 0 0 3px rgba(16,185,129,0.3);
    }

    /* ─── Tab 2 – Correction: Blue ─── */
    nav button:nth-child(2) { color: var(--tab2-color); }
    nav button:nth-child(2)::before { background: var(--tab2-active); }
    nav button:nth-child(2):hover:not(.active) {
      background: var(--tab2-hover);
      border-bottom-color: var(--tab2-active);
      color: #1e3a8a;
    }
    nav button:nth-child(2):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
    }
    nav button:nth-child(2).active {
      background: var(--tab2-bg);
      border-bottom-color: var(--tab2-active);
      color: #1e3a8a;
    }

    /* ─── Tab 3 – Full Summary: Violet ─── */
    nav button:nth-child(3) { color: var(--tab3-color); }
    nav button:nth-child(3)::before { background: var(--tab3-active); }
    nav button:nth-child(3):hover:not(.active) {
      background: var(--tab3-hover);
      border-bottom-color: var(--tab3-active);
      color: #4c1d95;
    }
    nav button:nth-child(3):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(139,92,246,0.25);
    }
    nav button:nth-child(3).active {
      background: var(--tab3-bg);
      border-bottom-color: var(--tab3-active);
      color: #4c1d95;
    }

    /* ─── Tab 4 – Advance: Amber ─── */
    nav button:nth-child(4) { color: var(--tab4-color); }
    nav button:nth-child(4)::before { background: var(--tab4-active); }
    nav button:nth-child(4):hover:not(.active) {
      background: var(--tab4-hover);
      border-bottom-color: var(--tab4-active);
      color: #78350f;
    }
    nav button:nth-child(4):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.25);
    }
    nav button:nth-child(4).active {
      background: var(--tab4-bg);
      border-bottom-color: var(--tab4-active);
      color: #78350f;
    }

    /* ─── Tab 5 – Salary Slip: Teal ─── */
    nav button:nth-child(5) { color: var(--tab5-color); }
    nav button:nth-child(5)::before { background: var(--tab5-active); }
    nav button:nth-child(5):hover:not(.active) {
      background: var(--tab5-hover);
      border-bottom-color: var(--tab5-active);
      color: #064e3b;
    }
    nav button:nth-child(5):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(5,150,105,0.25);
    }
    nav button:nth-child(5).active {
      background: var(--tab5-bg);
      border-bottom-color: var(--tab5-active);
      color: #064e3b;
    }

    /* ─── Tab 6 – Settings: Deep Blue ─── */
    nav button:nth-child(6) { color: var(--tab6-color); }
    nav button:nth-child(6)::before { background: var(--tab6-active); }
    nav button:nth-child(6):hover:not(.active) {
      background: var(--tab6-hover);
      border-bottom-color: var(--tab6-active);
      color: #1e3a8a;
    }
    nav button:nth-child(6):hover:not(.active)::before {
      transform: scale(1.4);
      box-shadow: 0 0 0 3px rgba(29,78,216,0.25);
    }
    nav button:nth-child(6).active {
      background: var(--tab6-bg);
      border-bottom-color: var(--tab6-active);
      color: #1e3a8a;
    }

    /* Active tab label highlight */
    nav button.active .tab-label { text-decoration: underline; text-underline-offset: 3px; text-decoration-thickness: 2px; }

    /* ══════════════ LAYOUT ══════════════ */
    .tab-content { display:none; padding:10px 16px; max-width:1400px; margin:auto; animation:fadeIn 0.3s ease; }
    .tab-content.active { display:block; }
    #fullsummary.tab-content { max-width:none; padding:10px 0; background: transparent; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

    /* ══════════════ SPLIT SCREEN ══════════════ */
    .split-screen { display:grid; grid-template-columns:210px 1fr; gap:14px; min-height:calc(100vh - 130px); }
    .left-panel {
      background:white; border-radius:12px; padding:12px;
      display:flex; flex-direction:column; gap:6px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.08);
      position:sticky; top:70px; height:fit-content;
    }
    .left-panel-title {
      font-size:10px; font-weight:700; text-transform:uppercase;
      letter-spacing:1px; color:var(--gray-600); padding:6px 8px 4px; border-bottom:1px solid var(--gray-100); margin-bottom:4px;
    }
    .left-panel-btn {
      padding:10px 14px; border:none; background:transparent; border-radius:8px;
      cursor:pointer; text-align:left; font-weight:600; font-size:12px;
      color:var(--gray-600); transition:all 0.2s; display:flex; align-items:center; gap:8px;
    }
    .left-panel-btn:hover { background:var(--gray-100); color:var(--gray-800); }
    .left-panel-btn.active { background:var(--gradient-primary); color:white; box-shadow:0 4px 10px rgba(99,102,241,0.35); }
    .right-panel { min-width:0; }
    .right-section { display:none; }
    .right-section.active { display:block; }

    /* ══════════════ CARDS ══════════════ */
    /* ══════════════ ATTENDANCE TAB - MINIMALIST ══════════════ */
#attendance {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Control bar - clean minimal header */
#attendance .control-bar {
  background: white;
  box-shadow: none;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#attendance .control-bar h2 {
  font-size: 14px;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 0;
  margin: 0;
}

#attendance .control-bar h2 span {
  font-size: 18px;
}

#attendance .control-bar-left {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* Date navigation - clean buttons */
#attendance .date-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

#attendance .date-nav button {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  color: #475569;
  font-size: 16px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  width: 34px;
  height: 34px;
  border-radius: 7px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
}

#attendance .date-nav button:hover {
  background: #1e293b;
  color: white;
  border-color: #1e293b;
}

#attendance .date-nav input[type="date"] {
  background: #fafafa;
  border: 1.5px solid #e2e8f0;
  border-radius: 7px;
  font-size: 12px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  color: #374151;
  padding: 7px 10px;
  width: 180px;
  transition: border-color 0.15s;
}

#attendance .date-nav input[type="date"]:focus {
  border-color: #94a3b8;
  background: white;
  box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.12);
  outline: none;
}

/* Generate button */
#attendance .control-bar .btn-submit {
  background: #1e293b;
  border: 1px solid #1e293b;
  box-shadow: none;
  font-size: 11.5px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 7px 12px;
  color: white;
}

#attendance .control-bar .btn-submit:hover {
  background: #0f172a;
  transform: none;
  box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
}

/* Main attendance card */
#attendance .attendance-card {
  background: white;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  box-shadow: none;
  padding: 0;
  overflow: hidden;
}

/* Table styling */
#attendance table {
  width: 100%;
  border-collapse: collapse;
  margin: 0;
  font-family: 'Inter', sans-serif;
}

#attendance thead {
  background: #f8fafc;
}

#attendance th {
  background: #f8fafc;
  color: #64748b;
  font-size: 10.5px;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  padding: 10px 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: left;
  border-bottom: 1px solid #e2e8f0;
  border-radius: 0 !important;
}

#attendance th:nth-child(2),
#attendance th:nth-child(3) {
  width: 110px;
  text-align: center;
}

#attendance th:nth-child(4) {
  width: 70px;
  text-align: center;
}

#attendance th:nth-child(5) {
  min-width: 200px;
}

#attendance tbody tr {
  transition: background 0.15s ease;
}

#attendance tbody tr:hover {
  background: #fafafa;
}

#attendance td {
  padding: 8px 12px;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  color: #374151;
}

#attendance td:nth-child(2),
#attendance td:nth-child(3) {
  width: 110px;
  text-align: center;
}

#attendance td:nth-child(4) {
  width: 70px;
  text-align: center;
}

#attendance td:nth-child(5) {
  min-width: 200px;
}

#attendance tbody tr:last-child td {
  border-bottom: none;
}

/* Input fields inside table */
#attendance td input,
#attendance td select {
  background: #fafafa;
  border: 1.5px solid #e2e8f0;
  border-radius: 5px;
  font-size: 11.5px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  color: #374151;
  padding: 5px 7px;
  width: 100%;
  transition: border-color 0.15s, background 0.15s;
}

#attendance td input:focus,
#attendance td select:focus {
  border-color: #94a3b8;
  background: white;
  box-shadow: 0 0 0 3px rgba(148, 162, 158, 0.12);
  outline: none;
}

#attendance .time-column {
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  white-space: nowrap;
  min-width: 55px;
  max-width: 70px;
  text-align: center;
}

/* OT input styling */
#attendance .row-ot {
  width: 100%;
  text-align: center;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  color: #059669;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 5px;
  padding: 4px 2px;
}

/* Action buttons in table */
#attendance .action-cell {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  align-items: center;
  max-width: 240px;
}

#attendance .btn-sunday-worked {
  background: #f0fdfa;
  color: #0f766e;
  border: 1px solid #99f6e4;
  font-size: 10px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 4px 7px;
  border-radius: 5px;
  transition: all 0.15s;
}

#attendance .btn-sunday-worked:hover {
  background: #ccfbf1;
  border-color: #5eead4;
}

#attendance .btn-sunday-worked.active {
  background: #0f766e;
  color: white;
  border-color: #0f766e;
}

#attendance .btn-sunday-holiday {
  background: #fffbeb;
  color: #b45309;
  border: 1px solid #fde68a;
  font-size: 10px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 4px 7px;
  border-radius: 5px;
  transition: all 0.15s;
}

#attendance .btn-sunday-holiday:hover {
  background: #fef3c7;
  border-color: #fbbf24;
}

#attendance .btn-sunday-holiday.active {
  background: #b45309;
  color: white;
  border-color: #b45309;
}

#attendance .btn-absent {
  background: white;
  color: #ef4444;
  border: 1.5px solid #fecaca;
  font-size: 10px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 4px 7px;
  border-radius: 5px;
  transition: all 0.15s;
}

#attendance .btn-absent:hover {
  background: #fef2f2;
  border-color: #ef4444;
}

/* Row states */
#attendance .absent-row td {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
}

#attendance .sunday-holiday-row td {
  background: linear-gradient(135deg, #fff7e6, #ffe8cc) !important;
}

#attendance .sunday-date {
  background: #f3e8ff !important;
  font-weight: 600;
}

/* Delete button in table */
#attendance .btn-delete-row {
  background: white;
  color: #ef4444;
  border: 1.5px solid #fecaca;
  padding: 4px 8px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.15s;
}

#attendance .btn-delete-row:hover {
  background: #fef2f2;
  border-color: #ef4444;
  transform: scale(1.05);
}

/* Bottom action bar */
#attendance .action-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0;
  padding: 14px 18px;
  border-top: 1px solid #f1f5f9;
  background: #fafafa;
}

#attendance .btn-add-row {
  background: white;
  color: #475569;
  border: 1.5px dashed #cbd5e1;
  font-weight: 600;
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  border-radius: 7px;
  display: inline-flex;
  padding: 7px 14px;
  align-items: center;
  gap: 4px;
  transition: all 0.15s;
}

#attendance .btn-add-row:hover {
  background: #f8fafc;
  border-color: #94a3b8;
  color: #1e293b;
}

#attendance .btn-clear {
  background: #f8fafc;
  color: #64748b;
  border: 1px solid #e2e8f0;
  font-size: 11px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 7px 12px;
  border-radius: 7px;
  transition: all 0.15s;
}

#attendance .btn-clear:hover {
  background: white;
  border-color: #cbd5e1;
  color: #475569;
}

#attendance .btn-submit {
  background: #1e293b;
  border: 1px solid #1e293b;
  box-shadow: none;
  font-size: 11.5px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  padding: 7px 14px;
  color: white;
  border-radius: 7px;
  transition: all 0.15s;
}

#attendance .btn-submit:hover {
  background: #0f172a;
  transform: none;
  box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
}

/* Processing indicator */
#attendance #processing-indicator {
  display: none;
  align-items: center;
  gap: 6px;
  color: #64748b;
  font-weight: 600;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
}

#attendance .spinner-small {
  width: 16px;
  height: 16px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #475569;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Time reference card */
#attendance .time-reference-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px 14px;
  margin-top: 14px;
}

#attendance .time-reference-card .reference-title {
  font-size: 10px;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  color: #64748b;
  margin-bottom: 6px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 4px;
}

#attendance .time-reference-card table {
  border-collapse: collapse;
  margin: 0;
}

#attendance .time-reference-card td {
  padding: 3px 6px;
  font-size: 10px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  text-align: center;
  border: 1px solid #e0f2fe;
  background: #f0f9ff;
  color: #0369a1;
  border-radius: 3px;
}

#attendance .time-reference-card td:first-child {
  background: transparent;
  border: none;
  color: #64748b;
  text-align: left;
  font-weight: 700;
  padding-right: 8px;
}

/* ══════════════ GLOBAL STYLES (for all other tabs) ══════════════ */
.attendance-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  padding: 10px;
  border: 1px solid var(--gray-200);
}

.control-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding: 10px 12px;
  background: var(--gradient-primary);
  border-radius: 10px;
  color: white;
  box-shadow: 0 4px 12px rgba(102,102,241,0.3);
}

.control-bar-left {
  display: flex;
  gap: 8px;
  align-items: center;
}

.date-nav {
  display: flex;
  align-items: center;
  gap: 6px;
}

.date-nav button {
  background: white;
  border: 1px solid #333;
  color: #000;
  font-size: 18px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.date-nav button:hover {
  background: #eee;
  transform: scale(1.1);
}

/* ══════════════ TABLES (global for other tabs) ══════════════ */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 8px;
}

thead {
  background: var(--gradient-primary);
}

th {
  padding: 7px 5px;
  color: white;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  text-align: left;
}

th:first-child {
  border-radius: 10px 0 0 0;
}

th:last-child {
  border-radius: 0 10px 0 0;
}

tbody tr {
  transition: all 0.2s ease;
  background: white;
}

tbody tr:hover {
  background: var(--gray-50);
}

td {
  padding: 5px 6px;
  border-bottom: 1px solid var(--gray-100);
  vertical-align: middle;
  font-size: 11px;
}

td.time-column {
  font-size: 10.5px;
  white-space: nowrap;
  min-width: 55px;
  max-width: 70px;
  text-align: center;
}

.row-ot {
  width: 100%;
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: var(--success);
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  border-radius: 6px;
  padding: 4px 2px;
}

/* ══════════════ INPUTS (global) ══════════════ */
input, select {
  padding: 5px 7px;
  border: 1.5px solid var(--gray-200);
  border-radius: 6px;
  width: 100%;
  font-size: 12px;
  font-family: 'Inter', sans-serif;
  box-sizing: border-box;
  color: var(--gray-700);
  background-color: white;
  transition: all 0.2s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
}

label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  font-size: 12px;
  color: var(--gray-700);
}

/* ══════════════ BUTTONS (global) ══════════════ */
.btn {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 11px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}

.btn-submit {
  background: var(--gradient-primary);
  color: white;
  box-shadow: 0 4px 12px rgba(102,102,241,0.4);
}

.btn-submit:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(102,102,241,0.5);
}

.btn-clear, .btn-add-row {
  background: var(--gray-200);
  color: var(--gray-700);
}

.btn-add-row {
  margin: 12px auto 0;
  display: block;
  padding: 8px 16px;
}

.btn-absent {
  background: linear-gradient(135deg,#fca5a5 0%,#ef4444 100%);
  color: white;
  padding: 5px 8px;
  font-size: 11px;
  border-radius: 6px;
  font-weight: 600;
}

.btn-delete-row {
  background: #ef4444;
  color: white;
  padding: 4px 8px;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
  font-weight: 700;
  transition: all 0.2s;
}

.btn-delete-row:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
}

.btn-warning {
  background: var(--gradient-advance);
  color: white;
}

.btn-sunday-worked {
  background: #e6fffa;
  color: #0c8599;
  border: 1px solid #99e9f2;
}

.btn-sunday-worked.active {
  background: var(--success);
  color: white;
  border: none;
}

.btn-sunday-holiday {
  background: #fff4e6;
  color: #e67700;
  border: 1px solid #ffd8a8;
}

.btn-sunday-holiday.active {
  background: var(--holiday);
  color: white;
  border: none;
}

.absent-row td {
  background: linear-gradient(135deg,#fee2e2 0%,#fecaca 100%) !important;
}

.sunday-holiday-row td {
  background: linear-gradient(135deg,#fff7e6,#ffe8cc) !important;
}

.action-cell {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  align-items: center;
  max-width: 240px;
}

.action-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 2px solid var(--gray-100);
}

/* ══════════════ BADGES ══════════════ */
.badge {
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.badge-success {
  background: #d1fae5;
  color: #065f46;
}

.badge-danger {
  background: #fee2e2;
  color: #991b1b;
}

.badge-holiday {
  background: #fff3bf;
  color: #e67700;
}

.badge-halfday {
  background: #fed7aa;
  color: #c2410c;
}

/* ══════════════ MISC UI ══════════════ */
#processing-indicator, .processing-spinner {
  display: none;
  align-items: center;
  gap: 8px;
  color: var(--primary);
  font-weight: 600;
  font-size: 13px;
}

.spinner-small {
  width: 18px;
  height: 18px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg) }
  100% { transform: rotate(360deg) }
}

#toast {
  position: fixed;
  bottom: -100px;
  right: 30px;
  background: var(--gradient-success);
  color: white;
  padding: 16px 28px;
  border-radius: 12px;
  transition: 0.5s cubic-bezier(0.4,0,0.2,1);
  z-index: 9999;
  box-shadow: 0 10px 25px rgba(34,197,94,0.4);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

#toast.show {
  bottom: 30px;
}

.sunday-date {
  background: #f3e8ff !important;
  font-weight: 600;
}

.employee-separator {
  background: var(--gray-800) !important;
  padding: 2px !important;
  width: 4px !important;
}
    /* ── Rich per-employee column palette ── */
    /* Col 1 — Indigo */
    .emp-col-1 { background:#eef2ff !important; color:#3730a3 !important; }
    .employee-header.emp-col-1 { background:#4f46e5 !important; color:white !important; }
    /* Col 2 — Teal */
    .emp-col-2 { background:#f0fdfa !important; color:#134e4a !important; }
    .employee-header.emp-col-2 { background:#0f766e !important; color:white !important; }
    /* Col 3 — Amber */
    .emp-col-3 { background:#fffbeb !important; color:#78350f !important; }
    .employee-header.emp-col-3 { background:#b45309 !important; color:white !important; }
    /* Col 4 — Rose */
    .emp-col-4 { background:#fff1f2 !important; color:#881337 !important; }
    .employee-header.emp-col-4 { background:#be123c !important; color:white !important; }
    /* Col 5 — Violet */
    .emp-col-5 { background:#faf5ff !important; color:#4c1d95 !important; }
    .employee-header.emp-col-5 { background:#7c3aed !important; color:white !important; }
    /* Col 6 — Sky */
    .emp-col-6 { background:#f0f9ff !important; color:#0c4a6e !important; }
    .employee-header.emp-col-6 { background:#0369a1 !important; color:white !important; }

    /* Left-column pivot borders per employee group */
    .pivot-table td.emp-col-1:first-of-type,
    .pivot-table th.emp-col-1:first-of-type { border-left:2px solid #818cf8 !important; }
    .pivot-table td.emp-col-2:first-of-type,
    .pivot-table th.emp-col-2:first-of-type { border-left:2px solid #2dd4bf !important; }
    .pivot-table td.emp-col-3:first-of-type,
    .pivot-table th.emp-col-3:first-of-type { border-left:2px solid #f59e0b !important; }
    .pivot-table td.emp-col-4:first-of-type,
    .pivot-table th.emp-col-4:first-of-type { border-left:2px solid #fb7185 !important; }
    .pivot-table td.emp-col-5:first-of-type,
    .pivot-table th.emp-col-5:first-of-type { border-left:2px solid #a78bfa !important; }
    .pivot-table td.emp-col-6:first-of-type,
    .pivot-table th.emp-col-6:first-of-type { border-left:2px solid #38bdf8 !important; }

    /* ── Full Summary left panel — nav tab buttons ── */
    .fs-nav-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid transparent;
      border-radius: 9px;
      background: transparent;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s ease;
      margin-bottom: 4px;
    }
    .fs-nav-btn:hover {
      background: #f8fafc;
      border-color: #e2e8f0;
    }
    .fs-nav-btn.active {
      background: #1e293b;
      border-color: #1e293b;
    }
    .fs-nav-icon {
      font-size: 17px;
      flex-shrink: 0;
      width: 30px;
      text-align: center;
    }
    .fs-nav-title {
      font-size: 12px;
      font-weight: 700;
      color: #475569;
      line-height: 1.2;
    }
    .fs-nav-btn.active .fs-nav-title { color: white; }
    .fs-nav-sub {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 1px;
    }
    .fs-nav-btn.active .fs-nav-sub { color: #94a3b8; }
    .duplicate-warning { color:#ef4444; font-size:11px; margin-top:4px; font-weight:600; }
    .mode-selector { display:inline-flex; background:var(--gray-100); border-radius:8px; padding:4px; gap:4px; }
    .mode-selector button { padding:7px 14px; border:none; background:transparent; border-radius:6px; cursor:pointer; font-weight:600; font-size:11px; color:var(--gray-600); transition:all 0.2s; }
    .mode-selector button.active { background:white; color:var(--primary); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .advance-section { background:var(--gray-50); padding:10px 14px; border-radius:10px; margin-top:12px; }
    .salary-breakdown { background:white; padding:10px 14px; border-radius:10px; margin-top:0; border:2px solid var(--primary); }
    .salary-row { display:grid; grid-template-columns:1fr auto; align-items:center; gap:16px; max-width:520px; margin:0 auto; padding:6px 10px; border-bottom:1px solid var(--gray-200); }
    .salary-row:last-child { border-bottom:none; background:#f0fdf4; font-weight:700; font-size:15px; color:var(--success); border-radius:6px; }
    .salary-label { font-weight:600; color:var(--gray-700); font-size:12px; }
    .salary-value { font-weight:700; color:var(--primary); font-size:12px; }

    /* ══════════════ ADVANCE TAB SPECIFIC ══════════════ */
    .adv-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin-bottom:14px; }
    .adv-grid > div { display:flex; flex-direction:column; gap:4px; }
    .adv-table-wrap { overflow-x:auto; border-radius:8px; border:1px solid var(--gray-200); }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .section-title { font-size:18px; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .summary-card { background:white; border-radius:10px; padding:18px; border:1px solid var(--gray-200); box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .summary-stat { text-align:center; padding:8px 6px; border-radius:8px; }
    .summary-stat .stat-value { font-size:18px; font-weight:700; }
    .summary-stat .stat-label { font-size:10px; color:var(--gray-600); margin-top:2px; font-weight:600; }
    .ref-badge { font-size:10px; background:#e0e7ff; color:#3730a3; padding:2px 6px; border-radius:4px; font-weight:600; font-family:monospace; }

    /* ══════════════════════════════════════════════════
       ADVANCE TAB — MINIMALIST CLAUDE APPROACH
       All selectors scoped under #advance to avoid
       touching other tabs.
    ══════════════════════════════════════════════════ */

    /* ── Outer card container ── */
    #advance .attendance-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: none;
      padding: 20px 22px;
    }

    /* ── Left panel nav ── */
    #advance .left-panel {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: none;
      padding: 14px 10px;
      gap: 3px;
    }
    #advance .left-panel-title {
      font-size: 9.5px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #94a3b8;
      padding: 4px 10px 10px;
      border-bottom: 1px solid #f1f5f9;
      margin-bottom: 6px;
    }
    #advance .left-panel-btn {
      padding: 9px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      gap: 8px;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    #advance .left-panel-btn:hover {
      background: #f8fafc;
      color: #1e293b;
      border-color: #e2e8f0;
    }
    #advance .left-panel-btn.active {
      background: #1e293b;
      color: white;
      box-shadow: none;
      border-color: #1e293b;
    }
    #advance .left-panel-btn.active:hover {
      background: #0f172a;
    }

    /* ── Section title (header inside card) ── */
    #advance .section-title {
      font-size: 13px;
      font-weight: 700;
      color: #1e293b;
      gap: 8px;
      letter-spacing: 0;
    }
    #advance .section-header {
      padding-bottom: 14px;
      margin-bottom: 14px;
      border-bottom: 1px solid #f1f5f9;
    }

    /* ── Sub-heading labels inside sections (Reports/Summary h4) ── */
    #advance h4 {
      font-size: 11.5px !important;
      font-weight: 700 !important;
      color: #475569 !important;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 10px !important;
    }

    /* ── Table wrapper ── */
    #advance .adv-table-wrap {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      overflow: hidden; /* clip rounded corners on table */
      overflow-x: auto;
    }

    /* ── Global table header override inside #advance ── */
    #advance table { margin-top: 0; border-collapse: collapse; border-spacing: 0; }
    #advance thead { background: #f8fafc !important; }
    #advance th {
      background: #f8fafc !important;
      color: #64748b !important;
      font-size: 10.5px !important;
      font-weight: 700 !important;
      padding: 10px 10px !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e2e8f0 !important;
      white-space: nowrap;
    }
    #advance th:first-child { border-radius: 0 !important; }
    #advance th:last-child  { border-radius: 0 !important; }
    #advance td {
      padding: 8px 10px !important;
      font-size: 12px !important;
      border-bottom: 1px solid #f1f5f9 !important;
      color: #374151;
      vertical-align: middle;
    }
    #advance tbody tr:last-child td { border-bottom: none !important; }
    #advance tbody tr:hover { background: #fafafa !important; }

    /* ── INPUT TABLES (Add Expense / Add Advance rows)
       Give a slightly warm editable feel — soft amber row
       background when hovered, and clear input styling ── */
    #advance #expense-table thead,
    #advance #advance-recv-table thead { background: #fafaf8 !important; }
    #advance #expense-table th,
    #advance #advance-recv-table th {
      background: #fafaf8 !important;
      color: #78716c !important; /* warm stone tone */
    }
    #advance #expense-table td input,
    #advance #expense-table td select,
    #advance #advance-recv-table td input,
    #advance #advance-recv-table td select {
      background: #fffdf9;
      border: 1.5px solid #e7e5e4;
      border-radius: 5px;
      font-size: 11.5px;
      color: #292524;
      padding: 5px 7px;
      transition: border-color 0.15s, background 0.15s;
    }
    #advance #expense-table td input:focus,
    #advance #expense-table td select:focus,
    #advance #advance-recv-table td input:focus,
    #advance #advance-recv-table td select:focus {
      border-color: #a8a29e;
      background: white;
      box-shadow: 0 0 0 3px rgba(168,162,158,0.12);
      outline: none;
    }
    #advance #expense-table tbody tr:hover,
    #advance #advance-recv-table tbody tr:hover {
      background: #fdfaf5 !important;
    }

    /* ── ESCALATION search bar area ── */
    #adv-sec-escalation .attendance-card > div:not(.adv-table-wrap):first-of-type {
      background: #f8fafc;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 16px;
    }

    /* ── SUMMARY stat cards — keep semantic colours, go muted ── */
    #advance .summary-stat {
      border-radius: 10px;
      padding: 14px 10px;
      text-align: center;
    }
    /* Advance (green) */
    #advance .summary-stat[style*="ecfdf5"],
    #advance .summary-stat[style*="059669"] {
      background: #f0fdf8 !important;
      border: 1px solid #bbf7d0 !important;
    }
    #advance #sum-total-adv {
      color: #059669 !important;
      font-size: 22px !important;
      font-weight: 800 !important;
    }
    /* Expense (rose) */
    #advance .summary-stat[style*="fee2e2"],
    #advance .summary-stat[style*="ef4444"] {
      background: #fff5f5 !important;
      border: 1px solid #fecaca !important;
    }
    #advance #sum-total-exp {
      color: #dc2626 !important;
      font-size: 22px !important;
      font-weight: 800 !important;
    }
    /* Balance (blue) */
    #advance .summary-stat[style*="eff6ff"],
    #advance .summary-stat[style*="2563eb"] {
      background: #f0f7ff !important;
      border: 1px solid #bfdbfe !important;
    }
    #advance #sum-balance {
      font-size: 22px !important;
      font-weight: 800 !important;
    }
    #advance .summary-stat .stat-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* ── Advance/Expense sub-tables in Summary — differentiated headers ── */
    #advance #sum-adv-table thead { background: #f0fdf8 !important; }
    #advance #sum-adv-table th {
      background: #f0fdf8 !important;
      color: #059669 !important;
    }
    #advance #sum-exp-table thead { background: #fff5f5 !important; }
    #advance #sum-exp-table th {
      background: #fff5f5 !important;
      color: #dc2626 !important;
    }

    /* ── Report tables — category & employee ── */
    #advance #rep-category-table th,
    #advance #rep-emp-table th {
      background: #f8fafc !important;
      color: #475569 !important;
    }
    /* Highlight balance column in report  */
    #advance #rep-emp-table td:nth-child(4) { font-weight: 700; color: #1e293b; }
    #advance #rep-emp-table td:nth-child(5) { font-style: italic; color: #64748b; font-size: 11px !important; }

    /* ── Ref badge ── */
    #advance .ref-badge {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    /* ── BUTTONS inside #advance ── */

    /* Primary action — dark slate */
    #advance .btn-submit {
      background: #1e293b;
      color: white;
      box-shadow: none;
      border: 1px solid #1e293b;
    }
    #advance .btn-submit:hover {
      background: #0f172a;
      transform: none;
      box-shadow: 0 2px 8px rgba(15,23,42,0.18);
      border-color: #0f172a;
    }

    /* Export PDF — subtle slate-blue tint */
    #advance .btn-submit[onclick*="PDF"],
    #advance .btn-submit[onclick*="Pdf"] {
      background: #334155;
      border-color: #334155;
      color: #e2e8f0;
    }
    #advance .btn-submit[onclick*="PDF"]:hover,
    #advance .btn-submit[onclick*="Pdf"]:hover {
      background: #1e293b;
      border-color: #1e293b;
    }

    /* Add Row — ghost outlined */
    #advance .btn-add-row {
      background: white;
      color: #475569;
      border: 1.5px dashed #cbd5e1;
      font-weight: 600;
      font-size: 11px;
      border-radius: 7px;
      padding: 7px 16px;
      margin: 8px 0 0 0;
      display: inline-flex;
    }
    #advance .btn-add-row:hover {
      background: #f8fafc;
      border-color: #94a3b8;
      color: #1e293b;
    }

    /* Delete row — soft red, no gradient */
    #advance .btn-delete-row {
      background: white;
      color: #ef4444;
      border: 1.5px solid #fecaca;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 5px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
    }
    #advance .btn-delete-row:hover {
      background: #fef2f2;
      border-color: #ef4444;
      transform: none;
    }

    /* Filter/load inputs inside escalation & summary ── */
    #advance .right-section > .attendance-card > div:not([id]):not(.adv-table-wrap) label,
    #advance .right-section > .attendance-card > div[style*="flex"] label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    #advance .right-section > .attendance-card > div[style*="flex"] input,
    #advance .right-section > .attendance-card > div[style*="flex"] select {
      background: #fafafa;
      border: 1.5px solid #e2e8f0;
      border-radius: 7px;
      font-size: 12px;
      color: #374151;
      padding: 6px 9px;
    }
    #advance .right-section > .attendance-card > div[style*="flex"] input:focus,
    #advance .right-section > .attendance-card > div[style*="flex"] select:focus {
      border-color: #94a3b8;
      background: white;
      box-shadow: 0 0 0 3px rgba(148,163,184,0.12);
      outline: none;
    }

    /* ── Processing spinners ── */
    #advance .processing-spinner { color: #64748b; font-size: 12px; font-weight: 600; }
    #advance .spinner-small { border-top-color: #475569; }

    /* ── Report emp-wise summary — centered values + column dividers ── */
    #advance #rep-emp-table td,
    #advance #rep-emp-table th { text-align: center !important; }
    #advance #rep-emp-table td:first-child,
    #advance #rep-emp-table th:first-child { text-align: left !important; }
    #advance #rep-emp-table td { border-right: 1px solid #f1f5f9 !important; }
    #advance #rep-emp-table td:last-child { border-right: none !important; }
    #advance #rep-emp-table th { border-right: 1px solid #e2e8f0 !important; }
    #advance #rep-emp-table th:last-child { border-right: none !important; }
    /* Numeric cols — monospace alignment */
    #advance #rep-emp-table td:nth-child(2),
    #advance #rep-emp-table td:nth-child(3),
    #advance #rep-emp-table td:nth-child(4) {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #374151;
    }
    /* Balance col — bold dark */
    #advance #rep-emp-table td:nth-child(4) { font-weight: 800 !important; color: #1e293b !important; }
    /* Effect on salary */
    #advance #rep-emp-table td:nth-child(5) { font-style: italic; color: #64748b; font-size: 11px !important; }

    /* ── Salary breakdown container — constrain width + center ── */
    #salary-breakdown-content {
      max-width: 560px;
      margin: 0 auto;
    }

    /* ── Rep category table — center values too ── */
    #advance #rep-category-table td:nth-child(2),
    #advance #rep-category-table th:nth-child(2) { text-align: center !important; font-weight: 700; }
    #advance #rep-category-table td { border-right: 1px solid #f1f5f9 !important; }
    #advance #rep-category-table td:last-child { border-right: none !important; }
    #advance #rep-category-table th { border-right: 1px solid #e2e8f0 !important; }
    #advance #rep-category-table th:last-child { border-right: none !important; }

    /* ══════════════════════════════════════════════════
       SALARY SLIP — LEFT-NAV SPLIT (mirrors Advance tab)
    ══════════════════════════════════════════════════ */
    #salaryslip .split-screen {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 0;
      min-height: calc(100vh - 60px);
    }

    /* ── Left nav panel ── */
    #salaryslip .left-panel {
      background: white;
      border-right: 1px solid #e2e8f0;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: sticky;
      top: 56px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }
    #salaryslip .left-panel-title {
      font-size: 9.5px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #94a3b8;
      padding: 4px 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      margin-bottom: 6px;
    }
    #salaryslip .left-panel-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 12px;
      border: 1px solid transparent;
      border-radius: 9px;
      background: transparent;
      cursor: pointer;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      transition: all 0.15s ease;
      width: 100%;
    }
    #salaryslip .left-panel-btn:hover {
      background: #f8fafc;
      color: #1e293b;
      border-color: #e2e8f0;
    }
    #salaryslip .left-panel-btn.active {
      background: #1e293b;
      color: white;
      border-color: #1e293b;
      box-shadow: none;
    }
    #salaryslip .left-panel-btn .lp-icon { font-size: 16px; flex-shrink: 0; }
    #salaryslip .left-panel-btn .lp-text { display: flex; flex-direction: column; gap: 1px; }
    #salaryslip .left-panel-btn .lp-title { font-size: 12px; font-weight: 700; line-height: 1.2; }
    #salaryslip .left-panel-btn .lp-sub { font-size: 10px; color: #94a3b8; font-weight: 400; }
    #salaryslip .left-panel-btn.active .lp-sub { color: #64748b; }

    /* ── Right content panel ── */
    #salaryslip .right-panel {
      background: #f8fafc;
      padding: 20px;
      overflow-y: auto;
    }
    #salaryslip .right-section { display: none; }
    #salaryslip .right-section.active { display: block; }

    /* ── Individual slip card ── */
    .ss-slip-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 18px 20px;
      max-width: 680px;
      margin: 0 auto;
    }
    .ss-slip-card label {
      display: block;
      font-size: 10.5px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    .ss-slip-card select,
    .ss-slip-card input[type="number"] {
      background: #fafafa;
      border: 1.5px solid #e2e8f0;
      border-radius: 7px;
      font-size: 12px;
      color: #374151;
      padding: 6px 9px;
      width: 100%;
    }
    .ss-slip-card select:focus,
    .ss-slip-card input:focus {
      border-color: #94a3b8;
      background: white;
      outline: none;
      box-shadow: 0 0 0 3px rgba(148,163,184,0.12);
    }
    .ss-btn-primary {
      background: #1e293b !important;
      border: 1px solid #1e293b !important;
      box-shadow: none !important;
      font-size: 12px !important;
    }
    .ss-btn-primary:hover { background: #0f172a !important; transform: none !important; }

    /* ── All-employee report card ── */
    .ss-report-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      overflow: hidden;
    }
    .ss-report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid #e2e8f0;
      background: #1e293b;
      gap: 12px;
      flex-wrap: wrap;
    }
    .ss-report-header-left { display: flex; align-items: center; gap: 10px; }
    .ss-report-icon {
      width: 36px; height: 36px;
      background: rgba(255,255,255,0.1);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .ss-report-title { font-size: 13px; font-weight: 700; color: white; }
    .ss-report-sub { font-size: 10.5px; color: #94a3b8; margin-top: 1px; }
    .ss-filter-select {
      background: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.18) !important;
      border-radius: 6px !important;
      color: white !important;
      font-size: 11.5px !important;
      padding: 6px 8px !important;
      width: auto !important;
    }
    .ss-filter-select option { background: #1e293b; color: white; }
    .ss-btn-go {
      background: white; color: #1e293b;
      border: none; border-radius: 7px;
      padding: 7px 14px; font-size: 12px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; gap: 5px;
      white-space: nowrap; transition: all 0.15s;
    }
    .ss-btn-go:hover { background: #f1f5f9; }
    .ss-btn-export {
      background: transparent; color: #94a3b8;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 7px; padding: 7px 12px;
      font-size: 12px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; gap: 5px;
      white-space: nowrap; transition: all 0.15s;
    }
    .ss-btn-export:hover { border-color: rgba(255,255,255,0.4); color: white; }

    /* ── Consolidated table ── */
    .ss-report-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .ss-report-table thead { position: sticky; top: 0; z-index: 10; }
    .ss-report-table th {
      background: #f1f5f9; color: #475569;
      font-size: 9.5px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
      padding: 8px 10px; text-align: center;
      border-bottom: 1px solid #e2e8f0;
      border-right: 1px solid #e8edf2; white-space: nowrap;
    }
    .ss-report-table th:first-child { text-align: left; }
    .ss-report-table th:last-child { border-right: none; }
    .ss-report-table td {
      padding: 7px 10px; border-bottom: 1px solid #f1f5f9;
      border-right: 1px solid #f4f6f8;
      text-align: center; color: #374151; font-size: 11px; white-space: nowrap;
    }
    .ss-report-table td:first-child { text-align: left; font-weight: 600; color: #1e293b; }
    .ss-report-table td:last-child { border-right: none; }
    .ss-report-table tbody tr:hover { background: #fafafa; }
    .ss-report-table td.net-payable { color: #059669 !important; font-weight: 800 !important; font-size: 12px !important; }
    .ss-report-table tr.ss-group-header th { background: #1e293b; color: #94a3b8; font-size: 9px; letter-spacing: 1px; }
    .ss-report-table tr.ss-group-header th.ss-calc-group { background: #0f172a; color: #64748b; }
    .ss-report-table tfoot tr td {
      background: #f8fafc; font-weight: 700; color: #1e293b;
      border-top: 2px solid #e2e8f0; border-bottom: none; font-size: 11.5px;
    }
    .ss-report-table tfoot tr td.net-payable { color: #059669 !important; font-size: 13px !important; }
    .ss-report-table tfoot tr td:first-child { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; }

    /* ══════════════ SETTINGS TAB SPECIFIC ══════════════ */
    .cat-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .cat-row input { flex:1; }
    .proj-row { display:grid; grid-template-columns:1fr 1fr auto; gap:8px; margin-bottom:8px; align-items:center; }

    /* ══════════════════════════════════════════════════
       SALARY SLIP TAB — COMPACT MINIMALIST
    ══════════════════════════════════════════════════ */

    /* Outer wrapper — no box-shadow card, clean border */
    #salaryslip > .attendance-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: none;
      padding: 16px 20px;
    }

    /* Top gradient control-bar → clean minimal header strip */
    #salaryslip .control-bar {
      background: none;
      box-shadow: none;
      border-bottom: 1px solid #f1f5f9;
      padding: 0 0 10px 0;
      margin-bottom: 12px !important;
      border-radius: 0;
    }
    #salaryslip .control-bar h2 {
      font-size: 14px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #salaryslip .control-bar h2 span { font-size: 16px; }

    /* Selector row — tighter */
    #salaryslip > .attendance-card > div[style*="flex-wrap"] {
      gap: 8px;
      margin-bottom: 10px !important;
      align-items: flex-end;
    }
    #salaryslip select, #salaryslip input[type="number"] {
      font-size: 12px;
      padding: 6px 8px;
      border: 1.5px solid #e2e8f0;
      border-radius: 7px;
      background: #fafafa;
      color: #374151;
    }
    #salaryslip select:focus, #salaryslip input[type="number"]:focus {
      border-color: #94a3b8;
      background: white;
      box-shadow: 0 0 0 3px rgba(148,163,184,0.12);
      outline: none;
    }
    #salaryslip label {
      font-size: 10.5px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    /* Generate slip button */
    #salaryslip .btn-submit {
      background: #1e293b;
      border: 1px solid #1e293b;
      box-shadow: none;
      font-size: 12px;
      padding: 7px 14px;
    }
    #salaryslip .btn-submit:hover {
      background: #0f172a;
      transform: none;
      box-shadow: 0 2px 8px rgba(15,23,42,0.15);
    }

    /* ── EMPLOYEE HEADER CARD — compact info strip ── */
    #slip-header {
      padding: 10px 14px !important;
      border-radius: 9px !important;
      margin-bottom: 8px !important;
      border-left: 3px solid #334155 !important;
      border: 1px solid #e2e8f0 !important;
      border-left: 3px solid #334155 !important;
      background: #f8fafc !important;
    }
    /* Override inline styles injected by JS into slip-header */
    #slip-header * { line-height: 1.35; }

    /* ── STAT PILLS — tighter, smaller grid ── */
    #slip-totals {
      margin-bottom: 8px !important;
    }
    /* Target the grid div JS injects — override minmax for compactness */
    #slip-totals > div {
      gap: 5px !important;
      margin-bottom: 0 !important;
      grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)) !important;
    }
    /* Each stat pill */
    #slip-totals > div > div {
      padding: 6px 5px !important;
      border-radius: 8px;
    }
    #slip-totals .stat-value {
      font-size: 15px !important;
      font-weight: 800 !important;
      line-height: 1 !important;
    }
    #slip-totals .stat-label {
      font-size: 8.5px !important;
      margin-top: 2px !important;
      font-weight: 700 !important;
      letter-spacing: 0.3px;
    }

    /* ── SALARY BREAKDOWN — compact table ── */
    .salary-breakdown {
      border: 1px solid #e2e8f0 !important;
      border-radius: 10px !important;
      padding: 12px 14px !important;
      background: white;
    }
    #salaryslip .salary-breakdown h3 {
      font-size: 11px !important;
      font-weight: 700 !important;
      color: #64748b !important;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px !important;
      justify-content: flex-start !important;
      gap: 6px !important;
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 8px;
    }
    .salary-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 24px;
      padding: 5px 8px !important;
      border-bottom: 1px solid rgba(241,245,249,0.8) !important;
      font-size: 12px;
      border-radius: 4px;
    }
    /* Last row (NET) keeps its JS inline green bg; just tighten sizing */
    .salary-row:last-child {
      font-size: 13px !important;
      padding: 7px 10px !important;
      border-bottom: none !important;
      margin-top: 3px;
    }
    .salary-label {
      font-size: 12px !important;
      color: #475569 !important;
      font-weight: 500 !important;
    }
    /* salary-value inherits inline color from JS for semantic rows */
    .salary-value {
      font-size: 12px;
      color: #1e293b;
      font-weight: 700 !important;
      text-align: right;
      white-space: nowrap;
    }

    /* ── ADVANCE / EXPENSE ADJUSTMENT — compact ── */
    #salaryslip .advance-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 9px;
      padding: 10px 14px !important;
      margin-bottom: 8px !important;
    }
    #salaryslip .advance-section h4 {
      font-size: 11px !important;
      font-weight: 700 !important;
      color: #64748b !important;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      margin-bottom: 8px !important;
    }
    #advance-expense-info {
      padding: 10px 12px !important;
      border-radius: 7px !important;
      border: 1px solid #e2e8f0 !important;
      font-size: 12px;
      margin-bottom: 10px !important;
    }

    /* ── ATTENDANCE DETAIL — collapsible, compact ── */
    #salaryslip .attendance-card[style*="margin-bottom:10px"] {
      border: 1px solid #e2e8f0 !important;
      box-shadow: none !important;
      padding: 10px 14px !important;
      margin-bottom: 8px !important;
    }
    #salaryslip .attendance-card[style*="margin-bottom:10px"] h4 {
      font-size: 11px !important;
      color: #475569 !important;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 700 !important;
    }
    #salaryslip #att-detail-toggle-btn {
      background: white;
      color: #475569;
      border: 1px solid #e2e8f0;
      padding: 4px 10px;
      font-size: 10.5px;
      border-radius: 5px;
    }

    /* Attendance detail table */
    #salaryslip #slip-results-table thead { background: #f8fafc !important; }
    #salaryslip #slip-results-table th {
      background: #f8fafc !important;
      color: #64748b !important;
      font-size: 10.5px !important;
      font-weight: 700 !important;
      padding: 8px 8px !important;
      border-bottom: 1px solid #e2e8f0 !important;
    }
    #salaryslip #slip-results-table td {
      padding: 6px 8px !important;
      font-size: 11px !important;
      border-bottom: 1px solid #f1f5f9 !important;
    }
    #salaryslip #slip-results-table th:first-child,
    #salaryslip #slip-results-table th:last-child { border-radius: 0 !important; }

    /* ── DOWNLOAD / PRINT FOOTER — clean bar ── */
    #salaryslip div[style*="text-align:center"][style*="border-radius:10px"] {
      background: #f8fafc !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 9px !important;
      padding: 12px !important;
      margin-top: 10px !important;
    }
    #salaryslip div[style*="text-align:center"] .btn-submit:first-child {
      background: #1e293b !important;
      padding: 8px 20px !important;
      font-size: 12px !important;
    }
    #salaryslip div[style*="text-align:center"] .btn-submit:last-child {
      background: #334155 !important;
      padding: 8px 20px !important;
      font-size: 12px !important;
    }

    /* ══════════════════════════════════════════════════
       SETTINGS TAB — MINIMALIST CLAUDE SAAS APPROACH
    ══════════════════════════════════════════════════ */

    /* ── Left nav — same dark-slate as Advance ── */
    #settings .left-panel {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: none;
      padding: 14px 10px;
      gap: 3px;
    }
    #settings .left-panel-title {
      font-size: 9.5px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #94a3b8;
      padding: 4px 10px 10px;
      border-bottom: 1px solid #f1f5f9;
      margin-bottom: 6px;
    }
    #settings .left-panel-btn {
      padding: 9px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      gap: 8px;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    #settings .left-panel-btn:hover {
      background: #f8fafc;
      color: #1e293b;
      border-color: #e2e8f0;
    }
    #settings .left-panel-btn.active {
      background: #1e293b;
      color: white;
      box-shadow: none;
      border-color: #1e293b;
    }

    /* ── Right panel cards ── */
    #settings .attendance-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      box-shadow: none;
      padding: 18px 20px;
      margin-bottom: 14px;
    }

    /* ── Section headings ── */
    #settings .attendance-card > h3 {
      font-size: 13px !important;
      font-weight: 700 !important;
      color: #1e293b !important;
      margin-bottom: 14px !important;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f1f5f9;
    }
    #settings .attendance-card > h3 span { font-size: 15px; }
    #settings .attendance-card > p {
      font-size: 11px !important;
      color: #94a3b8 !important;
      margin-bottom: 14px !important;
      line-height: 1.5;
    }

    /* ── Inputs / selects inside Settings ── */
    #settings select, #settings input[type="text"],
    #settings input[type="date"], #settings input[type="number"] {
      background: #fafafa;
      border: 1.5px solid #e2e8f0;
      border-radius: 7px;
      font-size: 12px;
      color: #374151;
      padding: 6px 9px;
      transition: border-color 0.15s;
    }
    #settings select:focus, #settings input:focus {
      border-color: #94a3b8;
      background: white;
      box-shadow: 0 0 0 3px rgba(148,163,184,0.12);
      outline: none;
    }
    #settings label {
      font-size: 10.5px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    /* ── All buttons inside Settings ── */
    #settings .btn-submit {
      background: #1e293b;
      border: 1px solid #1e293b;
      box-shadow: none;
      font-size: 11.5px;
    }
    #settings .btn-submit:hover {
      background: #0f172a;
      transform: none;
      box-shadow: 0 2px 8px rgba(15,23,42,0.15);
    }
    /* Add New — subtle teal-slate */
    #settings .btn-submit[onclick*="prepNew"],
    #settings .btn-submit[onclick*="addNew"],
    #settings .btn-submit[onclick*="Active"] {
      background: #0f766e;
      border-color: #0f766e;
    }
    #settings .btn-submit[onclick*="prepNew"]:hover,
    #settings .btn-submit[onclick*="addNew"]:hover,
    #settings .btn-submit[onclick*="Active"]:hover { background: #0d6360; }
    /* Past Employees / inactive  — slate */
    #settings .btn-submit[onclick*="inactive"] {
      background: #475569;
      border-color: #475569;
    }
    /* Refresh / reload — lighter slate */
    #settings .btn-submit[onclick*="load"],
    #settings .btn-submit[onclick*="Refresh"] {
      background: #334155;
      border-color: #334155;
    }
    /* Export PDF */
    #settings .btn-submit[onclick*="PDF"] {
      background: #334155;
      border-color: #334155;
    }
    /* Save — dark primary */
    #settings #emp-save-btn {
      background: #1e293b;
      border-color: #1e293b;
      padding: 10px !important;
    }
    /* Save all categories / projects */
    #settings .btn-submit[onclick*="saveCategories"],
    #settings .btn-submit[onclick*="saveProjects"],
    #settings .btn-submit[onclick*="saveEdited"] {
      background: #1e293b;
      border-color: #1e293b;
    }

    /* Add Row buttons (dashed ghost) */
    #settings .btn-add-row {
      background: white;
      color: #475569;
      border: 1.5px dashed #cbd5e1;
      font-weight: 600;
      font-size: 11px;
      border-radius: 7px;
      display: inline-flex;
      padding: 7px 16px;
    }
    #settings .btn-add-row:hover {
      background: #f8fafc;
      border-color: #94a3b8;
      color: #1e293b;
    }
    /* Delete row — soft red */
    #settings .btn-delete-row,
    #settings .btn-absent {
      background: white;
      color: #ef4444;
      border: 1.5px solid #fecaca;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 5px;
      font-weight: 700;
    }
    #settings .btn-delete-row:hover,
    #settings .btn-absent:hover {
      background: #fef2f2;
      border-color: #ef4444;
      transform: none;
    }

    /* ── Tables inside Settings ── */
    #settings table { margin-top: 0; border-collapse: collapse; }
    #settings thead { background: #f8fafc !important; }
    #settings th {
      background: #f8fafc !important;
      color: #64748b !important;
      font-size: 10.5px !important;
      font-weight: 700 !important;
      padding: 9px 10px !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e2e8f0 !important;
    }
    #settings th:first-child, #settings th:last-child { border-radius: 0 !important; }
    #settings td {
      padding: 7px 10px !important;
      font-size: 12px !important;
      border-bottom: 1px solid #f1f5f9 !important;
      color: #374151;
    }
    #settings tbody tr:last-child td { border-bottom: none !important; }
    #settings tbody tr:hover { background: #fafafa !important; }

    /* Wrap table in a border */
    #settings div[style*="overflow-x:auto"] {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      overflow-x: auto;
    }

    /* ── Holiday section header ── */
    #settings .holiday-section-header {
      padding-bottom: 10px;
      margin-bottom: 12px;
      border-bottom: 1px solid #f1f5f9;
    }
    #settings .holiday-section-header h4 {
      font-size: 11px !important;
      font-weight: 700 !important;
      color: #475569 !important;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* ── Employee form area ── */
    #settings #emp-form-area {
      border-top: 1px solid #f1f5f9;
      padding-top: 14px;
      margin-top: 4px;
    }

    /* ── Category / project list rows ── */
    #settings .cat-row input,
    #settings .proj-row input { background: #fafafa; }

    /* Column headers for project list */
    #settings div[style*="grid-template-columns:1fr 1fr auto"] > div {
      font-size: 10px !important;
      font-weight: 700 !important;
      color: #94a3b8 !important;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    /* ── Processing spinner ── */
    #settings .processing-spinner { color: #64748b; font-size: 12px; font-weight: 600; }
    #settings .spinner-small { border-top-color: #475569; }

    /* ══════════════ FULL SUMMARY – SPLIT SCREEN ══════════════ */
    #fullsummary {
      padding: 16px;
    }
    .fs-split {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      align-items: start;
    }
    .fs-left {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 18px 16px;
      position: sticky;
      top: 70px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .fs-left-section {
      padding: 14px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .fs-left-section:first-child { padding-top: 0; }
    .fs-left-section:last-child { border-bottom: none; padding-bottom: 0; }
    .fs-section-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    .fs-right {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* ══════════════ MINIMALIST REPORT STYLE ══════════════ */
    .report-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 18px 20px;
    }
    .report-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      margin-bottom: 14px;
      border-bottom: 1px solid #f1f5f9;
    }
    .report-card-title {
      font-size: 13px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.1px;
    }
    .report-card-title .title-icon {
      width: 28px; height: 28px;
      background: #f1f5f9;
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    /* Minimalist table override for report sections */
    .report-table thead { background: #f8fafc !important; }
    .report-table th {
      color: #64748b !important;
      background: #f8fafc !important;
      font-size: 10.5px !important;
      font-weight: 600 !important;
      padding: 9px 8px !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e2e8f0 !important;
    }
    .report-table th:first-child { border-radius: 8px 0 0 0 !important; }
    .report-table th:last-child { border-radius: 0 8px 0 0 !important; }
    .report-table td {
      color: #374151 !important;
      border-bottom: 1px solid #f1f5f9 !important;
      font-size: 11px;
    }
    .report-table tbody tr:hover { background: #fafafa !important; }

    /* Minimalist buttons for report sections */
    .btn-report {
      padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;
      cursor: pointer; font-weight: 600; font-size: 11px;
      background: white; color: #475569;
      transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px;
      white-space: nowrap;
    }
    .btn-report:hover { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
    .btn-report-primary {
      background: #1e293b; color: white; border-color: #1e293b;
    }
    .btn-report-primary:hover { background: #0f172a; border-color: #0f172a; }

    /* Minimalist form fields for left panel */
    .fs-left select, .fs-left input[type="date"] {
      padding: 6px 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      color: #374151;
      background: #fafafa;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.15s;
    }
    .fs-left select:focus, .fs-left input[type="date"]:focus {
      outline: none;
      border-color: #94a3b8;
      background: white;
    }
    .fs-left label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 4px;
    }
    .fs-field { margin-bottom: 8px; }
    .fs-field:last-of-type { margin-bottom: 0; }

    /* Minimalist stat pills for left panel */
    .fs-stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 2px;
    }
    .fs-stat-pill {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 10px;
      text-align: center;
    }
    .fs-stat-pill .pill-val {
      font-size: 17px;
      font-weight: 700;
      color: #1e293b;
      line-height: 1;
    }
    .fs-stat-pill .pill-lbl {
      font-size: 9.5px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 3px;
    }

    /* Toggle for monthly detail inside left panel */
    .fs-toggle-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 10px;
    }
    .fs-toggle-arrow { font-size: 9px; color: #94a3b8; transition: transform 0.2s; }
    .fs-toggle-arrow.open { transform: rotate(90deg); }

    @media(max-width:900px) {
      .fs-split { grid-template-columns: 1fr; }
      .fs-left { position: static; }
    }

    /* Time Analysis table specific styles */
    #time-analysis-table td:not(:first-child) {
      text-align: center;
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    #time-analysis-table .ta-ontime { color: #059669; background: #ecfdf5; }
    #time-analysis-table .ta-latein { color: #dc2626; background: #fef2f2; }
    #time-analysis-table .ta-earlyin { color: #2563eb; background: #eff6ff; }
    #time-analysis-table .ta-lateout { color: #ea580c; background: #fff7ed; }
    #time-analysis-table .ta-earlyout { color: #7c3aed; background: #f5f3ff; }
    #time-analysis-table .ta-total { color: #1e293b; font-weight: 700; }
    #time-analysis-table .ta-variance { color: #475569; font-style: italic; }

    /* ══════════════ HOLIDAY SETTINGS SPECIFIC ══════════════ */
    .holiday-section-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:16px; padding-bottom:12px;
      border-bottom:2px solid var(--gray-100);
    }

    /* ══════════════ RESPONSIVE ══════════════ */
    @media(max-width:768px) {
      .control-bar { flex-direction:column; gap:12px; }
      nav button { padding:12px 14px; font-size:11px; }
      nav button::before { display:none; }
      .split-screen { grid-template-columns:1fr; }
      .left-panel { position:static; flex-direction:row; flex-wrap:wrap; }
      #dashboard > div:first-child { grid-template-columns:1fr !important; }
    }
    #attendance .attendance-card table th:nth-child(2),
    #attendance .attendance-card table td:nth-child(2),
    #attendance .attendance-card table th:nth-child(3),
    #attendance .attendance-card table td:nth-child(3) { width:110px; text-align:center; }
    #attendance .attendance-card table th:nth-child(4),
    #attendance .attendance-card table td:nth-child(4) { width:70px; text-align:center; }
    #attendance .attendance-card table th:nth-child(5),
    #attendance .attendance-card table td:nth-child(5) { min-width:200px; }
  </style>
</head>
<body>

<!-- ══════════════════════ NAV ══════════════════════ -->
<nav>
  <button onclick="switchTab('attendance')" id="tab-btn-attendance" class="active">
    <span class="tab-icon">✅</span> <span class="tab-label">ATTENDANCE</span>
  </button>
  <button onclick="switchTab('dashboard')" id="tab-btn-dashboard">
    <span class="tab-icon">📋</span> <span class="tab-label">CORRECTION</span>
  </button>
  <button onclick="switchTab('fullsummary')" id="tab-btn-fullsummary">
    <span class="tab-icon">📈</span> <span class="tab-label">FULL SUMMARY</span>
  </button>
  <button onclick="switchTab('advance')" id="tab-btn-advance">
    <span class="tab-icon">💳</span> <span class="tab-label">ADVANCE</span>
  </button>
  <button onclick="switchTab('salaryslip')" id="tab-btn-salaryslip">
    <span class="tab-icon">💰</span> <span class="tab-label">SALARY SLIP</span>
  </button>
  <button onclick="switchTab('settings')" id="tab-btn-settings">
    <span class="tab-icon">⚙️</span> <span class="tab-label">SETTINGS</span>
  </button>
</nav>

<!-- ══════════════════════ TAB 1: ATTENDANCE ══════════════════════ -->
<div id="attendance" class="tab-content active">
  
  <!-- Top Control Bar -->
  <div class="control-bar">
    <h2>
      <span>📋</span>
      Daily Attendance Entry
    </h2>
    <div class="control-bar-left">
      <div class="date-nav">
        <button onclick="changeDate(-1)">←</button>
        <input type="date" id="att-date-picker">
        <button onclick="changeDate(1)">→</button>
      </div>
      <button class="btn btn-submit" onclick="generateActiveList()">
        <span>⚡</span> Generate All Active
      </button>
    </div>
  </div>

  <!-- Main Table Card -->
  <div class="attendance-card">
    <table>
      <thead>
        <tr>
          <th>👤 Employee Name</th>
          <th>🕐 In Time</th>
          <th>🕐 Out Time</th>
          <th style="text-align:center">⏱️ OT</th>
          <th>📍 Site Name</th>
          <th>⚙️ Action</th>
          <th style="width:50px;text-align:center">❌</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
    
    <!-- Bottom Action Bar -->
    <div class="action-buttons">
      <button class="btn btn-add-row" onclick="addAttRow()">
        <span>+</span> Add a row
      </button>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn btn-clear" onclick="initAttendanceTable()">
          <span>🔄</span> Clear Table
        </button>
        <button class="btn btn-submit" onclick="submitAttendance()">
          <span>💾</span> Submit Attendance
        </button>
        <div id="processing-indicator">
          <div class="spinner-small"></div> Processing...
        </div>
      </div>
    </div>
  </div>

  <!-- Time Reference Card -->
  <div style="display:flex;justify-content:flex-end;margin-top:14px;">
    <div class="time-reference-card">
      <div class="reference-title">
        <span>🕐</span> 24hr → PM Reference
      </div>
      <table>
        <tr>
          <td>24hr</td>
          <td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td>
          <td>19</td><td>20</td><td>21</td><td>22</td><td>23</td>
        </tr>
        <tr>
          <td>PM</td>
          <td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td>
          <td>7</td><td>8</td><td>9</td><td>10</td><td>11</td>
        </tr>
      </table>
    </div>
  </div>

</div>

<!-- ══════════════════════ TAB 2: DASHBOARD ══════════════════════ -->
<div id="dashboard" class="tab-content">
  <div style="display:grid;grid-template-columns:300px 1fr;gap:16px;">
    <div class="attendance-card" style="display:flex;flex-direction:column;gap:20px;">
      <div>
        <h4 style="color:var(--primary);margin-bottom:12px;font-size:14px;display:flex;align-items:center;gap:8px;"><span>📅</span> Date Filter</h4>
        <div class="date-nav" style="margin-bottom:10px;">
          <button onclick="changeDashDate(-1)">←</button>
          <input type="date" id="dash-date-filter" style="flex:1;background:white;color:var(--primary);font-weight:600;">
          <button onclick="changeDashDate(1)">→</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-submit" onclick="filterByDate()" style="flex:1;"><span>🔍</span> View Day</button>
          <button class="btn btn-submit" onclick="filterByDate()" style="background:var(--gradient-success);padding:6px 12px;"><span>🔄</span></button>
        </div>
      </div>
    </div>
    <div class="attendance-card" style="overflow:hidden;display:flex;flex-direction:column;">
      <h3 style="color:var(--primary);margin-bottom:12px;font-size:16px;display:flex;align-items:center;gap:8px;"><span>📊</span> Results</h3>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:12px;">
        <button class="btn btn-submit" onclick="exportToPDF()" style="padding:6px 12px;font-size:11px;"><span>📥</span> PDF</button>
        <button class="btn btn-submit" onclick="printTable()" style="background:var(--gradient-secondary);padding:6px 12px;font-size:11px;"><span>🖨️</span> Print</button>
      </div>
      <div style="overflow-y:auto;max-height:400px;">
        <table id="dash-results-table" class="report-table" style="width:100%;">
          <thead style="position:sticky;top:0;z-index:10;">
            <tr><th>Date</th><th>Name</th><th>In</th><th>Out</th><th>OT</th><th>Site</th><th>Status</th></tr>
          </thead>
          <tbody id="dash-results-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:300px 1fr;gap:16px;margin-top:20px;">
    <div></div>
    <div class="attendance-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="color:var(--primary);font-size:16px;display:flex;align-items:center;gap:8px;margin:0;"><span>✏️</span> Edit Attendance Record</h3>
        <div class="mode-selector">
          <button id="mode-single-emp" class="active" onclick="switchEditMode('single-emp')">Single Employee</button>
          <button id="mode-multi-emp" onclick="switchEditMode('multi-emp')">Multiple Employees</button>
        </div>
      </div>
      <div id="edit-single-emp-mode">
        <div style="display:flex;gap:12px;align-items:end;margin-bottom:20px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;"><label>Employee</label><select id="edit-emp-select-single" style="width:100%;"></select></div>
          <div style="flex:1;min-width:150px;"><label>From Date</label><input type="date" id="edit-date-from" style="width:100%;"></div>
          <div style="flex:1;min-width:150px;"><label>To Date</label><input type="date" id="edit-date-to" style="width:100%;"></div>
          <button class="btn btn-submit" onclick="showEditableRecordsSingle()"><span>🔍</span> Show Details</button>
        </div>
      </div>
      <div id="edit-multi-emp-mode" style="display:none;">
        <div style="display:flex;gap:12px;align-items:end;margin-bottom:20px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;"><label>Date</label><input type="date" id="edit-date-multi" style="width:100%;"></div>
          <button class="btn btn-submit" onclick="showEditableRecordsMulti()"><span>➕</span> Start Adding</button>
        </div>
      </div>
      <div id="edit-record-container" style="display:none;">
        <div style="overflow-x:auto;">
          <table id="edit-record-table">
            <thead>
              <tr><th>Date</th><th>Employee Name</th><th>In Time</th><th>Out Time</th><th>OT</th><th>Site Name</th><th>Status</th><th style="width:50px;text-align:center">❌</th></tr>
            </thead>
            <tbody id="edit-record-body"></tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;">
          <button class="btn btn-add-row" onclick="addEditRow()" id="add-edit-row-btn" style="display:none;"><span>+</span> Add Row</button>
          <div style="display:flex;gap:10px;align-items:center;margin-left:auto;">
            <button class="btn btn-submit" onclick="resubmitAllAttendance()"><span>💾</span> Re-submit All Data</button>
            <div class="processing-spinner" id="edit-processing-indicator"><div class="spinner-small"></div> Processing...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════ TAB 3: FULL SUMMARY ══════════════════════ -->
<div id="fullsummary" class="tab-content">
  <div style="max-width:1500px;margin:auto;padding:10px 16px;">
  <div class="fs-split">

    <!-- ── LEFT PANEL (NAV TABS) ── -->
    <div class="fs-left">
      <div class="fs-section-label" style="margin-bottom:10px;">📈 Full Summary</div>

      <!-- Tab 1 nav button -->
      <button class="fs-nav-btn active" id="fs-nav-pivot" onclick="switchFsSection('pivot')">
        <span class="fs-nav-icon">📊</span>
        <div>
          <div class="fs-nav-title">Monthly Pivot</div>
          <div class="fs-nav-sub">All employees view</div>
        </div>
      </button>

      <!-- Tab 2 nav button -->
      <button class="fs-nav-btn" id="fs-nav-detail" onclick="switchFsSection('detail')">
        <span class="fs-nav-icon">📋</span>
        <div>
          <div class="fs-nav-title">Monthly Detail</div>
          <div class="fs-nav-sub">Per-employee breakdown</div>
        </div>
      </button>
      <!-- Tab 3 nav button -->
      <button class="fs-nav-btn" id="fs-nav-timeanalysis" onclick="switchFsSection('timeanalysis')">
        <span class="fs-nav-icon">⏱️</span>
        <div>
          <div class="fs-nav-title">Time Analysis</div>
          <div class="fs-nav-sub">Attendance patterns</div>
        </div>
      </button>

      <!-- Divider -->
      <div style="border-top:1px solid #f1f5f9;margin:10px 0;"></div>

      <!-- Controls for Pivot section (shown when pivot active) -->
      <div id="fs-ctrl-pivot">
        <div class="fs-section-label" style="margin-bottom:8px;">FILTER</div>
        <div class="fs-field"><label>Month</label>
          <select id="full-month-select">
            <option value="01">January</option><option value="02">February</option><option value="03">March</option>
            <option value="04">April</option><option value="05">May</option><option value="06">June</option>
            <option value="07">July</option><option value="08">August</option><option value="09">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="fs-field"><label>Year</label>
          <select id="full-year-select">
            <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
          </select>
        </div>
        <div style="display:flex;gap:6px;margin-top:10px;">
          <button class="btn-report btn-report-primary" onclick="showFullSummary()" style="flex:1;justify-content:center;"><span>📊</span> Show</button>
          <button class="btn-report" onclick="exportFullSummaryPDF()" title="Export PDF"><span>📥</span></button>
        </div>
      </div>

      <!-- Controls for Detail section (shown when detail active) -->
      <div id="fs-ctrl-detail" style="display:none;">
        <div class="fs-section-label" style="margin-bottom:8px;">FILTER</div>
        <div class="fs-field"><label>Employee</label><select id="monthly-emp-select"></select></div>
        <div class="fs-field"><label>Month</label>
          <select id="monthly-month-select">
            <option value="01">January</option><option value="02">February</option><option value="03">March</option>
            <option value="04">April</option><option value="05">May</option><option value="06">June</option>
            <option value="07">July</option><option value="08">August</option><option value="09">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="fs-field"><label>Year</label>
          <select id="monthly-year-select">
            <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
          </select>
        </div>
        <button class="btn-report btn-report-primary" onclick="showMonthlyDetail()" style="width:100%;justify-content:center;margin-top:10px;"><span>🔍</span> View Month</button>
        <div style="display:flex;gap:6px;margin-top:6px;">
          <button class="btn-report" onclick="exportMonthlyPDF()" style="flex:1;justify-content:center;"><span>📥</span> PDF</button>
          <button class="btn-report" onclick="printMonthlyTable()" style="flex:1;justify-content:center;"><span>🖨️</span> Print</button>
        </div>
      </div>
      <!-- Controls for Time Analysis section -->
      <div id="fs-ctrl-timeanalysis" style="display:none;">
        <div class="fs-section-label" style="margin-bottom:8px;">FILTER</div>
        <div class="fs-field">
          <label>Employee</label>
          <select id="time-analysis-emp-select">
            <option value="ALL">🌐 All Employees</option>
          </select>
        </div>
        <div class="fs-field"><label>Month</label>
          <select id="time-analysis-month-select">
            <option value="01">January</option><option value="02">February</option><option value="03">March</option>
            <option value="04">April</option><option value="05">May</option><option value="06">June</option>
            <option value="07">July</option><option value="08">August</option><option value="09">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="fs-field"><label>Year</label>
          <select id="time-analysis-year-select">
            <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
          </select>
        </div>
        <button class="btn-report btn-report-primary" onclick="analyzeTime()" style="width:100%;justify-content:center;margin-top:10px;">
          <span>⏱️</span> Analyze
        </button>
        <div class="processing-spinner" id="time-analysis-spinner" style="display:none;margin-top:8px;font-size:11px;">
          <div class="spinner-small"></div> Analyzing...
        </div>
      </div>

      <!-- Monthly Dashboard Stats pill grid (populated by JS) -->
      <div id="fs-dashboard-section" style="display:none;margin-top:12px;border-top:1px solid #f1f5f9;padding-top:12px;">
        <div class="fs-section-label" style="margin-bottom:8px;">THIS MONTH</div>
        <div class="fs-stat-grid" id="fs-stat-grid"></div>
      </div>

    </div><!-- /fs-left -->

    <!-- ── RIGHT PANEL ── -->
    <div class="fs-right">

      <!-- Section A: Full Summary Pivot Table -->
      <div class="report-card fs-sec-panel" id="fs-sec-pivot">
        <div class="report-card-header">
          <div class="report-card-title">
            <div class="title-icon">📊</div>
            Monthly Pivot — All Employees
          </div>
          <div id="fs-period-label" style="font-size:11px;color:#94a3b8;font-weight:600;"></div>
        </div>
        <div style="overflow-x:auto;">
          <table id="full-summary-table" class="pivot-table report-table">
            <thead id="full-summary-head"></thead>
            <tbody id="full-summary-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Section B: Monthly Detail Table -->
      <div class="report-card fs-sec-panel" id="fs-sec-detail" style="display:none;">
        <div class="report-card-header">
          <div class="report-card-title">
            <div class="title-icon">📋</div>
            Monthly Detail View
          </div>
          <div id="monthly-detail-header-info" style="font-size:11px;color:#94a3b8;font-weight:600;"></div>
        </div>
        <div style="overflow-y:auto;max-height:calc(100vh - 160px);">
          <table id="monthly-results-table" class="report-table" style="width:100%;">
            <thead style="position:sticky;top:0;z-index:10;background:#f8fafc;">
              <tr><th>Date</th><th>Name</th><th>In</th><th>Out</th><th>OT</th><th>Site</th><th>Status</th></tr>
            </thead>
            <tbody id="monthly-results-body"></tbody>
          </table>
        </div>
      </div>
      <!-- Section C: Time Analysis -->
      <div class="report-card fs-sec-panel" id="fs-sec-timeanalysis" style="display:none;">
        <div class="report-card-header">
          <div class="report-card-title">
            <div class="title-icon">⏱️</div>
            Time Analysis Report
          </div>
          <div id="time-analysis-header-info" style="font-size:11px;color:#94a3b8;font-weight:600;"></div>
        </div>
        <div style="overflow-x:auto;">
          <table id="time-analysis-table" class="report-table" style="width:100%;">
            <thead style="background:#f8fafc;">
              <tr>
                <th style="text-align:left;">Employee Name</th>
                <th style="text-align:center;">On Time</th>
                <th style="text-align:center;">Late In</th>
                <th style="text-align:center;">Early In</th>
                <th style="text-align:center;">Late Out</th>
                <th style="text-align:center;">Early Out</th>
                <th style="text-align:center;">Total Days</th>
                <th style="text-align:center;">Avg. Variance</th>
              </tr>
            </thead>
            <tbody id="time-analysis-body"></tbody>
          </table>
        </div>
      </div>

    </div><!-- /fs-right -->

  </div><!-- /fs-split -->
  </div><!-- /max-width container -->
</div>

<!-- ══════════════════════ TAB 4: ADVANCE ══════════════════════ -->
<div id="advance" class="tab-content">
  <div class="split-screen">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="left-panel-title">💳 Advance Module</div>
      <button class="left-panel-btn active" id="adv-btn-add-expense" onclick="switchAdvSection('add-expense')">
        <span>🧾</span> Add Expense
      </button>
      <button class="left-panel-btn" id="adv-btn-add-advance" onclick="switchAdvSection('add-advance')">
        <span>💵</span> Add Advance
      </button>
      <button class="left-panel-btn" id="adv-btn-escalation" onclick="switchAdvSection('escalation')">
        <span>🔍</span> Escalation
      </button>
      <button class="left-panel-btn" id="adv-btn-adv-summary" onclick="switchAdvSection('adv-summary')">
        <span>📊</span> Summary
      </button>
      <button class="left-panel-btn" id="adv-btn-adv-reports" onclick="switchAdvSection('adv-reports')">
        <span>📑</span> Reports
      </button>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">

      <!-- ── ADD EXPENSE ── -->
      <div id="adv-sec-add-expense" class="right-section active">
        <div class="attendance-card">
          <div class="section-header">
            <div class="section-title"><span>🧾</span> Add Expense</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn btn-add-row" onclick="addExpenseRow()" style="margin:0;padding:6px 12px;"><span>+</span> Add Row</button>
              <button class="btn btn-submit" onclick="submitExpenses()"><span>💾</span> Submit All</button>
              <div class="processing-spinner" id="exp-spinner"><div class="spinner-small"></div> Saving...</div>
            </div>
          </div>
          <div class="adv-table-wrap">
            <table id="expense-table">
              <thead>
                <tr>
                  <th style="min-width:120px;">📅 Date</th>
                  <th style="min-width:140px;">👤 Employee</th>
                  <th style="min-width:140px;">🏷️ Category</th>
                  <th style="min-width:100px;">💰 Amount</th>
                  <th style="min-width:160px;">📝 Remarks</th>
                  <th style="min-width:130px;">🏗️ Project</th>
                  <th style="min-width:110px;">✅ Approved By</th>
                  <th style="width:50px;text-align:center">❌</th>
                </tr>
              </thead>
              <tbody id="expense-body"></tbody>
            </table>
          </div>
          <div id="expense-ref-result" style="margin-top:14px;display:none;"></div>
        </div>
      </div>

      <!-- ── ADD ADVANCE ── -->
      <div id="adv-sec-add-advance" class="right-section">
        <div class="attendance-card">
          <div class="section-header">
            <div class="section-title"><span>💵</span> Add Advance Received</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn btn-add-row" onclick="addAdvanceRow()" style="margin:0;padding:6px 12px;"><span>+</span> Add Row</button>
              <button class="btn btn-submit" onclick="submitAdvances()"><span>💾</span> Submit All</button>
              <div class="processing-spinner" id="adv-spinner"><div class="spinner-small"></div> Saving...</div>
            </div>
          </div>
          <div class="adv-table-wrap">
            <table id="advance-recv-table">
              <thead>
                <tr>
                  <th style="min-width:120px;">📅 Date</th>
                  <th style="min-width:150px;">👤 Employee</th>
                  <th style="min-width:110px;">💰 Amount</th>
                  <th style="min-width:160px;">📝 Remarks</th>
                  <th style="min-width:120px;">✅ Approved By</th>
                  <th style="width:50px;text-align:center">❌</th>
                </tr>
              </thead>
              <tbody id="advance-recv-body"></tbody>
            </table>
          </div>
          <div id="advance-ref-result" style="margin-top:14px;display:none;"></div>
        </div>
      </div>

      <!-- ── ESCALATION ── -->
      <div id="adv-sec-escalation" class="right-section">
        <div class="attendance-card">
          <div class="section-title" style="margin-bottom:16px;"><span>🔍</span> Escalation – View & Edit Records</div>
          <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:18px;">
            <div style="flex:1;min-width:120px;"><label>Type</label>
              <select id="esc-type">
                <option value="expense">Expenses</option>
                <option value="advance">Advances</option>
              </select>
            </div>
            <div style="flex:1;min-width:150px;"><label>Employee</label><select id="esc-emp" style="width:100%;"></select></div>
            <div style="flex:1;min-width:130px;"><label>From Date</label><input type="date" id="esc-date-from" style="width:100%;"></div>
            <div style="flex:1;min-width:130px;"><label>To Date</label><input type="date" id="esc-date-to" style="width:100%;"></div>
            <button class="btn btn-submit" onclick="loadEscalationRecords()"><span>🔍</span> Load Records</button>
          </div>
          <div id="esc-result-wrap" style="display:none;">
            <div class="adv-table-wrap">
              <table id="esc-table">
                <thead><tr id="esc-table-head"></tr></thead>
                <tbody id="esc-table-body"></tbody>
              </table>
            </div>
            <div style="margin-top:14px;display:flex;justify-content:flex-end;gap:10px;align-items:center;">
              <button class="btn btn-submit" onclick="saveEscalationChanges()"><span>💾</span> Save All Changes</button>
              <div class="processing-spinner" id="esc-spinner"><div class="spinner-small"></div> Saving...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── SUMMARY ── -->
      <div id="adv-sec-adv-summary" class="right-section">
        <div class="attendance-card">
          <div class="section-title" style="margin-bottom:16px;"><span>📊</span> Advance & Expense Summary</div>
          <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:18px;">
            <div style="flex:1;min-width:150px;"><label>Month</label>
              <select id="sum-month" style="width:100%;">
                <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                <option value="10">October</option><option value="11">November</option><option value="12">December</option>
              </select>
            </div>
            <div style="flex:1;min-width:120px;"><label>Year</label>
              <select id="sum-year" style="width:100%;">
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
              </select>
            </div>
            <div style="flex:1;min-width:180px;"><label>Employee</label><select id="sum-emp" style="width:100%;"><option value="">All Employees</option></select></div>
            <button class="btn btn-submit" onclick="loadSummary()"><span>📊</span> Show</button>
            <button class="btn btn-submit" onclick="exportSummaryPDF()" style="background:var(--gradient-secondary);"><span>📥</span> Export PDF</button>
          </div>
          <div id="summary-result" style="display:none;">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
              <div class="summary-stat" style="background:#ecfdf5;border:1px solid #a7f3d0;">
                <div class="stat-value" id="sum-total-adv" style="color:#059669;">₹0</div>
                <div class="stat-label">Total Advance</div>
              </div>
              <div class="summary-stat" style="background:#fee2e2;border:1px solid #fca5a5;">
                <div class="stat-value" id="sum-total-exp" style="color:#ef4444;">₹0</div>
                <div class="stat-label">Total Expenses</div>
              </div>
              <div class="summary-stat" style="background:#eff6ff;border:1px solid #93c5fd;" id="sum-balance-card">
                <div class="stat-value" id="sum-balance" style="color:#2563eb;">₹0</div>
                <div class="stat-label" id="sum-balance-label">Balance</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div>
                <h4 style="color:var(--primary);margin-bottom:10px;font-size:13px;">💵 Advances</h4>
                <div class="adv-table-wrap"><table id="sum-adv-table">
                  <thead><tr><th>Date</th><th>Amount</th><th>Remarks</th><th>Ref</th></tr></thead>
                  <tbody id="sum-adv-body"></tbody>
                </table></div>
              </div>
              <div>
                <h4 style="color:var(--danger);margin-bottom:10px;font-size:13px;">🧾 Expenses</h4>
                <div class="adv-table-wrap"><table id="sum-exp-table">
                  <thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Ref</th></tr></thead>
                  <tbody id="sum-exp-body"></tbody>
                </table></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── REPORTS ── -->
      <div id="adv-sec-adv-reports" class="right-section">
        <div class="attendance-card">
          <div class="section-title" style="margin-bottom:16px;"><span>📑</span> Monthly Reports</div>
          <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:18px;">
            <div style="flex:1;min-width:150px;"><label>Month</label>
              <select id="rep-month" style="width:100%;">
                <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                <option value="10">October</option><option value="11">November</option><option value="12">December</option>
              </select>
            </div>
            <div style="flex:1;min-width:120px;"><label>Year</label>
              <select id="rep-year" style="width:100%;">
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
              </select>
            </div>
            <button class="btn btn-submit" onclick="loadReport()"><span>📊</span> Generate Report</button>
            <button class="btn btn-submit" onclick="exportReportPDF()" style="background:var(--gradient-secondary);"><span>📥</span> Export PDF</button>
          </div>
          <div id="report-result" style="display:none;">
            <h4 style="color:var(--primary);margin-bottom:10px;font-size:13px;">🏷️ Category-wise Expense Totals</h4>
            <div class="adv-table-wrap" style="margin-bottom:20px;">
              <table id="rep-category-table">
                <thead><tr><th>Category</th><th>Total Amount (₹)</th></tr></thead>
                <tbody id="rep-category-body"></tbody>
              </table>
            </div>
            <h4 style="color:var(--primary);margin-bottom:10px;font-size:13px;">👥 Employee-wise Summary</h4>
            <div class="adv-table-wrap">
              <table id="rep-emp-table">
                <thead>
                  <tr>
                    <th>Employee</th>
                    <th>Advance Received (₹)</th>
                    <th>Total Expense (₹)</th>
                    <th>Balance (₹)</th>
                    <th>Effect on Salary</th>
                  </tr>
                </thead>
                <tbody id="rep-emp-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div><!-- end right-panel -->
  </div><!-- end split-screen -->
</div>

<!-- ══════════════════════ TAB 5: SALARY SLIP ══════════════════════ -->
<div id="salaryslip" class="tab-content">
  <div class="split-screen">

    <!-- ── LEFT NAV ── -->
    <div class="left-panel">
      <div class="left-panel-title">💰 Salary Module</div>

      <button class="left-panel-btn active" id="ss-btn-slip" onclick="switchSsSection('slip')">
        <span class="lp-icon">📄</span>
        <div class="lp-text">
          <div class="lp-title">Salary Slip Generator</div>
          <div class="lp-sub">Individual slip</div>
        </div>
      </button>

      <button class="left-panel-btn" id="ss-btn-allsal" onclick="switchSsSection('allsal')">
        <span class="lp-icon">👥</span>
        <div class="lp-text">
          <div class="lp-title">All Employee Report</div>
          <div class="lp-sub">Consolidated payroll</div>
        </div>
      </button>
    </div>

    <!-- ── RIGHT CONTENT ── -->
    <div class="right-panel">

      <!-- ── SECTION: Individual Salary Slip ── -->
      <div id="ss-sec-slip" class="right-section active">
        <div class="ss-slip-card">
          <!-- Controls -->
          <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid #f1f5f9;">
            <div><label>Employee</label><select id="salary-emp-select" style="width:100%;"></select></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div><label>Month</label>
                <select id="salary-month-select" style="width:100%;">
                  <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                  <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                  <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                  <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
              </div>
              <div><label>Year</label>
                <select id="salary-year-select" style="width:100%;">
                  <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
                </select>
              </div>
            </div>
            <button class="btn btn-submit ss-btn-primary" onclick="generateSalarySlip()" style="width:100%;justify-content:center;"><span>📄</span> Generate Slip</button>
          </div>

          <!-- Slip output -->
          <div id="slip-content" style="display:none;">
            <!-- ① EMPLOYEE HEADER -->
            <div id="slip-header" style="background:#f8fafc;padding:10px 12px;border-radius:8px;margin-bottom:8px;border-left:3px solid #334155;border:1px solid #e2e8f0;border-left:3px solid #334155;"></div>
            <!-- ② STATS -->
            <div id="slip-totals" style="margin-bottom:8px;"></div>
            <!-- ③ SALARY BREAKDOWN -->
            <div class="salary-breakdown" style="margin-top:0;margin-bottom:8px;">
              <h3 style="color:var(--primary);margin-bottom:8px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;font-size:12px;"><span>💵</span> Salary Calculation</h3>
              <div id="salary-breakdown-content"></div>
            </div>
            <!-- ④ ADVANCE -->
            <div class="advance-section" style="margin-bottom:8px;">
              <h4 style="margin-bottom:6px;color:var(--gray-700);display:flex;align-items:center;gap:6px;font-size:11px;"><span>💳</span> Advance / Expense Adjustment</h4>
              <div id="advance-expense-info" style="background:white;padding:10px;border-radius:7px;border:1px solid var(--gray-200);margin-bottom:10px;display:none;"></div>
              <div style="display:flex;gap:8px;align-items:end;">
                <div style="flex:1;"><label style="font-size:10px;">Override Advance (₹) — 0 = auto</label><input type="number" id="advance-amount" placeholder="0" min="0" step="0.01" value="0"></div>
                <button class="btn btn-submit ss-btn-primary" onclick="addAdvanceAmount()"><span>💾</span> Save</button>
              </div>
              <div id="advance-display" style="display:none;margin-top:8px;"></div>
            </div>
            <!-- ⑤ ATTENDANCE DETAIL -->
            <div class="attendance-card" style="margin-bottom:8px;border:1px solid var(--gray-200);padding:10px 12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="toggleAttendanceDetail()">
                <h4 style="margin:0;color:var(--primary);display:flex;align-items:center;gap:6px;font-size:11px;"><span id="att-detail-arrow">▶</span> Attendance Detail</h4>
                <button class="btn btn-clear" style="padding:4px 10px;font-size:10px;" id="att-detail-toggle-btn">Show</button>
              </div>
              <div id="att-detail-section" style="display:none;margin-top:8px;overflow-x:auto;">
                <table id="slip-results-table" style="margin-top:0;">
                  <thead><tr><th>Date</th><th>In Time</th><th>Out Time</th><th>OT</th><th>Site</th><th>Status</th></tr></thead>
                  <tbody id="slip-results-body"></tbody>
                </table>
              </div>
            </div>
            <!-- ⑥ ACTIONS -->
            <div style="display:flex;gap:8px;">
              <button class="btn btn-submit ss-btn-primary" onclick="exportSalaryPDF()" style="flex:1;justify-content:center;"><span>📥</span> Download PDF</button>
              <button class="btn btn-submit" onclick="printSlip()" style="background:var(--gradient-secondary);flex:1;justify-content:center;"><span>🖨️</span> Print</button>
            </div>
          </div>
        </div>
      </div><!-- /ss-sec-slip -->

      <!-- ── SECTION: All Employee Salary Report ── -->
      <div id="ss-sec-allsal" class="right-section">
        <div class="ss-report-card">
          <!-- Dark header bar with filters -->
          <div class="ss-report-header">
            <div class="ss-report-header-left">
              <div class="ss-report-icon">👥</div>
              <div>
                <div class="ss-report-title">All Employee Salary Report</div>
                <div class="ss-report-sub">Consolidated monthly payroll</div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <select id="all-sal-month" class="ss-filter-select">
                <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                <option value="10">October</option><option value="11">November</option><option value="12">December</option>
              </select>
              <select id="all-sal-year" class="ss-filter-select">
                <option value="2024">2024</option><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
              </select>
              <button class="ss-btn-go" onclick="generateAllSalary()"><span>📊</span> Generate</button>
              <button class="ss-btn-export" onclick="exportAllSalaryPDF()"><span>📥</span> PDF</button>
            </div>
          </div>

          <!-- Period label -->
          <div id="all-sal-period" style="display:none;padding:8px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.8px;"></div>

          <!-- Table -->
          <div style="overflow-x:auto;">
            <table id="all-sal-table" class="ss-report-table" style="display:none;">
              <thead></thead>
              <tbody id="all-sal-body"></tbody>
              <tfoot id="all-sal-foot"></tfoot>
            </table>
          </div>

          <!-- Empty state -->
          <div id="all-sal-empty" style="text-align:center;padding:60px 20px;color:#94a3b8;">
            <div style="font-size:40px;margin-bottom:12px;">📋</div>
            <div style="font-size:14px;font-weight:600;color:#64748b;margin-bottom:4px;">No report generated yet</div>
            <div style="font-size:12px;">Select a month and year, then click Generate</div>
          </div>
        </div>
      </div><!-- /ss-sec-allsal -->

    </div><!-- /right-panel -->
  </div><!-- /split-screen -->
</div>

<!-- ══════════════════════ TAB 6: SETTINGS ══════════════════════ -->
<div id="settings" class="tab-content">
  <div class="split-screen">
    <!-- Left Panel -->
    <div class="left-panel">
      <div class="left-panel-title">⚙️ Settings</div>
      <button class="left-panel-btn active" id="set-btn-employee-settings" onclick="switchSetSection('employee-settings')">
        <span>👤</span> Employee Settings
      </button>
      <!-- CHANGED: "Holiday Settings" renamed to "Holidays" as per request #2 -->
      <button class="left-panel-btn" id="set-btn-holiday-settings" onclick="switchSetSection('holiday-settings')">
        <span>🎉</span> Holidays
      </button>
      <button class="left-panel-btn" id="set-btn-advance-category" onclick="switchSetSection('advance-category')">
        <span>🏷️</span> Advance Category
      </button>
      <button class="left-panel-btn" id="set-btn-add-project" onclick="switchSetSection('add-project')">
        <span>🏗️</span> Add Project
      </button>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">

      <!-- ── EMPLOYEE SETTINGS (moved into Settings split screen as requested #3) ── -->
      <div id="set-sec-employee-settings" class="right-section active">
        <div class="attendance-card" style="margin-bottom:16px;">
          <h3 style="color:var(--primary);margin-bottom:18px;font-size:18px;display:flex;align-items:center;gap:10px;"><span>👥</span> Employee Management</h3>
          <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
            <select id="emp-lookup-select" style="flex:1;min-width:200px;"></select>
            <button class="btn btn-submit" onclick="showEmployeeData()"><span>📂</span> Load</button>
            <button class="btn btn-submit" onclick="prepNewEmployee()" style="background:var(--gradient-success);"><span>➕</span> Add New</button>
          </div>
          <div id="emp-form-area" style="display:none;">
            <div id="emp-fields-container"></div>
            <button class="btn btn-submit" id="emp-save-btn" style="width:100%;margin-top:20px;padding:12px;"><span>💾</span> Save Employee Record</button>
          </div>
        </div>
        <div class="attendance-card">
          <h3 style="color:var(--primary);margin-bottom:18px;font-size:18px;display:flex;align-items:center;gap:10px;"><span>📋</span> Employee List</h3>
          <div style="display:flex;gap:12px;margin-bottom:18px;align-items:center;">
            <button class="btn btn-submit" onclick="showEmployeeList('active')"><span>✅</span> Active Employees</button>
            <button class="btn btn-submit" onclick="showEmployeeList('inactive')" style="background:var(--gradient-secondary);"><span>📁</span> Past Employees</button>
            <div class="processing-spinner" id="emp-list-processing"><div class="spinner-small"></div> Loading...</div>
          </div>
          <div id="employee-list-container" style="display:none;">
            <div style="overflow-x:auto;">
              <table id="employee-list-table">
                <thead><tr><th>Name</th><th>Code</th><th>Status</th><th>DOJ</th><th>Designation</th><th>Basic Salary</th><th>OT Hours</th></tr></thead>
                <tbody id="employee-list-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ── HOLIDAY SETTINGS (renamed "Holidays" in left panel, "Add Single Holiday" section REMOVED per request #5) ── -->
      <div id="set-sec-holiday-settings" class="right-section">
        <div class="attendance-card">
          <h3 style="color:var(--primary);margin-bottom:4px;font-size:18px;display:flex;align-items:center;gap:10px;"><span>🎉</span> Holiday Management</h3>
          <p style="font-size:12px;color:var(--gray-600);margin-bottom:18px;">Add, edit, or delete public and company holidays. All changes are saved to the Settings sheet.</p>

          <!-- ═══ EXISTING HOLIDAYS TABLE (the only section – Add Single Holiday section removed) ═══ -->
          <div>
            <div class="holiday-section-header">
              <h4 style="color:var(--gray-700);font-size:14px;display:flex;align-items:center;gap:8px;margin:0;">
                <span>📋</span> Holiday List
              </h4>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-submit" onclick="addNewHolidayRow()" style="padding:6px 12px;background:var(--gradient-success);"><span>➕</span> Add Holiday</button>
                <button class="btn btn-submit" onclick="exportHolidaysPDF()" style="padding:6px 12px;"><span>📥</span> Export PDF</button>
                <button class="btn btn-submit" onclick="loadHolidays()" style="padding:6px 12px;background:var(--gradient-settings);"><span>🔄</span> Refresh</button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table id="holidays-table">
                <thead>
                  <tr>
                    <th>📅 Date</th>
                    <th>📝 Reason / Name</th>
                    <th>✅ Approved By</th>
                    <th style="width:100px;text-align:center;">Action</th>
                  </tr>
                </thead>
                <tbody id="holidays-body"></tbody>
              </table>
            </div>
            <div style="text-align:right;margin-top:14px;">
              <button class="btn btn-submit" onclick="saveEditedHolidays()"><span>💾</span> Save All Changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ── ADVANCE CATEGORY ── -->
      <div id="set-sec-advance-category" class="right-section">
        <div class="attendance-card">
          <h3 style="color:var(--primary);margin-bottom:18px;font-size:18px;display:flex;align-items:center;gap:10px;"><span>🏷️</span> Advance / Expense Categories</h3>
          <p style="font-size:12px;color:var(--gray-600);margin-bottom:16px;">Stored in Settings sheet Column P. These categories appear in the Add Expense dropdown.</p>
          <div id="category-list"></div>
          <button class="btn btn-add-row" onclick="addCategoryRow()" style="margin:12px 0 16px;"><span>+</span> Add Category</button>
          <button class="btn btn-submit" onclick="saveCategories()" style="width:100%;padding:12px;"><span>💾</span> Save All Categories</button>
        </div>
      </div>

      <!-- ── ADD PROJECT ── -->
      <div id="set-sec-add-project" class="right-section">
        <div class="attendance-card">
          <h3 style="color:var(--primary);margin-bottom:18px;font-size:18px;display:flex;align-items:center;gap:10px;"><span>🏗️</span> Project Management</h3>
          <p style="font-size:12px;color:var(--gray-600);margin-bottom:16px;">Stored in Settings sheet Column Q (Project Name) & Column R (Location/Notes).</p>
          <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:8px;">
            <div style="font-weight:700;font-size:12px;color:var(--gray-600);">Project Name</div>
            <div style="font-weight:700;font-size:12px;color:var(--gray-600);">Location / Notes</div>
            <div></div>
          </div>
          <div id="project-list"></div>
          <button class="btn btn-add-row" onclick="addProjectRow()" style="margin:12px 0 16px;"><span>+</span> Add Project</button>
          <button class="btn btn-submit" onclick="saveProjects()" style="width:100%;padding:12px;"><span>💾</span> Save All Projects</button>
        </div>
      </div>

    </div><!-- end right-panel -->
  </div><!-- end split-screen -->
</div>

<!-- ══════════════ TOAST ══════════════ -->
<!-- Project datalist for expense rows - populated by updateProjectDatalist() -->
<datalist id="project-datalist"></datalist>

<div id="toast"><span style="font-size:20px;">✓</span><span id="toast-msg">Success!</span></div>

<script>
// ══════════════════════════════════════════════════════
// GLOBAL STATE
// ══════════════════════════════════════════════════════
let cache = { employees:[], attendance:[], holidays:[], advances:[], categories:[], projects:[] };
let editingOriginalName = "", isAddingNew = false;
let currentResults = [], slipData = null, fullSummaryData = null;
let monthlyResults = [], editingRecords = [], editMode = 'single-emp';
let currentAdvanceAmount = 0, salaryCalculation = null;
let escLoadedRecords = [], reportData = null, summaryData = null;

// ══════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════
window.onload = function() {
  var today = new Date();
  document.getElementById('att-date-picker').valueAsDate = today;
  document.getElementById('dash-date-filter').valueAsDate = today;
  document.getElementById('edit-date-from').valueAsDate = today;
  document.getElementById('edit-date-to').valueAsDate = today;
  document.getElementById('edit-date-multi').valueAsDate = today;
  var cm = String(today.getMonth()+1).padStart(2,'0');
  ['monthly-month-select','full-month-select','salary-month-select','sum-month','rep-month','all-sal-month'].forEach(function(id){
    var el = document.getElementById(id); if(el) el.value = cm;
  });
  loadServerData();
};

function loadServerData() {
  google.script.run.withSuccessHandler(function(data){
    cache = data;
    updateDropdowns();
    updateProjectDatalist();
    initAttendanceTable();
    updateSundayButtonsVisibility();
    loadHolidays();
    renderCategoryList();
    renderProjectList();
    // Init advance rows AFTER cache is populated so dropdowns have data
    initExpenseRows();
    initAdvanceRows();
  }).withFailureHandler(function(e){ notify('❌ Load error: '+e); }).getAppData();
}

function initExpenseRows() {
  document.getElementById('expense-body').innerHTML = '';
  for(var i=0;i<4;i++) addExpenseRow();
}

function initAdvanceRows() {
  document.getElementById('advance-recv-body').innerHTML = '';
  for(var i=0;i<3;i++) addAdvanceRow();
}

function updateProjectDatalist() {
  var dl = document.getElementById('project-datalist');
  if(!dl) return;
  dl.innerHTML = (cache.projects||[]).map(function(p){
    return '<option value="'+p.name+'">';
  }).join('');
}

function updateDropdowns() {
  var opts = cache.employees.map(function(e){ return '<option value="'+e.name+'">'+e.name+'</option>'; }).join('');
  var allOpts = '<option value="">Select Employee...</option>'+opts;
  ['emp-lookup-select','salary-emp-select','monthly-emp-select','edit-emp-select-single','esc-emp','sum-emp'].forEach(function(id){
    var el = document.getElementById(id);
    if(el) {
      if(id==='sum-emp') el.innerHTML = '<option value="">All Employees</option>'+opts;
      else el.innerHTML = allOpts;
    }
    // Update time analysis employee dropdown
  var timeEmpSel = document.getElementById('time-analysis-emp-select');
  if(timeEmpSel && cache.employees) {
    var currentVal = timeEmpSel.value;
    timeEmpSel.innerHTML = '<option value="ALL">🌐 All Employees</option>' + 
      cache.employees.map(function(e) {
        return '<option value="' + e.name + '">' + e.name + '</option>';
      }).join('');
    if(currentVal) timeEmpSel.value = currentVal;
  }
  });
}

// ══════════════════════════════════════════════════════
// TAB SWITCHING
// ══════════════════════════════════════════════════════
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('nav button').forEach(function(b){ b.classList.remove('active'); });
  var el = document.getElementById(id);
  var btn = document.getElementById('tab-btn-'+id);
  if(el) el.classList.add('active');
  if(btn) btn.classList.add('active');
  // Refresh advance dropdowns each time the advance tab is opened
  if(id === 'advance' && cache.employees.length > 0) {
    initExpenseRows();
    initAdvanceRows();
    updateProjectDatalist();
  }
}

function switchFsSection(sec) {
  // Toggle right panels
  document.querySelectorAll('.fs-sec-panel').forEach(function(p){ p.style.display='none'; });
  var panel = document.getElementById('fs-sec-'+sec);
  if(panel) panel.style.display='block';
  // Toggle nav buttons
  document.querySelectorAll('.fs-nav-btn').forEach(function(b){ b.classList.remove('active'); });
  var btn = document.getElementById('fs-nav-'+sec);
  if(btn) btn.classList.add('active');
  // Toggle control panels in left sidebar
  var ctrlPivot = document.getElementById('fs-ctrl-pivot');
  var ctrlDetail = document.getElementById('fs-ctrl-detail');
  var ctrlTimeAnalysis = document.getElementById('fs-ctrl-timeanalysis');
  if(ctrlPivot) ctrlPivot.style.display = (sec==='pivot')?'block':'none';
  if(ctrlDetail) ctrlDetail.style.display = (sec==='detail')?'block':'none';
  if(ctrlTimeAnalysis) ctrlTimeAnalysis.style.display = (sec==='timeanalysis')?'block':'none';
}

function switchSsSection(sec) {
  document.querySelectorAll('#salaryslip .right-section').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('[id^="ss-btn-"]').forEach(function(b){ b.classList.remove('active'); });
  var el = document.getElementById('ss-sec-'+sec);
  var btn = document.getElementById('ss-btn-'+sec);
  if(el) el.classList.add('active');
  if(btn) btn.classList.add('active');
}

function switchAdvSection(sec) {
  document.querySelectorAll('#advance .right-section').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('[id^="adv-btn-"]').forEach(function(b){ b.classList.remove('active'); });
  var el = document.getElementById('adv-sec-'+sec);
  var btn = document.getElementById('adv-btn-'+sec);
  if(el) el.classList.add('active');
  if(btn) btn.classList.add('active');
}

function switchSetSection(sec) {
  document.querySelectorAll('#settings .right-section').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('[id^="set-btn-"]').forEach(function(b){ b.classList.remove('active'); });
  var el = document.getElementById('set-sec-'+sec);
  var btn = document.getElementById('set-btn-'+sec);
  if(el) el.classList.add('active');
  if(btn) btn.classList.add('active');
}

// ══════════════════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════════════════
function formatDate(dateStr) {
  if(!dateStr) return '-';
  var date = new Date(dateStr);
  if(isNaN(date)) return dateStr;
  var day = String(date.getDate()).padStart(2,'0');
  var month = date.toLocaleString('default',{month:'long'});
  var yr = date.getFullYear().toString().slice(-2);
  return day+'-'+month+'-'+yr;
}
function formatTime(v) {
  if(!v||v===''||v==='undefined') return '-';
  var s = String(v).trim();
  var m = s.match(/(\d{1,2}):(\d{2})/);
  if(m) return m[1].padStart(2,'0')+':'+m[2];
  return '-';
}
function formatTimeAMPM(v) {
  if(!v||v===''||v==='undefined') return '-';
  var s = String(v).trim();
  var m = s.match(/(\d{1,2}):(\d{2})/);
  if(!m) return '-';
  var h = parseInt(m[1],10), min = m[2];
  var period = h >= 12 ? 'PM' : 'AM';
  var h12 = h % 12 || 12;
  return h12 + ':' + min + ' ' + period;
}
function isSunday(ds) { return ds && new Date(ds).getDay()===0; }
function isHoliday(ds) { return ds && cache.holidays && cache.holidays.some(function(h){ return h.date===ds; }); }
function getStatusBadgeClass(s) {
  s = (s||'').toLowerCase();
  if(s==='present') return 'badge-success';
  if(s==='holiday') return 'badge-holiday';
  if(s==='half day') return 'badge-halfday';
  return 'badge-danger';
}
function getEmployeeOTHours(n) {
  var e = cache.employees.find(function(e){ return e.name===n; });
  return e ? parseFloat(e.otHours||9) : 9;
}
function notify(msg) {
  var t = document.getElementById('toast');
  document.getElementById('toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 3000);
}
function formatTimeInput(t){
  if(!t || t==='-' ) return '';

  // already correct format HH:MM
  if(/^\d{2}:\d{2}$/.test(t)) return t;

  // if HH:MM:SS → convert
  if(/^\d{2}:\d{2}:\d{2}$/.test(t)){
    return t.substring(0,5);
  }

  return '';
}

// ══════════════════════════════════════════════════════
// ATTENDANCE TAB
// ══════════════════════════════════════════════════════
function initAttendanceTable() {
  document.getElementById('attendance-body').innerHTML = '';
  for(var i=0;i<8;i++) addAttRow();
  updateSundayButtonsVisibility();
}

function addAttRow(name) {
  name = name || '';
  var active = cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  var opts = '<option value="">-- Select Employee --</option>';
  active.forEach(function(e){ opts += '<option value="'+e.name+'"'+(e.name===name?' selected':'')+'>'+e.name+'</option>'; });
  var tr = document.createElement('tr');
  tr.innerHTML = '<td><select class="row-name" onchange="updateOTForEmployee(this)">'+opts+'</select></td>'
    +'<td><input type="time" class="in-time" value="08:00" onchange="calcOT(this)"></td>'
    +'<td><input type="time" class="out-time" value="20:00" onchange="calcOT(this)"></td>'
    +'<td><input type="number" step="0.1" min="0" class="row-ot" value="3.0"></td>'
    +'<td><input type="text" class="site" placeholder="Enter site name"></td>'
    +'<td class="action-cell">'
    +'<button class="btn btn-absent" onclick="toggleAbsent(this)">❌ Mark Absent</button>'
    +'<input type="checkbox" class="abs-check" style="display:none">'
    +'<button class="btn btn-sunday-worked" onclick="toggleSunday(this,\'worked\')" style="display:none;">Sun Worked</button>'
    +'<button class="btn btn-sunday-holiday" onclick="toggleSunday(this,\'holiday\')" style="display:none;">Sun Holiday</button>'
    +'</td>'
    +'<td style="text-align:center"><button class="btn-delete-row" onclick="clearRow(this)">✕</button></td>';
  document.getElementById('attendance-body').appendChild(tr);
  updateSundayButtonsVisibility();
  if(name) updateOTForEmployee(tr.querySelector('.row-name'));
}

function clearRow(btn) {
  var row = btn.closest('tr');
  row.querySelector('.row-name').value='';
  row.querySelector('.in-time').value='08:00';
  row.querySelector('.out-time').value='20:00';
  row.querySelector('.row-ot').value='3.0';
  row.querySelector('.site').value='';
  row.querySelector('.abs-check').checked=false;
  row.classList.remove('absent-row','sunday-holiday-row');
  row.querySelector('.btn-absent').innerHTML='❌ Mark Absent';
  row.querySelectorAll('.btn-sunday-worked,.btn-sunday-holiday').forEach(function(b){ b.classList.remove('active'); });
  row.querySelectorAll('.in-time,.out-time,.row-ot,.site').forEach(function(f){ f.disabled=false; });
}

function updateOTForEmployee(sel) { calcOT(sel.closest('tr').querySelector('.in-time')); }

function toggleAbsent(btn) {
  var row = btn.closest('tr');
  var cb = row.querySelector('.abs-check');
  var isAbsent = cb.checked = !cb.checked;
  row.classList.toggle('absent-row',isAbsent);
  btn.innerHTML = isAbsent ? '↩️ Undo Absent' : '❌ Mark Absent';
  var fields = row.querySelectorAll('.in-time,.out-time,.row-ot,.site');
  if(isAbsent) {
    fields.forEach(function(f){ f.dataset.prev=f.value||''; f.value=''; f.disabled=true; });
    row.classList.remove('sunday-holiday-row');
    row.querySelectorAll('.btn-sunday-worked,.btn-sunday-holiday').forEach(function(b){ b.classList.remove('active'); });
  } else {
    fields.forEach(function(f){ if(f.dataset.prev!==undefined){ f.value=f.dataset.prev; f.disabled=false; } });
    calcOT(row.querySelector('.in-time'));
  }
}

function toggleSunday(btn,type) {
  var row = btn.closest('tr');
  row.querySelector('.btn-sunday-worked').classList.remove('active');
  row.querySelector('.btn-sunday-holiday').classList.remove('active');
  row.classList.remove('sunday-holiday-row');
  btn.classList.add('active');
  if(type==='holiday') {
    row.classList.add('sunday-holiday-row');
    row.querySelectorAll('.in-time,.out-time,.row-ot,.site').forEach(function(f){ f.disabled=true; f.value=''; });
    var absCb = row.querySelector('.abs-check');
    if(absCb.checked){ absCb.checked=false; row.querySelector('.btn-absent').innerHTML='❌ Mark Absent'; row.classList.remove('absent-row'); }
  } else {
    if(!row.querySelector('.abs-check').checked) row.querySelectorAll('.in-time,.out-time,.row-ot,.site').forEach(function(f){ f.disabled=false; });
  }
  calcOT(row.querySelector('.in-time'));
}

function updateSundayButtonsVisibility() {
  var selectedDate = document.getElementById('att-date-picker').value;
  var isSun = selectedDate && new Date(selectedDate).getDay()===0;
  document.querySelectorAll('#attendance-body tr').forEach(function(row){
    row.querySelectorAll('.btn-sunday-worked,.btn-sunday-holiday').forEach(function(b){ b.style.display=isSun?'inline-flex':'none'; });
  });
}
document.getElementById('att-date-picker').addEventListener('change',updateSundayButtonsVisibility);

function calcOT(el) {
  var row = el.closest('tr');
  if(row.classList.contains('absent-row')||row.classList.contains('sunday-holiday-row')) return;
  var t1=row.querySelector('.in-time').value, t2=row.querySelector('.out-time').value, nm=row.querySelector('.row-name').value;
  if(t1&&t2&&nm) {
    var diff=(new Date('1970-01-01T'+t2)-new Date('1970-01-01T'+t1))/3600000;
    row.querySelector('.row-ot').value=Math.max(0,diff-getEmployeeOTHours(nm)).toFixed(1);
  }
}

function generateActiveList() {
  document.getElementById('attendance-body').innerHTML='';
  cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; }).forEach(function(e){ addAttRow(e.name); });
}

function changeDate(days) {
  var input=document.getElementById('att-date-picker');
  var date=new Date(input.value||new Date()); date.setDate(date.getDate()+days);
  input.valueAsDate=date; updateSundayButtonsVisibility();
}
function changeDashDate(days) {
  var input=document.getElementById('dash-date-filter');
  var date=new Date(input.value||new Date()); date.setDate(date.getDate()+days);
  input.valueAsDate=date; filterByDate();
}

function submitAttendance() {
  var data=[];
  document.querySelectorAll('#attendance-body tr').forEach(function(r){
    var nSel=r.querySelector('.row-name'); if(!nSel.value) return;
    var isAbsent=r.querySelector('.abs-check').checked, isHol=r.classList.contains('sunday-holiday-row');
    data.push({date:document.getElementById('att-date-picker').value, name:nSel.value,
      inTime:(isAbsent||isHol)?'':r.querySelector('.in-time').value,
      outTime:(isAbsent||isHol)?'':r.querySelector('.out-time').value,
      ot:(isAbsent||isHol)?'':r.querySelector('.row-ot').value,
      site:(isAbsent||isHol)?'':(r.querySelector('.site').value||'Site'),
      status:isHol?'Holiday':(isAbsent?'Absent':'Present')});
  });
  if(data.length===0){ notify('⚠️ No attendance data to submit'); return; }
  document.getElementById('processing-indicator').style.display='flex';
  google.script.run.withSuccessHandler(function(dups){
    if(dups.length>0) {
      var msg='Duplicate entries found:\n\n'+dups.map(function(d){ return '• '+d; }).join('\n')+'\n\nOverwrite?';
      document.getElementById('processing-indicator').style.display='none';
      if(confirm(msg)){ document.getElementById('processing-indicator').style.display='flex'; saveAttendanceData(data); }
      else notify('Cancelled');
    } else saveAttendanceData(data);
  }).withFailureHandler(function(e){ document.getElementById('processing-indicator').style.display='none'; notify('❌ '+e); }).checkDuplicates(data);
}

function saveAttendanceData(data) {
  google.script.run.withSuccessHandler(function(r){
    document.getElementById('processing-indicator').style.display='none';
    if(r.success){ notify('✅ '+r.message); loadServerData(); } else notify('❌ Failed');
  }).withFailureHandler(function(e){ document.getElementById('processing-indicator').style.display='none'; notify('❌ '+e); }).saveAttendance(data);
}

// ══════════════════════════════════════════════════════
// DASHBOARD TAB
// ══════════════════════════════════════════════════════
function filterByDate() {
  var d = document.getElementById('dash-date-filter').value;
  if(!d){ notify('⚠️ Please select a date'); return; }
  var dayData = cache.attendance.filter(function(a){ return a.date===d; });
  currentResults=dayData;
  if(dayData.length===0){
    document.getElementById('dash-results-body').innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--gray-600);">No records for '+formatDate(d)+'</td></tr>'; return;
  }
  document.getElementById('dash-results-body').innerHTML = dayData.map(function(r){
    return '<tr><td'+(isSunday(r.date)?' class="sunday-date"':'')+'>'+formatDate(r.date)+'</td><td>'+r.name+'</td>'
      +'<td class="time-column">'+formatTimeAMPM(r.inTime)+'</td><td class="time-column">'+formatTimeAMPM(r.outTime)+'</td>'
      +'<td>'+(r.status==='Holiday'||r.status==='Absent'?'-':(r.ot||'0'))+'</td><td>'+(r.site||'-')+'</td>'
      +'<td><span class="badge '+getStatusBadgeClass(r.status)+'">'+r.status+'</span></td></tr>';
  }).join('');
}

function switchEditMode(mode) {
  editMode=mode;
  document.getElementById('mode-single-emp').classList.toggle('active',mode==='single-emp');
  document.getElementById('mode-multi-emp').classList.toggle('active',mode==='multi-emp');
  document.getElementById('edit-single-emp-mode').style.display=mode==='single-emp'?'block':'none';
  document.getElementById('edit-multi-emp-mode').style.display=mode==='multi-emp'?'block':'none';
  document.getElementById('edit-record-container').style.display='none';
}
function formatTimeInput(t){
  if(!t || t === '-' || t === '') return '';

  t = String(t).trim();

  // already correct HH:MM
  if(/^\d{2}:\d{2}$/.test(t)) return t;

  // HH:MM:SS → HH:MM
  if(/^\d{2}:\d{2}:\d{2}$/.test(t)){
    return t.substring(0,5);
  }

  // AM / PM format (e.g. 9:30 AM)
  var m = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
  if(m){
    var h = parseInt(m[1],10);
    var min = m[2];
    var ap = m[3].toUpperCase();

    if(ap === 'PM' && h < 12) h += 12;
    if(ap === 'AM' && h === 12) h = 0;

    return String(h).padStart(2,'0') + ':' + min;
  }

  // Full datetime (ISO etc)
  try{
    var d = new Date(t);
    if(!isNaN(d)){
      return String(d.getHours()).padStart(2,'0') + ':' +
             String(d.getMinutes()).padStart(2,'0');
    }
  } catch(e){}

  return '';
}



function showEditableRecordsSingle() {
  var empName=document.getElementById('edit-emp-select-single').value;
  var dateFrom=document.getElementById('edit-date-from').value;
  var dateTo=document.getElementById('edit-date-to').value;
  if(!empName||!dateFrom||!dateTo){ notify('⚠️ Please fill all fields'); return; }
  if(new Date(dateFrom)>new Date(dateTo)){ notify('⚠️ From date must be before To date'); return; }
  editingRecords=[]; var tbody=document.getElementById('edit-record-body'); var rows='';
  for(var d=new Date(dateFrom);d<=new Date(dateTo);d.setDate(d.getDate()+1)){
    var ds=d.toISOString().split('T')[0];
    var rec=cache.attendance.find(function(a){ return a.date===ds&&a.name===empName; });
    if(rec){
      editingRecords.push(Object.assign({},rec));
      rows+='<tr data-date="'+ds+'" data-name="'+empName+'">'
        +'<td>'+formatDate(ds)+'</td><td>'+empName+'</td>'
        +'<td><input type="time" class="edit-in" value="'+formatTimeInput(rec.inTime||'')+'" onchange="calcEditOT(this)" style="width:100%;"></td>'
        +'<td><input type="time" class="edit-out" value="'+formatTimeInput(rec.outTime||'')+'" onchange="calcEditOT(this)" style="width:100%;"></td>'
        +'<td><input type="number" step="0.1" class="edit-ot" value="'+(rec.ot||'0')+'" style="width:100%;"></td>'
        +'<td><input type="text" class="edit-site" value="'+(rec.site||'')+'" style="width:100%;"></td>'
        +'<td><select class="edit-status" style="width:100%;"><option'+(rec.status==='Present'?' selected':'')+'">Present</option><option'+(rec.status==='Half Day'?' selected':'')+'>Half Day</option><option'+(rec.status==='Absent'?' selected':'')+'>Absent</option><option'+(rec.status==='Holiday'?' selected':'')+'>Holiday</option></select></td>'
        +'<td style="text-align:center"><button class="btn-delete-row" onclick="clearEditRow(this)">✕</button></td></tr>';
    }
  }
  if(editingRecords.length===0){ notify('⚠️ No records found in selected range'); return; }
  tbody.innerHTML=rows;
  document.getElementById('edit-record-container').style.display='block';
  document.getElementById('add-edit-row-btn').style.display='none';
  notify('✅ Loaded '+editingRecords.length+' record(s)');
}

function showEditableRecordsMulti() {
  var date = document.getElementById('edit-date-multi').value;

  if(!date){
    notify('⚠️ Select a date');
    return;
  }

  editingRecords = [];
  var tbody = document.getElementById('edit-record-body');
  var rows = '';

  // Active employees sorted
  var employees = cache.employees
    .filter(e => e.status === 'Active')
    .sort((a,b)=>a.name.localeCompare(b.name));

  employees.forEach(function(emp){

    var rec = cache.attendance.find(function(a){
      return a.date === date && a.name === emp.name;
    });

    // If no record -> blank row (highlight)
    if(!rec){
      rec = {
        date: date,
        name: emp.name,
        inTime: '',
        outTime: '',
        ot: '0',
        site: '',
        status: 'Absent'
      };
    }

    editingRecords.push(Object.assign({},rec));

    var missing = (!rec.inTime || !rec.outTime);

    rows += '<tr data-date="'+date+'" data-name="'+emp.name+'" '
      +(missing?'style="background:#fff7ed;"':'')+'>'

      +'<td>'+formatDate(date)+'</td>'
      +'<td><strong>'+emp.name+'</strong></td>'

      +'<td><input type="time" class="edit-in" value="'+formatTimeInput(rec.inTime||'')+'" onchange="calcEditOT(this)" style="width:100%;"></td>'

      +'<td><input type="time" class="edit-out" value="'+formatTimeInput(rec.outTime||'')+'" onchange="calcEditOT(this)" style="width:100%;"></td>'

      +'<td><input type="number" step="0.1" class="edit-ot" value="'+(rec.ot||'0')+'" style="width:100%;"></td>'

      +'<td><input type="text" class="edit-site" value="'+(rec.site||'')+'" style="width:100%;"></td>'

      +'<td><select class="edit-status" style="width:100%;">'
      +'<option'+(rec.status==='Present'?' selected':'')+'>Present</option>'
      +'<option'+(rec.status==='Half Day'?' selected':'')+'>Half Day</option>'
      +'<option'+(rec.status==='Absent'?' selected':'')+'>Absent</option>'
      +'<option'+(rec.status==='Holiday'?' selected':'')+'>Holiday</option>'
      +'</select></td>'

      +'<td style="text-align:center"><button class="btn-delete-row" onclick="clearEditRow(this)">✕</button></td>'
      +'</tr>';
  });

  tbody.innerHTML = rows;

  document.getElementById('edit-record-container').style.display='block';
  document.getElementById('add-edit-row-btn').style.display='block';
  document.getElementById('mark-all-present-btn').style.display='inline-flex';

  notify('✅ Smart grid loaded ('+employees.length+' employees)');
}


function addEditRow() {
  var date=document.getElementById('edit-date-multi').value;
  var active=cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  var opts='<option value="">-- Select Employee --</option>';
  active.forEach(function(e){ opts+='<option value="'+e.name+'">'+e.name+'</option>'; });
  var tbody=document.getElementById('edit-record-body');
  var tr=document.createElement('tr'); tr.setAttribute('data-date',date);
  tr.innerHTML='<td>'+formatDate(date)+'</td>'
    +'<td><select class="edit-emp-name" style="width:100%;" onchange="updateEditRowName(this)">'+opts+'</select></td>'
    +'<td><input type="time" class="edit-in" onchange="calcEditOT(this)" style="width:100%;"></td>'
    +'<td><input type="time" class="edit-out" onchange="calcEditOT(this)" style="width:100%;"></td>'
    +'<td><input type="number" step="0.1" class="edit-ot" value="0" style="width:100%;"></td>'
    +'<td><input type="text" class="edit-site" style="width:100%;"></td>'
    +'<td><select class="edit-status" style="width:100%;"><option>Present</option><option>Half Day</option><option>Absent</option><option>Holiday</option></select></td>'
    +'<td style="text-align:center"><button class="btn-delete-row" onclick="this.closest(\'tr\').remove()">✕</button></td>';
  tbody.appendChild(tr);
}
function clearEditRow(btn){ var r=btn.closest('tr'); r.querySelector('.edit-in').value=''; r.querySelector('.edit-out').value=''; r.querySelector('.edit-ot').value='0'; r.querySelector('.edit-site').value=''; r.querySelector('.edit-status').value='Present'; }
function updateEditRowName(sel){ sel.closest('tr').setAttribute('data-name',sel.value); }
function calcEditOT(el) {
  var row=el.closest('tr'); var t1=row.querySelector('.edit-in').value; var t2=row.querySelector('.edit-out').value;
  var nm=row.getAttribute('data-name');
  if(t1&&t2&&nm){ var diff=(new Date('1970-01-01T'+t2)-new Date('1970-01-01T'+t1))/3600000; row.querySelector('.edit-ot').value=Math.max(0,diff-getEmployeeOTHours(nm)).toFixed(1); }
}

function resubmitAllAttendance() {
  var rows=document.querySelectorAll('#edit-record-body tr'); if(rows.length===0){ notify('⚠️ No records'); return; }
  document.getElementById('edit-processing-indicator').style.display='flex';
  var updates=[]; rows.forEach(function(row){
    var date=row.getAttribute('data-date'); var name=row.getAttribute('data-name');
    var empSel=row.querySelector('.edit-emp-name'); if(empSel){ name=empSel.value; if(!name) return; }
    var status=row.querySelector('.edit-status').value; var noFields=status==='Absent'||status==='Holiday';
    updates.push({date:date,name:name,inTime:noFields?'':(row.querySelector('.edit-in').value||''),
      outTime:noFields?'':(row.querySelector('.edit-out').value||''),
      ot:noFields?'':(row.querySelector('.edit-ot').value||'0'),
      site:noFields?'':(row.querySelector('.edit-site').value||''),status:status});
  });
  if(updates.length===0){ document.getElementById('edit-processing-indicator').style.display='none'; notify('⚠️ No valid records'); return; }
  var done=0,failed=0;
  updates.forEach(function(rec){
    google.script.run.withSuccessHandler(function(r){
      if(r.success) done++; else failed++;
      if(done+failed===updates.length){
        document.getElementById('edit-processing-indicator').style.display='none';
        notify(failed===0?'✅ Updated all '+done+' record(s)':'⚠️ '+done+' done, '+failed+' failed');
        if(failed===0){ loadServerData(); document.getElementById('edit-record-container').style.display='none'; editingRecords=[]; }
      }
    }).withFailureHandler(function(){ failed++; if(done+failed===updates.length){ document.getElementById('edit-processing-indicator').style.display='none'; notify('⚠️ '+done+' done, '+failed+' failed'); } }).updateAttendanceRecord(rec);
  });
}

// ══════════════════════════════════════════════════════
// FULL SUMMARY TAB
// ══════════════════════════════════════════════════════
function showFullSummary() {
  var month=document.getElementById('full-month-select').value, year=document.getElementById('full-year-select').value;
  var days=new Date(year,parseInt(month),0).getDate();
  var active=cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  if(active.length===0){ notify('⚠️ No active employees'); return; }
  var colors=['emp-col-1','emp-col-2','emp-col-3','emp-col-4','emp-col-5','emp-col-6'];
  var hdr='<tr><th>Date</th>';
  active.forEach(function(e,i){ hdr+='<th colspan="3" class="employee-header '+colors[i%6]+'">'+e.name+'</th><th class="employee-separator"></th>'; });
  hdr+='</tr><tr><th></th>';
  active.forEach(function(e,i){ hdr+='<th class="'+colors[i%6]+'">IN</th><th class="'+colors[i%6]+'">OUT</th><th class="'+colors[i%6]+'">OT</th><th class="employee-separator"></th>'; });
  hdr+='</tr>';
  document.getElementById('full-summary-head').innerHTML=hdr;
  var body='';
  for(var day=1;day<=days;day++){
    var ds=year+'-'+month+'-'+String(day).padStart(2,'0');
    body+='<tr><td'+(isSunday(ds)?' class="sunday-date"':'')+'>'+formatDate(ds)+'</td>';
    active.forEach(function(emp,i){
      var rec=cache.attendance.find(function(a){ return a.name===emp.name&&a.date===ds; });
      var c=colors[i%6];
      if(rec){
        if(rec.status==='Absent') body+='<td colspan="3" class="'+c+'" style="background:#fee2e2!important;text-align:center;font-weight:600;color:#991b1b;">Absent</td>';
        else if(rec.status==='Holiday') body+='<td colspan="3" class="'+c+'" style="background:#fff3bf!important;text-align:center;font-weight:600;color:#e67700;">Holiday</td>';
        else if(rec.status==='Half Day') body+='<td class="'+c+'">'+formatTimeAMPM(rec.inTime)+'</td><td class="'+c+'">'+formatTimeAMPM(rec.outTime)+'</td><td class="'+c+'" style="background:#fed7aa!important;font-weight:600;">Half</td>';
        else body+='<td class="'+c+'">'+formatTimeAMPM(rec.inTime)+'</td><td class="'+c+'">'+formatTimeAMPM(rec.outTime)+'</td><td class="'+c+'">'+(rec.ot||'0')+'</td>';
      } else body+='<td class="'+c+'">-</td><td class="'+c+'">-</td><td class="'+c+'">-</td>';
      body+='<td class="employee-separator"></td>';
    });
    body+='</tr>';
  }
  document.getElementById('full-summary-body').innerHTML=body;
  fullSummaryData={month:month,year:year,days:days,employees:active,monthName:document.getElementById('full-month-select').selectedOptions[0].textContent};
  notify('✅ Summary generated');
}

function exportFullSummaryPDF() {
  if(!fullSummaryData){ notify('⚠️ Generate summary first'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF('landscape');
  doc.setFontSize(14); doc.text('Full Monthly Summary - '+fullSummaryData.monthName+' '+fullSummaryData.year,148,15,{align:'center'});
  var firstRow=['Date'], secondRow=[''];
  fullSummaryData.employees.forEach(function(e){ firstRow.push({content:e.name,colSpan:3,styles:{halign:'center',fillColor:[99,102,241]}}); secondRow.push('IN','OUT','OT'); });
  var body=[];
  for(var d=1;d<=fullSummaryData.days;d++){
    var ds=fullSummaryData.year+'-'+fullSummaryData.month+'-'+String(d).padStart(2,'0'); var row=[formatDate(ds)];
    fullSummaryData.employees.forEach(function(e){
      var rec=cache.attendance.find(function(a){ return a.name===e.name&&a.date===ds; });
      if(rec){
        if(rec.status==='Absent') row.push({content:'Absent',colSpan:3,styles:{halign:'center',fillColor:[254,226,226]}});
        else if(rec.status==='Holiday') row.push({content:'Holiday',colSpan:3,styles:{halign:'center',fillColor:[255,243,191]}});
        else if(rec.status==='Half Day') row.push(formatTime(rec.inTime),formatTime(rec.outTime),{content:'Half',styles:{fillColor:[254,215,170]}});
        else row.push(formatTime(rec.inTime),formatTime(rec.outTime),rec.ot||'0');
      } else row.push('-','-','-');
    });
    body.push(row);
  }
  doc.autoTable({head:[firstRow,secondRow],body:body,startY:25,theme:'grid',styles:{fontSize:7,cellPadding:2},headStyles:{fillColor:[99,102,241],fontSize:8}});
  doc.save('Full_Summary_'+fullSummaryData.year+'_'+fullSummaryData.monthName+'.pdf');
}

function toggleMonthlyDetail() {
  var s=document.getElementById('monthly-detail-section');
  var arrowIcon=document.getElementById('monthly-detail-arrow-icon');
  var hidden=s.style.display==='none';
  s.style.display=hidden?'block':'none';
  if(arrowIcon){ arrowIcon.classList.toggle('open',hidden); }
}

function showMonthlyDetail() {
  var n=document.getElementById('monthly-emp-select').value, m=document.getElementById('monthly-month-select').value, year=document.getElementById('monthly-year-select').value;
  if(!n){ notify('⚠️ Select employee'); return; }
  var days=new Date(year,parseInt(m),0).getDate(); monthlyResults=[];
  for(var i=1;i<=days;i++){
    var ds=year+'-'+m+'-'+String(i).padStart(2,'0');
    var rec=cache.attendance.find(function(a){ return a.name===n&&a.date===ds; });
    monthlyResults.push(rec||{date:ds,name:n,inTime:'-',outTime:'-',ot:'-',site:'-',status:'N/A'});
  }
  document.getElementById('monthly-results-body').innerHTML=monthlyResults.map(function(r){
    return '<tr><td'+(isSunday(r.date)?' class="sunday-date"':'')+'>'+formatDate(r.date)+'</td><td>'+r.name+'</td>'
      +'<td class="time-column">'+formatTimeAMPM(r.inTime)+'</td><td class="time-column">'+formatTimeAMPM(r.outTime)+'</td>'
      +'<td>'+(r.status==='Holiday'||r.status==='Absent'?'-':r.ot)+'</td><td>'+r.site+'</td>'
      +'<td><span class="badge '+getStatusBadgeClass(r.status)+'">'+r.status+'</span></td></tr>';
  }).join('');
  notify('✅ Monthly detail loaded');
}

function exportMonthlyPDF() {
  if(monthlyResults.length===0){ notify('⚠️ No data'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF();
  var nm=document.getElementById('monthly-emp-select').value, month=document.getElementById('monthly-month-select').selectedOptions[0].textContent, year=document.getElementById('monthly-year-select').value;
  doc.setFontSize(14); doc.text('Monthly Report - '+nm,105,15,{align:'center'}); doc.setFontSize(11); doc.text(month+' '+year,105,22,{align:'center'});
  doc.autoTable({head:[['Date','Name','In','Out','OT','Site','Status']],body:monthlyResults.map(function(r){ return [formatDate(r.date),r.name,formatTime(r.inTime),formatTime(r.outTime),(r.status==='Holiday'||r.status==='Absent'?'-':r.ot),r.site||'-',r.status]; }),startY:28,theme:'striped',styles:{fontSize:8},headStyles:{fillColor:[99,102,241]}});
  doc.save('Monthly_'+nm.replace(/\s+/g,'_')+'_'+year+'_'+month+'.pdf');
}

function printMonthlyTable() {
  if(monthlyResults.length===0){ notify('⚠️ No data'); return; }
  openPrintWindow(document.getElementById('monthly-results-table').outerHTML,'Monthly Report');
}

// ══════════════════════════════════════════════════════
// ADVANCE TAB
// ══════════════════════════════════════════════════════
function addExpenseRow() {
  var active=cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  var empOpts='<option value="">-- Employee --</option>'+active.map(function(e){ return '<option value="'+e.name+'">'+e.name+'</option>'; }).join('');
  var catOpts='<option value="">-- Category --</option>'+(cache.categories||[]).map(function(c){ return '<option value="'+c+'">'+c+'</option>'; }).join('');
  var projOpts='<option value="">-- Project (optional) --</option>'+(cache.projects||[]).map(function(p){ return '<option value="'+p.name+'">'+p.name+(p.location?' ('+p.location+')':'')+'</option>'; }).join('');
  var today=new Date().toISOString().split('T')[0];
  var tr=document.createElement('tr');
  tr.innerHTML='<td><input type="date" class="exp-date" value="'+today+'" style="width:100%;min-width:110px;"></td>'
    +'<td><select class="exp-emp" style="width:100%;min-width:130px;">'+empOpts+'</select></td>'
    +'<td><select class="exp-cat" style="width:100%;min-width:130px;">'+catOpts+'</select></td>'
    +'<td><input type="number" class="exp-amount" placeholder="0" min="0" step="0.01" style="width:100%;min-width:90px;"></td>'
    +'<td><input type="text" class="exp-remarks" placeholder="Notes..." style="width:100%;min-width:150px;"></td>'
    +'<td><select class="exp-project" style="width:100%;min-width:120px;">'+projOpts+'</select></td>'
    +'<td><input type="text" class="exp-approved" placeholder="Name" style="width:100%;min-width:100px;"></td>'
    +'<td style="text-align:center"><button class="btn-delete-row" onclick="this.closest(\'tr\').remove()">✕</button></td>';
  document.getElementById('expense-body').appendChild(tr);
}

function submitExpenses() {
  var rows=document.querySelectorAll('#expense-body tr'); var expenses=[];
  rows.forEach(function(row){
    var date=row.querySelector('.exp-date').value;
    var emp=row.querySelector('.exp-emp').value;
    var cat=row.querySelector('.exp-cat').value;
    var amt=parseFloat(row.querySelector('.exp-amount').value);
    if(!date||!emp||!cat||isNaN(amt)||amt<=0) return;
    expenses.push({date:date,employeeName:emp,category:cat,amount:amt,
      remarks:row.querySelector('.exp-remarks').value||'',
      project:row.querySelector('.exp-project').value||'',
      approvedBy:row.querySelector('.exp-approved').value||''});
  });
  if(expenses.length===0){ notify('⚠️ No valid expense rows'); return; }
  document.getElementById('exp-spinner').style.display='flex';
  google.script.run.withSuccessHandler(function(r){
    document.getElementById('exp-spinner').style.display='none';
    if(r.success){
      notify('✅ '+r.message);
      var refDiv=document.getElementById('expense-ref-result');
      refDiv.style.display='block';
      refDiv.innerHTML='<div style="background:#ecfdf5;padding:14px;border-radius:8px;border:1px solid #a7f3d0;"><strong>Reference Numbers Generated:</strong><br>'
        +r.results.map(function(res){ return '<span class="ref-badge">'+res.refNo+'</span> — '+res.employeeName+' | ₹'+res.amount; }).join('<br>')+'</div>';
      initExpenseRows();
    } else notify('❌ '+r.message);
  }).withFailureHandler(function(e){ document.getElementById('exp-spinner').style.display='none'; notify('❌ '+e); }).submitExpenses(expenses);
}

function addAdvanceRow() {
  var active=cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  var empOpts='<option value="">-- Employee --</option>'+active.map(function(e){ return '<option value="'+e.name+'">'+e.name+'</option>'; }).join('');
  var today=new Date().toISOString().split('T')[0];
  var tr=document.createElement('tr');
  tr.innerHTML='<td><input type="date" class="adv-date" value="'+today+'" style="width:100%;min-width:110px;"></td>'
    +'<td><select class="adv-emp" style="width:100%;min-width:140px;">'+empOpts+'</select></td>'
    +'<td><input type="number" class="adv-amount" placeholder="0" min="0" step="0.01" style="width:100%;min-width:100px;"></td>'
    +'<td><input type="text" class="adv-remarks" placeholder="Notes..." style="width:100%;min-width:150px;"></td>'
    +'<td><input type="text" class="adv-approved" placeholder="Name" style="width:100%;min-width:110px;"></td>'
    +'<td style="text-align:center"><button class="btn-delete-row" onclick="this.closest(\'tr\').remove()">✕</button></td>';
  document.getElementById('advance-recv-body').appendChild(tr);
}

function submitAdvances() {
  var rows=document.querySelectorAll('#advance-recv-body tr'); var advances=[];
  rows.forEach(function(row){
    var date=row.querySelector('.adv-date').value;
    var emp=row.querySelector('.adv-emp').value;
    var amt=parseFloat(row.querySelector('.adv-amount').value);
    if(!date||!emp||isNaN(amt)||amt<=0) return;
    advances.push({date:date,employeeName:emp,amount:amt,
      remarks:row.querySelector('.adv-remarks').value||'',
      approvedBy:row.querySelector('.adv-approved').value||''});
  });
  if(advances.length===0){ notify('⚠️ No valid advance rows'); return; }
  document.getElementById('adv-spinner').style.display='flex';
  google.script.run.withSuccessHandler(function(r){
    document.getElementById('adv-spinner').style.display='none';
    if(r.success){
      notify('✅ '+r.message);
      var refDiv=document.getElementById('advance-ref-result');
      refDiv.style.display='block';
      refDiv.innerHTML='<div style="background:#eff6ff;padding:14px;border-radius:8px;border:1px solid #93c5fd;"><strong>Reference Numbers Generated:</strong><br>'
        +r.results.map(function(res){ return '<span class="ref-badge">'+res.refNo+'</span> — '+res.employeeName+' | ₹'+res.amount; }).join('<br>')+'</div>';
      initAdvanceRows();
    } else notify('❌ '+r.message);
  }).withFailureHandler(function(e){ document.getElementById('adv-spinner').style.display='none'; notify('❌ '+e); }).submitAdvanceReceived(advances);
}

function loadEscalationRecords() {
  var type=document.getElementById('esc-type').value;
  var emp=document.getElementById('esc-emp').value;
  var dateFrom=document.getElementById('esc-date-from').value;
  var dateTo=document.getElementById('esc-date-to').value;
  if(!dateFrom||!dateTo){ notify('⚠️ Please select date range'); return; }
  var filters={};
  if(emp) filters.empName=emp;
  google.script.run.withSuccessHandler(function(records){
    var filtered=records.filter(function(r){ return r.date>=dateFrom&&r.date<=dateTo; });
    escLoadedRecords=filtered; renderEscalationTable(type,filtered);
    document.getElementById('esc-result-wrap').style.display='block';
    notify('✅ Loaded '+filtered.length+' record(s)');
  }).withFailureHandler(function(e){ notify('❌ '+e); })[type==='expense'?'getExpenses':'getAdvanceReceived'](filters);
}

function renderEscalationTable(type,records) {
  var thead=document.getElementById('esc-table-head');
  var tbody=document.getElementById('esc-table-body');
  if(type==='expense'){
    thead.innerHTML='<th>Date</th><th>Employee</th><th>Category</th><th>Amount</th><th>Remarks</th><th>Project</th><th>Ref No</th>';
    tbody.innerHTML=records.map(function(r,idx){
      var catOpts=(cache.categories||[]).map(function(c){ return '<option value="'+c+'"'+(c===r.category?' selected':'')+'>'+c+'</option>'; }).join('');
      return '<tr data-ref="'+r.refNo+'" data-type="expense">'
        +'<td><input type="date" class="esc-date" value="'+r.date+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-emp" value="'+r.employeeName+'" style="width:100%;"></td>'
        +'<td><select class="esc-cat" style="width:100%;">'+catOpts+'</select></td>'
        +'<td><input type="number" class="esc-amount" value="'+r.amount+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-remarks" value="'+r.remarks+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-project" value="'+r.project+'" style="width:100%;"></td>'
        +'<td><span class="ref-badge">'+r.refNo+'</span></td></tr>';
    }).join('');
  } else {
    thead.innerHTML='<th>Date</th><th>Employee</th><th>Amount</th><th>Remarks</th><th>Approved By</th><th>Ref No</th>';
    tbody.innerHTML=records.map(function(r){
      return '<tr data-ref="'+r.refNo+'" data-type="advance">'
        +'<td><input type="date" class="esc-date" value="'+r.date+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-emp" value="'+r.employeeName+'" style="width:100%;"></td>'
        +'<td><input type="number" class="esc-amount" value="'+r.amount+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-remarks" value="'+r.remarks+'" style="width:100%;"></td>'
        +'<td><input type="text" class="esc-approved" value="'+r.approvedBy+'" style="width:100%;"></td>'
        +'<td><span class="ref-badge">'+r.refNo+'</span></td></tr>';
    }).join('');
  }
}

function saveEscalationChanges() {
  var rows=document.querySelectorAll('#esc-table-body tr');
  if(rows.length===0){ notify('⚠️ No records to save'); return; }
  document.getElementById('esc-spinner').style.display='flex';
  var updates=[]; var type=rows[0].getAttribute('data-type');
  rows.forEach(function(row){
    var refNo=row.getAttribute('data-ref');
    var update={refNo:refNo,date:row.querySelector('.esc-date').value,employeeName:row.querySelector('.esc-emp').value,amount:parseFloat(row.querySelector('.esc-amount').value)||0};
    if(type==='expense'){ update.category=row.querySelector('.esc-cat').value; update.remarks=row.querySelector('.esc-remarks').value||''; update.project=row.querySelector('.esc-project').value||''; }
    else { update.remarks=row.querySelector('.esc-remarks').value||''; update.approvedBy=row.querySelector('.esc-approved').value||''; }
    updates.push(update);
  });
  var done=0,failed=0;
  updates.forEach(function(u){
    google.script.run.withSuccessHandler(function(r){
      if(r.success) done++; else failed++;
      if(done+failed===updates.length){ document.getElementById('esc-spinner').style.display='none'; notify(failed===0?'✅ All '+done+' record(s) saved':'⚠️ '+done+' saved, '+failed+' failed'); }
    }).withFailureHandler(function(){ failed++; if(done+failed===updates.length){ document.getElementById('esc-spinner').style.display='none'; notify('⚠️ '+done+' saved, '+failed+' failed'); } })[type==='expense'?'updateExpense':'updateAdvanceReceived'](u);
  });
}

function loadSummary() {
  var month=document.getElementById('sum-month').value;
  var year=document.getElementById('sum-year').value;
  var emp=document.getElementById('sum-emp').value;
  var monthKey=year+'-'+month;
  google.script.run.withSuccessHandler(function(data){
    summaryData=data;
    if(data.error){ notify('❌ '+data.error); return; }
    document.getElementById('sum-total-adv').textContent='₹'+data.totalAdvances.toFixed(2);
    document.getElementById('sum-total-exp').textContent='₹'+data.totalExpenses.toFixed(2);
    var bal=data.balance;
    document.getElementById('sum-balance').textContent='₹'+Math.abs(bal).toFixed(2);
    document.getElementById('sum-balance-label').textContent=bal>=0?'Balance (Excess Advance)':'Balance (Extra Expense to Pay)';
    document.getElementById('sum-balance-card').style.background=bal>=0?'#eff6ff':'#fef3c7';
    document.getElementById('sum-adv-body').innerHTML=data.advances.map(function(a){
      return '<tr><td>'+formatDate(a.date)+'</td><td>₹'+a.amount.toFixed(2)+'</td><td>'+(a.remarks||'-')+'</td><td><span class="ref-badge">'+a.refNo+'</span></td></tr>';
    }).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--gray-600);">No advances</td></tr>';
    document.getElementById('sum-exp-body').innerHTML=data.expenses.map(function(e){
      return '<tr><td>'+formatDate(e.date)+'</td><td>'+e.category+'</td><td>₹'+e.amount.toFixed(2)+'</td><td><span class="ref-badge">'+e.refNo+'</span></td></tr>';
    }).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--gray-600);">No expenses</td></tr>';
    document.getElementById('summary-result').style.display='block';
    notify('✅ Summary loaded');
  }).withFailureHandler(function(e){ notify('❌ '+e); }).getAdvanceSummary(monthKey,emp||'');
}

function exportSummaryPDF() {
  if(!summaryData){ notify('⚠️ Load summary first'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF();
  var emp=document.getElementById('sum-emp').value||'All Employees';
  var monthName=document.getElementById('sum-month').selectedOptions[0].textContent;
  var year=document.getElementById('sum-year').value;
  doc.setFontSize(16); doc.text('Advance & Expense Summary',105,15,{align:'center'});
  doc.setFontSize(11); doc.text(emp+' | '+monthName+' '+year,105,23,{align:'center'});
  var sumRows=[['Total Advance Received','₹'+summaryData.totalAdvances.toFixed(2)],['Total Expense','₹'+summaryData.totalExpenses.toFixed(2)],['Balance','₹'+Math.abs(summaryData.balance).toFixed(2)+(summaryData.balance>=0?' (Excess Advance)':' (Extra Expense)')]];
  doc.autoTable({body:sumRows,startY:30,theme:'grid',styles:{fontSize:10,cellPadding:5},columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}});
  var finalY=doc.lastAutoTable.finalY+8;
  doc.setFontSize(12); doc.text('Advances',14,finalY);
  doc.autoTable({head:[['Date','Amount','Remarks','Ref No']],body:summaryData.advances.map(function(a){ return [formatDate(a.date),'₹'+a.amount.toFixed(2),a.remarks||'-',a.refNo]; }),startY:finalY+4,theme:'striped',styles:{fontSize:8},headStyles:{fillColor:[99,102,241]}});
  finalY=doc.lastAutoTable.finalY+8;
  doc.setFontSize(12); doc.text('Expenses',14,finalY);
  doc.autoTable({head:[['Date','Category','Amount','Ref No']],body:summaryData.expenses.map(function(e){ return [formatDate(e.date),e.category,'₹'+e.amount.toFixed(2),e.refNo]; }),startY:finalY+4,theme:'striped',styles:{fontSize:8},headStyles:{fillColor:[239,68,68]}});
  doc.save('Summary_'+year+'_'+monthName+'.pdf');
}

function loadReport() {
  var month=document.getElementById('rep-month').value;
  var year=document.getElementById('rep-year').value;
  var monthKey=year+'-'+month;
  google.script.run.withSuccessHandler(function(data){
    reportData=data;
    if(data.error){ notify('❌ '+data.error); return; }
    var catRows='';
    Object.keys(data.categoryTotals).forEach(function(cat){
      catRows+='<tr><td>'+cat+'</td><td style="text-align:right;font-weight:700;">₹'+data.categoryTotals[cat].toFixed(2)+'</td></tr>';
    });
    if(!catRows) catRows='<tr><td colspan="2" style="text-align:center;color:var(--gray-600);">No expenses</td></tr>';
    document.getElementById('rep-category-body').innerHTML=catRows;
    var empRows='';
    Object.keys(data.empTotals).forEach(function(emp){
      var t=data.empTotals[emp];
      var effect=t.balance>0?'<span style="color:#ef4444">Deduct ₹'+t.balance.toFixed(2)+'</span>':t.balance<0?'<span style="color:#10b981">Add ₹'+Math.abs(t.balance).toFixed(2)+'</span>':'<span style="color:#6b7280">No change</span>';
      empRows+='<tr><td>'+emp+'</td><td style="text-align:right;">₹'+t.advance.toFixed(2)+'</td><td style="text-align:right;">₹'+t.expense.toFixed(2)+'</td><td style="text-align:right;">₹'+Math.abs(t.balance).toFixed(2)+'</td><td>'+effect+'</td></tr>';
    });
    if(!empRows) empRows='<tr><td colspan="5" style="text-align:center;color:var(--gray-600);">No data</td></tr>';
    document.getElementById('rep-emp-body').innerHTML=empRows;
    document.getElementById('report-result').style.display='block';
    notify('✅ Report generated');
  }).withFailureHandler(function(e){ notify('❌ '+e); }).getAdvanceReport(monthKey);
}

function exportReportPDF() {
  if(!reportData){ notify('⚠️ Generate report first'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF();
  var monthName=document.getElementById('rep-month').selectedOptions[0].textContent;
  var year=document.getElementById('rep-year').value;
  doc.setFontSize(16); doc.text('Advance & Expense Report – '+monthName+' '+year,105,15,{align:'center'});
  doc.setFontSize(12); doc.text('Category-wise Expenses',14,28);
  doc.autoTable({head:[['Category','Total Amount']],body:Object.keys(reportData.categoryTotals).map(function(c){ return [c,'₹'+reportData.categoryTotals[c].toFixed(2)]; }),startY:32,theme:'striped',styles:{fontSize:9},headStyles:{fillColor:[99,102,241]}});
  var finalY=doc.lastAutoTable.finalY+8;
  doc.setFontSize(12); doc.text('Employee-wise Summary',14,finalY);
  doc.autoTable({head:[['Employee','Advance','Expense','Balance','Effect on Salary']],body:Object.keys(reportData.empTotals).map(function(e){ var t=reportData.empTotals[e]; return [e,'₹'+t.advance.toFixed(2),'₹'+t.expense.toFixed(2),'₹'+Math.abs(t.balance).toFixed(2),t.balance>0?'Deduct ₹'+t.balance.toFixed(2):t.balance<0?'Add ₹'+Math.abs(t.balance).toFixed(2):'No change']; }),startY:finalY+4,theme:'grid',styles:{fontSize:8},headStyles:{fillColor:[99,102,241]}});
  doc.save('Report_'+year+'_'+monthName+'.pdf');
}

// ══════════════════════════════════════════════════════
// SALARY SLIP TAB
// ══════════════════════════════════════════════════════
function toggleAttendanceDetail() {
  var sec = document.getElementById('att-detail-section');
  var btn = document.getElementById('att-detail-toggle-btn');
  var arrow = document.getElementById('att-detail-arrow');
  if(sec.style.display === 'none') {
    sec.style.display = 'block';
    btn.textContent = 'Hide';
    arrow.textContent = '▼';
  } else {
    sec.style.display = 'none';
    btn.textContent = 'Show';
    arrow.textContent = '▶';
  }
}

function generateSalarySlip() {
  var empName=document.getElementById('salary-emp-select').value;
  if(!empName){ notify('⚠️ Select employee'); return; }
  var m=document.getElementById('salary-month-select').value;
  var year=document.getElementById('salary-year-select').value;
  var monthName=document.getElementById('salary-month-select').selectedOptions[0].textContent;
  var employee=cache.employees.find(function(e){ return e.name===empName; });
  if(!employee){ notify('⚠️ Employee not found'); return; }
  var daysInMonth=new Date(year,parseInt(m),0).getDate();
  var monthlyData=[]; var present=0,absent=0,holiday=0,halfday=0,otTotal=0,totalWorked=0,totalSundays=0,sundayWorked=0,sundayHolWorked=0,holidayWorked=0,sundayHolidays=0,leaves=0;
  for(var i=1;i<=daysInMonth;i++){
    var ds=year+'-'+m+'-'+String(i).padStart(2,'0');
    var rec=cache.attendance.find(function(a){ return a.name===empName&&a.date===ds; });
    var isSun=isSunday(ds), isHol=isHoliday(ds);
    if(isSun) totalSundays++;
    var status='Absent', inTime='-', outTime='-', ot='-', site='-';
    if(rec){ status=rec.status; inTime=rec.inTime||'-'; outTime=rec.outTime||'-';
      ot=(rec.status==='Holiday'||rec.status==='Absent')?'-':(rec.ot||'0'); site=rec.site||'-'; }
    if(status==='Absent'||status==='Holiday'){ inTime='-'; outTime='-'; ot='-'; }
    if(isSun&&isHol) sundayHolidays++;
    if(status==='Present'){ present++; if(ot!=='-'&&ot!=='') otTotal+=parseFloat(ot);
      if(!isSun&&!isHol) totalWorked++;
      if(isSun&&!isHol) sundayWorked++;
      if(isSun&&isHol){ sundayHolWorked++; } // Sunday that is also a holiday
      if(isHol&&!isSun) holidayWorked++;
    } else if(status==='Half Day'){ halfday++; if(ot!=='-'&&ot!=='') otTotal+=parseFloat(ot);
      if(!isSun&&!isHol){ totalWorked+=0.5; leaves+=0.5; }
    } else if(status==='Absent'){ absent++; if(!isSun&&!isHol) leaves++; }
    else if(status==='Holiday') holiday++;
    monthlyData.push({date:ds,inTime:inTime,outTime:outTime,ot:ot,site:site,status:status});
  }
  document.getElementById('slip-header').innerHTML=''
    +'<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">'
    +'<div>'
    +'<div style="font-size:11px;letter-spacing:1.2px;text-transform:uppercase;color:var(--primary);font-weight:700;margin-bottom:2px;">Salary Slip — '+monthName+' '+year+'</div>'
    +'<div style="font-size:18px;font-weight:700;color:var(--gray-800);">'+employee.name+'</div>'
    +'<div style="font-size:12px;color:var(--gray-600);">'+(employee.designation||'Employee')+' &nbsp;·&nbsp; Code: '+(employee.code||'-')+'</div>'
    +'</div>'
    +'<div style="text-align:right;font-size:12px;color:var(--gray-600);">'
    +'<div>DOJ: '+(employee.doj||'-')+'</div>'
    +'<div>Basic: <strong style="color:var(--primary);">₹'+employee.basicSalary+'</strong></div>'
    +'<div>OT after: <strong>'+( employee.otHours||9)+' hrs/day</strong></div>'
    +'</div>'
    +'</div>';
  document.getElementById('slip-results-body').innerHTML=monthlyData.map(function(r){
    return '<tr><td'+(isSunday(r.date)?' class="sunday-date"':'')+'>'+formatDate(r.date)+'</td>'
      +'<td class="time-column">'+formatTimeAMPM(r.inTime)+'</td><td class="time-column">'+formatTimeAMPM(r.outTime)+'</td>'
      +'<td>'+r.ot+'</td><td>'+r.site+'</td><td><span class="badge '+getStatusBadgeClass(r.status)+'">'+r.status+'</span></td></tr>';
  }).join('');
  document.getElementById('slip-totals').innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;">'
    +'<div class="summary-stat" style="background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1);"><div class="stat-value" style="color:var(--primary);">'+daysInMonth+'</div><div class="stat-label">Total Days</div></div>'
    +'<div class="summary-stat" style="background:#ecfdf5;"><div class="stat-value" style="color:#10b981;">'+present+'</div><div class="stat-label">Present</div></div>'
    +'<div class="summary-stat" style="background:#ecfdf5;"><div class="stat-value" style="color:#10b981;">'+totalWorked.toFixed(1)+'</div><div class="stat-label">Regular Days</div></div>'
    +'<div class="summary-stat" style="background:#dbeafe;border:1px solid #93c5fd;"><div class="stat-value" style="color:#2563eb;">'+totalSundays+'</div><div class="stat-label">Sundays (Paid)</div></div>'
    +(sundayWorked>0?'<div class="summary-stat" style="background:#e0f2fe;border:1px solid #7dd3fc;"><div class="stat-value" style="color:#0284c7;">'+sundayWorked+'</div><div class="stat-label">Sun Worked ✦</div></div>':'')
    +'<div class="summary-stat" style="background:#fff7ed;"><div class="stat-value" style="color:#ea580c;">'+holidayWorked+'</div><div class="stat-label">Holiday Worked</div></div>'
    +'<div class="summary-stat" style="background:#fed7aa;"><div class="stat-value" style="color:#c2410c;">'+halfday+'</div><div class="stat-label">Half Day</div></div>'
    +'<div class="summary-stat" style="background:#fee2e2;"><div class="stat-value" style="color:#ef4444;">'+leaves.toFixed(1)+'</div><div class="stat-label">Leave/Absent</div></div>'
    +'<div class="summary-stat" style="background:#fff3bf;"><div class="stat-value" style="color:#f59e0b;">'+holiday+'</div><div class="stat-label">Holidays</div></div>'
    +'<div class="summary-stat" style="background:#f0fdf4;"><div class="stat-value" style="color:#10b981;">'+otTotal.toFixed(1)+'</div><div class="stat-label">OT Hours</div></div></div>';
  slipData={employee:employee,monthlyData:monthlyData,present:present,absent:absent,halfday:halfday,holiday:holiday,otTotal:otTotal.toFixed(1),days:daysInMonth,monthName:monthName,year:year,month:m,totalWorked:totalWorked.toFixed(1),totalSundays:totalSundays,sundayWorked:sundayWorked,sundayHolWorked:sundayHolWorked,sundayHolidays:sundayHolidays,holidayWorked:holidayWorked,leaves:leaves.toFixed(1)};
  var monthKey=year+'-'+m;
  google.script.run.withSuccessHandler(function(netAdv){
    currentAdvanceAmount=netAdv.netBalance;
    document.getElementById('advance-amount').value='0';
    var infoDiv=document.getElementById('advance-expense-info');
    infoDiv.style.display='block';
    infoDiv.innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center;">'
      +'<div><div style="font-size:10px;color:var(--gray-600);">Total Advance Given</div><div style="font-size:18px;font-weight:700;color:#2563eb;">₹'+netAdv.totalAdvances.toFixed(2)+'</div></div>'
      +'<div><div style="font-size:10px;color:var(--gray-600);">Total Expense</div><div style="font-size:18px;font-weight:700;color:#ef4444;">₹'+netAdv.totalExpenses.toFixed(2)+'</div></div>'
      +'<div><div style="font-size:10px;color:var(--gray-600);">'+(netAdv.netBalance>=0?'Deduct from Salary':'Add to Salary')+'</div><div style="font-size:18px;font-weight:700;color:'+(netAdv.netBalance>=0?'#ef4444':'#10b981')+';">₹'+Math.abs(netAdv.netBalance).toFixed(2)+'</div></div></div>';
    salaryCalculation=calculateSalary(employee,present,sundayWorked,sundayHolWorked,holidayWorked,otTotal,daysInMonth,totalSundays);
    displaySalaryBreakdown();
  }).withFailureHandler(function(){
    var oldAdv=cache.advances.find(function(a){ return a.month===monthKey&&a.name===empName; });
    currentAdvanceAmount=oldAdv?parseFloat(oldAdv.amount):0;
    document.getElementById('advance-amount').value=currentAdvanceAmount||0;
    salaryCalculation=calculateSalary(employee,present,sundayWorked,sundayHolWorked,holidayWorked,otTotal,daysInMonth,totalSundays);
    displaySalaryBreakdown();
  }).getNetAdvanceForSalary(empName,monthKey);
  document.getElementById('slip-content').style.display='block';
  notify('✅ Salary slip generated');
}

function calculateSalary(employee,present,sundayWorked,sundayHolWorked,holidayWorked,otTotal,daysInMonth,totalSundays) {
  var basic=parseFloat(employee.basicSalary||0);
  var perDay=basic/daysInMonth;
  // Regular days = present minus all special-day types
  var regularDays=present-sundayWorked-sundayHolWorked-holidayWorked;
  var regSal=regularDays*perDay;
  var sundayPay=(totalSundays||0)*perDay;          // ALL Sundays paid (weekly off)
  var sundayWorkedExtra=(sundayWorked||0)*perDay;  // Extra pay for actually working on Sunday
  var holSal=holidayWorked*perDay;                 // Weekday holiday worked
  var otRate=perDay/(parseFloat(employee.otHours||9));
  var otSal=otTotal*otRate;
  var total=regSal+sundayPay+sundayWorkedExtra+holSal+otSal;
  var advance=currentAdvanceAmount;
  var net=total-advance;
  return {basicSalary:basic.toFixed(2),perDaySalary:perDay.toFixed(2),
    regularDaysWorked:regularDays,regularSalary:regSal.toFixed(2),
    sundayPay:sundayPay.toFixed(2),sundayCount:(totalSundays||0),
    sundayWorkedExtra:sundayWorkedExtra.toFixed(2),sundayWorkedCount:(sundayWorked||0),
    holidaySalary:holSal.toFixed(2),
    otHourlyRate:otRate.toFixed(2),otSalary:otSal.toFixed(2),
    totalSalary:total.toFixed(2),advance:advance.toFixed(2),netSalary:net.toFixed(2)};
}

function displaySalaryBreakdown() {
  if(!salaryCalculation) return;
  var adv=parseFloat(salaryCalculation.advance);
  var advLabel=adv>=0?'Advance Deduction (Net Balance)':'Extra Expense Addition';
  var advColor=adv>=0?'#ef4444':'#10b981';
  var advStr=adv>=0?'- ₹'+salaryCalculation.advance:'+ ₹'+Math.abs(adv).toFixed(2);
  document.getElementById('salary-breakdown-content').innerHTML='<div class="salary-row"><span class="salary-label">Basic Salary (Monthly)</span><span class="salary-value">₹'+salaryCalculation.basicSalary+'</span></div>'
    +'<div class="salary-row" style="background:#f9fafb;"><span class="salary-label">Regular Days ('+salaryCalculation.regularDaysWorked+' days)</span><span class="salary-value">₹'+salaryCalculation.regularSalary+'</span></div>'
    +'<div class="salary-row" style="background:#dbeafe;"><span class="salary-label">Sundays — Paid Off ('+salaryCalculation.sundayCount+' days)</span><span class="salary-value" style="color:#2563eb;">₹'+salaryCalculation.sundayPay+'</span></div>'
    +(salaryCalculation.sundayWorkedCount>0?'<div class="salary-row" style="background:#e0f2fe;"><span class="salary-label">Sunday Worked — Extra Pay ('+salaryCalculation.sundayWorkedCount+' days)</span><span class="salary-value" style="color:#0284c7;">₹'+salaryCalculation.sundayWorkedExtra+'</span></div>':'')
    +'<div class="salary-row" style="background:#f9fafb;"><span class="salary-label">Holiday Worked ('+(slipData?slipData.holidayWorked:0)+' days)</span><span class="salary-value">₹'+salaryCalculation.holidaySalary+'</span></div>'
    +'<div class="salary-row" style="background:#f9fafb;"><span class="salary-label">OT ('+(slipData?slipData.otTotal:0)+' hrs @ ₹'+salaryCalculation.otHourlyRate+'/hr)</span><span class="salary-value">₹'+salaryCalculation.otSalary+'</span></div>'
    +'<div class="salary-row" style="background:#fef3c7;font-weight:700;"><span class="salary-label">Gross Salary</span><span class="salary-value" style="color:#f59e0b;">₹'+salaryCalculation.totalSalary+'</span></div>'
    +'<div class="salary-row" style="background:'+(adv>=0?'#fee2e2':'#ecfdf5')+';"><span class="salary-label">'+advLabel+'</span><span class="salary-value" style="color:'+advColor+';">'+advStr+'</span></div>'
    +'<div class="salary-row" style="background:#f0fdf4;"><span class="salary-label" style="color:#065f46;font-weight:800;">NET PAYABLE SALARY</span><span class="salary-value" style="font-size:20px;color:#10b981;">₹'+salaryCalculation.netSalary+'</span></div>';
}

function addAdvanceAmount() {
  if(!slipData){ notify('⚠️ Generate slip first'); return; }
  var amount=parseFloat(document.getElementById('advance-amount').value);
  if(isNaN(amount)||amount<0){ notify('⚠️ Enter valid amount'); return; }
  var monthKey=slipData.year+'-'+slipData.month;
  google.script.run.withSuccessHandler(function(r){
    if(r.success){
      currentAdvanceAmount=amount;
      document.getElementById('advance-display').style.display='block';
      document.getElementById('advance-display').innerHTML='<div style="background:white;padding:14px;border-radius:8px;border:2px solid var(--primary);"><div style="font-size:11px;color:var(--gray-600);">Override Advance</div><div style="font-size:22px;font-weight:700;color:var(--danger);">₹'+amount.toFixed(2)+'</div></div>';
      salaryCalculation=calculateSalary(slipData.employee,slipData.present,slipData.sundayWorked,slipData.sundayHolWorked||0,slipData.holidayWorked,parseFloat(slipData.otTotal),slipData.days,slipData.totalSundays||0);
      displaySalaryBreakdown();
      notify('✅ '+r.message);
    } else notify('❌ '+r.message);
  }).addAdvance({month:monthKey,name:slipData.employee.name,amount:amount.toString()});
}

// ══════════════════════════════════════════════════════
// ALL EMPLOYEE SALARY REPORT
// ══════════════════════════════════════════════════════
var allSalaryData = null;

function generateAllSalary() {
  var month = document.getElementById('all-sal-month').value;
  var year  = document.getElementById('all-sal-year').value;
  var monthName = document.getElementById('all-sal-month').selectedOptions[0].textContent;
  var active = cache.employees.filter(function(e){ return e.status.toLowerCase()==='active'; });
  if(!active.length){ notify('⚠️ No active employees'); return; }
  var daysInMonth = new Date(year, parseInt(month), 0).getDate();

  var rows = [];
  var totals = { days:0, present:0, regDays:0, sundays:0, sunWorked:0, holWorked:0, halfDay:0, ot:0, gross:0, advance:0, net:0 };

  active.forEach(function(emp) {
    var present=0, halfday=0, totalWorked=0, totalSundays=0, sundayWorked=0, sundayHolWorked=0, holidayWorked=0, otTotal=0;
    for(var i=1;i<=daysInMonth;i++){
      var ds=year+'-'+month+'-'+String(i).padStart(2,'0');
      var rec=cache.attendance.find(function(a){ return a.name===emp.name&&a.date===ds; });
      var isSun=isSunday(ds), isHol=isHoliday(ds);
      if(isSun) totalSundays++;
      if(!rec) continue;
      var status=rec.status, ot=(rec.status==='Holiday'||rec.status==='Absent')?0:parseFloat(rec.ot||0);
      if(status==='Present'){
        present++; otTotal+=ot;
        if(!isSun&&!isHol) totalWorked++;
        if(isSun&&!isHol) sundayWorked++;
        if(isSun&&isHol) sundayHolWorked++;
        if(isHol&&!isSun) holidayWorked++;
      } else if(status==='Half Day'){
        halfday++; otTotal+=ot;
        if(!isSun&&!isHol) totalWorked+=0.5;
      }
    }
    // look up advance
    var monthKey = year+'-'+month;
    var advRec = cache.advances ? cache.advances.find(function(a){ return a.month===monthKey&&a.name===emp.name; }) : null;
    var advAmt = advRec ? parseFloat(advRec.amount||0) : 0;

    var basic = parseFloat(emp.basicSalary||0);
    var perDay = basic/daysInMonth;
    var regularDays = present-sundayWorked-sundayHolWorked-holidayWorked;
    var regSal = regularDays*perDay;
    var sundayPay = totalSundays*perDay;
    var sunExtra = sundayWorked*perDay;
    var holSal = holidayWorked*perDay;
    var otRate = perDay/(parseFloat(emp.otHours||9));
    var otSal = otTotal*otRate;
    var gross = regSal+sundayPay+sunExtra+holSal+otSal;
    var net = gross - advAmt;

    totals.days += daysInMonth;
    totals.present += present;
    totals.regDays += parseFloat(totalWorked.toFixed(1));
    totals.sundays += totalSundays;
    totals.sunWorked += sundayWorked;
    totals.holWorked += holidayWorked;
    totals.halfDay += halfday;
    totals.ot += otTotal;
    totals.gross += gross;
    totals.advance += advAmt;
    totals.net += net;

    rows.push({
      name:emp.name, code:emp.code||'-', designation:emp.designation||'-',
      basic:basic, days:daysInMonth, present:present,
      regDays:parseFloat(totalWorked.toFixed(1)), sundays:totalSundays,
      sunWorked:sundayWorked, holWorked:holidayWorked,
      halfDay:halfday, ot:otTotal.toFixed(1),
      regSal:regSal, sundayPay:sundayPay, sunExtra:sunExtra,
      holSal:holSal, otSal:otSal, gross:gross,
      advance:advAmt, net:net
    });
  });

  allSalaryData = { month:month, year:year, monthName:monthName, rows:rows, totals:totals, days: new Date(year,parseInt(month),0).getDate() };

  // Render period label
  var periodEl = document.getElementById('all-sal-period');
  periodEl.textContent = '★  SALARY SLIP for '+monthName.toUpperCase()+' '+year;
  periodEl.style.display = 'block';

  // Build header
  var thead = '<tr class="ss-group-header">'
    +'<th colspan="4" style="text-align:left;">EMPLOYEE INFO</th>'
    +'<th colspan="8" class="ss-calc-group">ATTENDANCE</th>'
    +'<th colspan="5" class="ss-calc-group">SALARY BREAKDOWN</th>'
    +'<th colspan="2">SUMMARY</th>'
    +'</tr>'
    +'<tr>'
    +'<th>Employee</th><th>Code</th><th>Designation</th><th>Basic (₹)</th>'
    +'<th>Days</th><th>Present</th><th>Reg Days</th><th>Sundays</th><th>Sun Worked</th><th>Hol Worked</th><th>Half Day</th><th>OT Hrs</th>'
    +'<th>Reg Pay</th><th>Sun Pay</th><th>Holiday Pay</th><th>OT Pay</th><th>Gross (₹)</th>'
    +'<th>Advance (₹)</th><th style="background:#064e3b;color:#6ee7b7;">Net Payable (₹)</th>'
    +'</tr>';

  document.getElementById('all-sal-head').outerHTML = thead; // won't work directly
  document.getElementById('all-sal-table').querySelector('thead').innerHTML = thead;

  // Build body
  var tbody = rows.map(function(r){
    return '<tr>'
      +'<td>'+r.name+'</td>'
      +'<td>'+r.code+'</td>'
      +'<td>'+r.designation+'</td>'
      +'<td>₹'+r.basic.toLocaleString('en-IN')+'</td>'
      +'<td>'+r.days+'</td>'
      +'<td>'+r.present+'</td>'
      +'<td>'+r.regDays+'</td>'
      +'<td>'+r.sundays+'</td>'
      +'<td>'+r.sunWorked+'</td>'
      +'<td>'+r.holWorked+'</td>'
      +'<td>'+r.halfDay+'</td>'
      +'<td>'+r.ot+'</td>'
      +'<td>₹'+r.regSal.toFixed(0)+'</td>'
      +'<td>₹'+(r.sundayPay+r.sunExtra).toFixed(0)+'</td>'
      +'<td>₹'+r.holSal.toFixed(0)+'</td>'
      +'<td>₹'+r.otSal.toFixed(0)+'</td>'
      +'<td style="font-weight:700;">₹'+r.gross.toFixed(2)+'</td>'
      +'<td style="color:#dc2626;">'+( r.advance>0?'-₹'+r.advance.toFixed(2):'—')+'</td>'
      +'<td class="net-payable">₹'+r.net.toFixed(2)+'</td>'
      +'</tr>';
  }).join('');
  document.getElementById('all-sal-body').innerHTML = tbody;

  // Footer totals
  var t = totals;
  document.getElementById('all-sal-foot').innerHTML = '<tr>'
    +'<td colspan="4">TOTAL ('+rows.length+' Employees)</td>'
    +'<td>—</td><td>'+t.present+'</td><td>'+t.regDays.toFixed(1)+'</td>'
    +'<td>'+t.sundays+'</td><td>'+t.sunWorked+'</td><td>'+t.holWorked+'</td>'
    +'<td>'+t.halfDay+'</td><td>'+t.ot.toFixed(1)+'</td>'
    +'<td>—</td><td>—</td><td>—</td><td>—</td>'
    +'<td style="color:#1e293b;">₹'+t.gross.toFixed(2)+'</td>'
    +'<td style="color:#dc2626;">₹'+t.advance.toFixed(2)+'</td>'
    +'<td class="net-payable">₹'+t.net.toFixed(2)+'</td>'
    +'</tr>';

  document.getElementById('all-sal-table').style.display = 'table';
  document.getElementById('all-sal-empty').style.display = 'none';
  notify('✅ Salary report generated for '+rows.length+' employee(s)');
}

function exportAllSalaryPDF() {
  if(!allSalaryData){ notify('⚠️ Generate report first'); return; }
  var jsPDF=window.jspdf.jsPDF;
  var doc=new jsPDF('landscape');
  var pw=doc.internal.pageSize.getWidth();
  var d=allSalaryData;

  // Header bar
  doc.setFillColor(30,41,59);
  doc.rect(0,0,pw,20,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(14); doc.setFont(undefined,'bold');
  doc.text('SALARY SLIP FOR '+d.monthName.toUpperCase()+' '+d.year, pw/2, 9, {align:'center'});
  doc.setFontSize(8); doc.setFont(undefined,'normal');
  doc.text('Generated: '+new Date().toLocaleDateString('en-IN')+'   |   '+d.rows.length+' Employees', pw/2, 16, {align:'center'});

  var body = d.rows.map(function(r){
    return [r.name, r.code, r.designation,
      '₹'+r.basic.toLocaleString('en-IN'),
      r.days, r.present, r.regDays, r.sundays, r.sunWorked, r.holWorked, r.halfDay, r.ot,
      '₹'+r.regSal.toFixed(0), '₹'+(r.sundayPay+r.sunExtra).toFixed(0), '₹'+r.holSal.toFixed(0), '₹'+r.otSal.toFixed(0),
      '₹'+r.gross.toFixed(2),
      r.advance>0?'-₹'+r.advance.toFixed(2):'—',
      '₹'+r.net.toFixed(2)
    ];
  });

  var t = d.totals;
  var footRow = ['TOTAL ('+d.rows.length+' Emps)','','','','—',t.present,t.regDays.toFixed(1),t.sundays,t.sunWorked,t.holWorked,t.halfDay,t.ot.toFixed(1),
    '—','—','—','—','₹'+t.gross.toFixed(2),'₹'+t.advance.toFixed(2),'₹'+t.net.toFixed(2)];

  doc.autoTable({
    head:[
      [{content:'Employee Info',colSpan:4,styles:{fillColor:[30,41,59],textColor:[148,163,184],halign:'center'}},
       {content:'Attendance',colSpan:8,styles:{fillColor:[15,23,42],textColor:[100,116,139],halign:'center'}},
       {content:'Salary Breakdown',colSpan:5,styles:{fillColor:[15,23,42],textColor:[100,116,139],halign:'center'}},
       {content:'Summary',colSpan:2,styles:{fillColor:[30,41,59],textColor:[148,163,184],halign:'center'}}],
      ['Employee','Code','Designation','Basic','Days','Present','Reg Days','Sundays','Sun Wkd','Hol Wkd','Half','OT Hrs',
       'Reg Pay','Sun Pay','Hol Pay','OT Pay','Gross','Advance','Net Payable']
    ],
    body: body,
    foot: [footRow],
    startY: 24,
    styles: { fontSize:7, cellPadding:2.5, halign:'center' },
    columnStyles: {
      0:{halign:'left',fontStyle:'bold',cellWidth:22},
      1:{cellWidth:12},
      2:{cellWidth:18},
      18:{textColor:[5,150,105],fontStyle:'bold'}
    },
    headStyles: { fillColor:[71,85,105], textColor:[255,255,255], fontSize:7, fontStyle:'bold' },
    footStyles: { fillColor:[248,250,252], textColor:[30,41,59], fontStyle:'bold', fontSize:7.5 },
    didParseCell: function(data) {
      if(data.section==='foot' && data.column.index===18) {
        data.cell.styles.textColor=[5,150,105]; data.cell.styles.fontStyle='bold'; data.cell.styles.fontSize=9;
      }
      if(data.section==='body' && data.column.index===18) {
        data.cell.styles.textColor=[5,150,105]; data.cell.styles.fontStyle='bold';
      }
    },
    theme: 'grid',
    margin: { left:4, right:4 }
  });

  doc.save('Salary_Report_'+d.monthName+'_'+d.year+'.pdf');
  notify('✅ PDF exported');
}

function exportSalaryPDF() {
  if(!slipData||!salaryCalculation){ notify('⚠️ Generate slip first'); return; }
  var jsPDF=window.jspdf.jsPDF;
  var doc=new jsPDF();
  var pw=doc.internal.pageSize.getWidth();   // 210
  var ph=doc.internal.pageSize.getHeight();  // 297
  var adv=parseFloat(salaryCalculation.advance);
  var emp=slipData.employee;

  // ══════════════════════════════════════════════
  // PAGE 1 — SALARY SLIP
  // ══════════════════════════════════════════════

  // ── SLIM HEADER BAR (reduced height) ──
  doc.setFillColor(99,102,241);
  doc.rect(0,0,pw,22,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(14); doc.setFont(undefined,'bold');
  doc.text('SALARY SLIP  —  '+slipData.monthName.toUpperCase()+' '+slipData.year,pw/2,9,{align:'center'});
  doc.setFontSize(8); doc.setFont(undefined,'normal');
  doc.text('Generated: '+new Date().toLocaleDateString('en-IN'),pw/2,16,{align:'center'});

  // ── EMPLOYEE INFO (tight 2-col layout) ──
  var ey=25;
  doc.setFillColor(247,248,250);
  doc.rect(0,ey,pw,18,'F');
  doc.setTextColor(31,41,55);
  doc.setFontSize(12); doc.setFont(undefined,'bold');
  doc.text(emp.name,14,ey+7);
  doc.setFontSize(8); doc.setFont(undefined,'normal'); doc.setTextColor(75,85,99);
  doc.text((emp.designation||'Employee')+'   |   Code: '+(emp.code||'-')+'   |   DOJ: '+(emp.doj||'-'),14,ey+13);
  doc.setFontSize(8); doc.setFont(undefined,'bold'); doc.setTextColor(99,102,241);
  doc.text('Basic Salary: Rs. '+Number(emp.basicSalary||0).toLocaleString('en-IN')+'   |   OT Threshold: '+(emp.otHours||9)+' hrs/day',pw-14,ey+13,{align:'right'});

  var lineY=ey+18;
  doc.setDrawColor(226,232,240); doc.setLineWidth(0.3);
  doc.line(0,lineY,pw,lineY);

  // ── ATTENDANCE SUMMARY (compact 5-col grid) ──
  var sy=lineY+5;
  doc.setFontSize(8); doc.setFont(undefined,'bold'); doc.setTextColor(31,41,55);
  doc.text('ATTENDANCE SUMMARY',14,sy);
  sy+=3;

  var summaryItems=[
    ['Total Days',slipData.days,'white'],
    ['Present',slipData.present,'#ecfdf5'],
    ['Regular Days',slipData.totalWorked,'#d1fae5'],
    ['Sundays (Paid)',slipData.totalSundays,'#dbeafe'],
    ['Holiday Worked',slipData.holidayWorked,'#fff7ed'],
    ['Half Day',slipData.halfday,'#fed7aa'],
    ['Leave/Absent',slipData.leaves,'#fee2e2'],
    ['OT Hours',slipData.otTotal,'#f0fdf4'],
    ['Holidays',slipData.holiday,'#fef9c3'],
  ];
  var cols=5; var cw=(pw-28)/cols; var ch=10;
  summaryItems.forEach(function(item,i){
    var col=i%cols; var row=Math.floor(i/cols);
    var cx=14+col*cw; var cy=sy+row*ch;
    // parse hex bg
    var bg=item[2];
    if(bg==='white') doc.setFillColor(255,255,255);
    else {
      var r=parseInt(bg.slice(1,3),16), g=parseInt(bg.slice(3,5),16), b=parseInt(bg.slice(5,7),16);
      doc.setFillColor(r,g,b);
    }
    doc.rect(cx,cy,cw-1,ch-0.5,'F');
    doc.setDrawColor(226,232,240); doc.rect(cx,cy,cw-1,ch-0.5,'S');
    doc.setFontSize(6); doc.setFont(undefined,'normal'); doc.setTextColor(107,114,128);
    doc.text(String(item[0]),cx+2,cy+3.5);
    doc.setFontSize(9); doc.setFont(undefined,'bold'); doc.setTextColor(31,41,55);
    doc.text(String(item[1]),cx+2,cy+8);
  });

  var tableY=sy+Math.ceil(summaryItems.length/cols)*ch+5;
  doc.setDrawColor(226,232,240); doc.line(14,tableY-3,pw-14,tableY-3);

  // ── SALARY CALCULATION TABLE ──
  doc.setFontSize(8); doc.setFont(undefined,'bold'); doc.setTextColor(31,41,55);
  doc.text('SALARY CALCULATION',14,tableY);
  tableY+=3;

  var salRows=[
    ['Basic Salary (Monthly)','','Rs. '+Number(salaryCalculation.basicSalary).toLocaleString('en-IN')],
    ['Regular Days Worked',salaryCalculation.regularDaysWorked+' days','Rs. '+Number(salaryCalculation.regularSalary).toLocaleString('en-IN')],
    ['Sundays — Paid Off',slipData.totalSundays+' days','Rs. '+Number(salaryCalculation.sundayPay).toLocaleString('en-IN')],
  ];
  if(salaryCalculation.sundayWorkedCount>0) salRows.push(['Sunday Worked — Extra Pay',salaryCalculation.sundayWorkedCount+' days','Rs. '+Number(salaryCalculation.sundayWorkedExtra).toLocaleString('en-IN')]);
  salRows.push(
    ['Holiday Worked',slipData.holidayWorked+' days','Rs. '+Number(salaryCalculation.holidaySalary).toLocaleString('en-IN')],
    ['Overtime',slipData.otTotal+' hrs @ Rs.'+Number(salaryCalculation.otHourlyRate).toFixed(2)+'/hr','Rs. '+Number(salaryCalculation.otSalary).toLocaleString('en-IN')]
  );

  doc.autoTable({
    head:[['Component','Details','Amount']],
    body:salRows,
    startY:tableY,
    theme:'grid',
    styles:{fontSize:8.5,cellPadding:{top:3,bottom:3,left:4,right:4}},
    headStyles:{fillColor:[99,102,241],textColor:[255,255,255],fontStyle:'bold',fontSize:8.5},
    columnStyles:{
      0:{fontStyle:'bold',cellWidth:85},
      1:{cellWidth:55,textColor:[107,114,128],fontSize:7.5},
      2:{halign:'right',fontStyle:'bold',cellWidth:46}
    },
    didParseCell:function(d){
      if(d.section==='body'&&d.row.index%2===1) d.cell.styles.fillColor=[249,250,251];
      if(d.section==='body'&&salRows[d.row.index]&&salRows[d.row.index][0]==='Sundays — Paid Off'){
        d.cell.styles.fillColor=[219,234,254];
      }
      if(d.section==='body'&&salRows[d.row.index]&&salRows[d.row.index][0]==='Sunday Worked — Extra Pay'){
        d.cell.styles.fillColor=[224,242,254];
      }
    }
  });

  // ── GROSS / DEDUCTION / NET BARS ──
  var gy=doc.lastAutoTable.finalY;

  // Gross Salary
  doc.setFillColor(254,243,199);
  doc.rect(14,gy,pw-28,9,'F');
  doc.setFontSize(9); doc.setFont(undefined,'bold'); doc.setTextColor(120,53,15);
  doc.text('GROSS SALARY',18,gy+6.5);
  doc.text('Rs. '+Number(salaryCalculation.totalSalary).toLocaleString('en-IN'),pw-14,gy+6.5,{align:'right'});
  gy+=9;

  // Advance / Expense
  doc.setFillColor(adv>=0?254:209, adv>=0?226:250, adv>=0?226:229);
  doc.rect(14,gy,pw-28,9,'F');
  doc.setFontSize(9); doc.setFont(undefined,'bold');
  doc.setTextColor(adv>=0?153:5, adv>=0?27:150, adv>=0?27:105);
  doc.text(adv>=0?'ADVANCE DEDUCTION':'EXPENSE ADDITION',18,gy+6.5);
  doc.text((adv>=0?'- ':'+ ')+'Rs. '+Number(Math.abs(adv)).toLocaleString('en-IN'),pw-14,gy+6.5,{align:'right'});
  gy+=9;

  // Net Payable — green banner
  doc.setFillColor(16,185,129);
  doc.rect(14,gy,pw-28,12,'F');
  doc.setFontSize(11); doc.setFont(undefined,'bold'); doc.setTextColor(255,255,255);
  doc.text('NET PAYABLE SALARY',18,gy+8.5);
  doc.setFontSize(12);
  doc.text('Rs. '+Number(salaryCalculation.netSalary).toLocaleString('en-IN'),pw-14,gy+8.5,{align:'right'});
  gy+=12;

  // Footer
  doc.setFontSize(6.5); doc.setFont(undefined,'normal'); doc.setTextColor(156,163,175);
  doc.text('This is a computer-generated salary slip.',pw/2,gy+8,{align:'center'});

  // ══════════════════════════════════════════════
  // PAGE 2 — ATTENDANCE DETAIL (always single page, compact grid)
  // ══════════════════════════════════════════════
  doc.addPage();

  // Page 2 header strip
  doc.setFillColor(99,102,241);
  doc.rect(0,0,pw,14,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont(undefined,'bold');
  doc.text('ATTENDANCE DETAIL — '+slipData.monthName.toUpperCase()+' '+slipData.year+'   |   '+emp.name,pw/2,9,{align:'center'});

  // We have max 31 rows. Fit all into one page.
  // Available height: ~280. Header used: 14. Margins: top 18, bottom 8.
  // So usable height for table = 280 - 14 - 8 = ~258px
  // With 31 rows + 1 header: 32 rows. rowHeight = 258/32 ≈ 8. Use fontSize 6.5, padding 2.

  var attBody=slipData.monthlyData.map(function(r,i){
    var dayNum=i+1;
    var isSun=isSunday(r.date);
    var isHol=isHoliday(r.date);
    var dayType=isSun&&isHol?'Sun+Hol':isSun?'Sunday':isHol?'Holiday':'Weekday';
    return [
      String(dayNum).padStart(2,'0'),
      formatDate(r.date).split('-')[0]+' '+formatDate(r.date).split('-')[1].slice(0,3),
      dayType,
      formatTime(r.inTime),
      formatTime(r.outTime),
      r.ot==='-'?'-':r.ot,
      r.site||'-',
      r.status
    ];
  });

  var usableH=ph-14-6; // below strip, above bottom margin
  var rows=attBody.length+1; // +1 header
  var rowH=usableH/rows;
  var fs=Math.min(7, rowH*0.55);
  var pad=Math.max(1, rowH*0.15);

  doc.autoTable({
    head:[['#','Date','Type','In','Out','OT','Site','Status']],
    body:attBody,
    startY:18,
    margin:{left:8,right:8,bottom:6},
    theme:'grid',
    styles:{fontSize:fs, cellPadding:pad, overflow:'ellipsize'},
    headStyles:{fillColor:[99,102,241],textColor:[255,255,255],fontStyle:'bold',fontSize:fs,cellPadding:pad},
    columnStyles:{
      0:{cellWidth:8,halign:'center'},
      1:{cellWidth:24},
      2:{cellWidth:18,halign:'center'},
      3:{cellWidth:18,halign:'center'},
      4:{cellWidth:18,halign:'center'},
      5:{cellWidth:12,halign:'center'},
      6:{cellWidth:'auto'},
      7:{cellWidth:20,halign:'center'}
    },
    didParseCell:function(d){
      if(d.section!=='body') return;
      var status=d.row.raw[7];
      var type=d.row.raw[2];
      if(status==='Absent'){ d.cell.styles.fillColor=[254,226,226]; d.cell.styles.textColor=d.column.index===7?[153,27,27]:[107,114,128]; }
      else if(status==='Holiday'){ d.cell.styles.fillColor=[255,243,191]; d.cell.styles.textColor=d.column.index===7?[146,64,14]:[107,114,128]; }
      else if(type==='Sunday'){ d.cell.styles.fillColor=[237,233,254]; }
      else if(type==='Sun+Hol'){ d.cell.styles.fillColor=[221,214,254]; }
      else if(status==='Present'&&d.column.index===7){ d.cell.styles.textColor=[6,95,70]; }
    },
    // Force fit to single page regardless of row count
    pageBreak:'avoid'
  });

  doc.save('SalarySlip_'+emp.name.replace(/\s+/g,'_')+'_'+slipData.year+'_'+slipData.monthName+'.pdf');
  notify('✅ PDF downloaded');
}
function printSlip() {
  if(!slipData||!salaryCalculation){ notify('⚠️ Generate slip first'); return; }
  var adv=parseFloat(salaryCalculation.advance);
  var html=''
    +'<div style="background:linear-gradient(135deg,#6366f1,#764ba2);color:white;padding:24px;border-radius:8px;margin-bottom:20px;">'
    +'<div style="display:flex;justify-content:space-between;align-items:flex-start;">'
    +'<div><div style="font-size:10px;letter-spacing:2px;opacity:0.75;margin-bottom:4px;">SALARY SLIP</div>'
    +'<div style="font-size:22px;font-weight:700;">'+slipData.employee.name+'</div>'
    +'<div style="font-size:13px;opacity:0.8;">'+(slipData.employee.designation||'Employee')+'</div></div>'
    +'<div style="text-align:right;"><div style="font-size:18px;font-weight:700;">'+slipData.monthName+' '+slipData.year+'</div>'
    +'<div style="font-size:12px;opacity:0.75;">Code: '+(slipData.employee.code||'-')+'</div>'
    +'<div style="font-size:12px;opacity:0.75;">DOJ: '+(slipData.employee.doj||'-')+'</div></div></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.3);font-size:12px;">'
    +'<div>Basic Salary: <strong>Rs. '+Number(slipData.employee.basicSalary||0).toLocaleString('en-IN')+'</strong></div>'
    +'<div>OT Threshold: <strong>'+(slipData.employee.otHours||9)+' hrs/day</strong></div>'
    +'</div></div>'
    +document.getElementById('slip-totals').outerHTML
    +'<div style="border:2px solid #6366f1;border-radius:8px;padding:18px;margin:16px 0;">'
    +'<h3 style="color:#6366f1;text-align:center;margin-bottom:14px;">Salary Calculation</h3>'
    +document.getElementById('salary-breakdown-content').outerHTML
    +'</div>'
    +'<h4 style="margin:16px 0 8px;">Attendance Detail</h4>'
    +document.getElementById('slip-results-table').outerHTML;
  openPrintWindow(html,'Salary Slip – '+slipData.employee.name);
}

// ══════════════════════════════════════════════════════
// SETTINGS TAB – EMPLOYEE
// ══════════════════════════════════════════════════════
function showEmployeeData() {
  isAddingNew=false;
  var n=document.getElementById('emp-lookup-select').value;
  var e=cache.employees.find(function(emp){ return emp.name===n; });
  if(!e) return;
  editingOriginalName=n; renderEmpForm(e);
}
function prepNewEmployee() {
  isAddingNew=true; editingOriginalName='';
  renderEmpForm({name:'',code:'',status:'Active',doj:'',designation:'',basicSalary:'',otHours:'9'});
}
function renderEmpForm(e) {
  var fields=[{l:'👤 Employee Name',id:'f-name',v:e.name,type:'text'},{l:'🔢 Employee Code',id:'f-code',v:e.code,type:'text'},{l:'✓ Status',id:'f-status',v:e.status,type:'select',opts:['Active','Inactive']},{l:'📅 Date of Joining',id:'f-doj',v:e.doj,type:'text'},{l:'💼 Designation',id:'f-desig',v:e.designation,type:'text'},{l:'💰 Basic Salary (Monthly)',id:'f-salary',v:e.basicSalary,type:'number'},{l:'⏱️ OT Hours (Default: 9)',id:'f-ot-hours',v:e.otHours,type:'number'}];
  document.getElementById('emp-fields-container').innerHTML=fields.map(function(f){
    if(f.type==='select') return '<div style="margin-bottom:14px;"><label>'+f.l+'</label><select id="'+f.id+'" style="width:100%;">'+f.opts.map(function(o){ return '<option'+(o===f.v?' selected':'')+'>'+o+'</option>'; }).join('')+'</select></div>';
    return '<div style="margin-bottom:14px;"><label>'+f.l+'</label><input type="'+f.type+'" id="'+f.id+'" value="'+f.v+'" style="width:100%;"'+(f.type==='number'?' min="0" step="0.01"':'')+'/></div>';
  }).join('');
  document.getElementById('emp-form-area').style.display='block';
  document.getElementById('emp-save-btn').onclick=function(){
    var p={oldName:editingOriginalName,name:document.getElementById('f-name').value,code:document.getElementById('f-code').value,status:document.getElementById('f-status').value,doj:document.getElementById('f-doj').value,designation:document.getElementById('f-desig').value,basicSalary:document.getElementById('f-salary').value,otHours:document.getElementById('f-ot-hours').value||'9'};
    google.script.run.withSuccessHandler(function(msg){ notify('✅ '+msg); loadServerData(); document.getElementById('emp-form-area').style.display='none'; }).upsertEmployee(p,isAddingNew);
  };
}
function showEmployeeList(status) {
  document.getElementById('emp-list-processing').style.display='flex';
  google.script.run.withSuccessHandler(function(emps){
    document.getElementById('emp-list-processing').style.display='none';
    if(emps.error){ notify('❌ '+emps.error); return; }
    document.getElementById('employee-list-body').innerHTML=emps.length===0?'<tr><td colspan="7" style="text-align:center;padding:18px;">No '+status+' employees found</td></tr>':emps.map(function(e){ return '<tr><td>'+e.name+'</td><td>'+(e.code||'-')+'</td><td><span class="badge '+(e.status.toLowerCase()==='active'?'badge-success':'badge-danger')+'">'+e.status+'</span></td><td>'+(e.doj||'-')+'</td><td>'+(e.designation||'-')+'</td><td>₹'+(e.basicSalary||'-')+'</td><td>'+(e.otHours||'9')+'</td></tr>'; }).join('');
    document.getElementById('employee-list-container').style.display='block';
    notify('✅ '+emps.length+' '+status+' employee(s)');
  }).getEmployeesByStatus(status);
}

// ══════════════════════════════════════════════════════
// SETTINGS TAB – HOLIDAYS
// (Add Single Holiday section removed; users add via "Add Holiday" button in the list)
// ══════════════════════════════════════════════════════
function loadHolidays() {
  google.script.run.withSuccessHandler(function(holidays){ cache.holidays=holidays; displayHolidays(); }).getHolidays();
}

function displayHolidays() {
  var tbody=document.getElementById('holidays-body');
  if(!cache.holidays||cache.holidays.length===0){
    tbody.innerHTML='<tr><td colspan="4" style="text-align:center;padding:18px;color:var(--gray-600);">No holidays found. Click "Add Holiday" to add one.</td></tr>';
    return;
  }
  tbody.innerHTML=cache.holidays.map(function(h,idx){
    return '<tr data-index="'+idx+'">'
      +'<td><input type="date" class="edit-holiday-date" value="'+h.date+'" style="width:100%;"></td>'
      +'<td><input type="text" class="edit-holiday-reason" value="'+h.reason+'" style="width:100%;"></td>'
      +'<td><input type="text" class="edit-holiday-approved" value="'+h.approvedBy+'" style="width:100%;"></td>'
      +'<td style="text-align:center"><button class="btn btn-absent" onclick="deleteHoliday('+idx+')" style="padding:4px 8px;font-size:10px;">🗑️ Delete</button></td>'
      +'</tr>';
  }).join('');
}

/* NEW: Add a blank row directly into the existing holidays table */
function addNewHolidayRow() {
  var tbody=document.getElementById('holidays-body');
  // Remove "no holidays" placeholder if present
  var placeholder=tbody.querySelector('td[colspan="4"]');
  if(placeholder) tbody.innerHTML='';
  var tr=document.createElement('tr');
  tr.setAttribute('data-index','new-'+Date.now());
  tr.innerHTML='<td><input type="date" class="edit-holiday-date" style="width:100%;"></td>'
    +'<td><input type="text" class="edit-holiday-reason" placeholder="e.g., Diwali" style="width:100%;"></td>'
    +'<td><input type="text" class="edit-holiday-approved" placeholder="Approved by..." style="width:100%;"></td>'
    +'<td style="text-align:center"><button class="btn-delete-row" onclick="this.closest(\'tr\').remove()" style="padding:4px 8px;font-size:14px;">✕</button></td>';
  tbody.appendChild(tr);
  // Scroll to bottom of table so new row is visible
  tr.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function saveEditedHolidays() {
  var rows=document.querySelectorAll('#holidays-body tr'); var updated=[]; var dups=new Set();
  rows.forEach(function(row){
    var dateEl=row.querySelector('.edit-holiday-date');
    var reasonEl=row.querySelector('.edit-holiday-reason');
    var approvedEl=row.querySelector('.edit-holiday-approved');
    if(!dateEl||!reasonEl||!approvedEl) return;
    var date=dateEl.value, reason=reasonEl.value.trim(), approvedBy=approvedEl.value.trim();
    if(date&&reason&&approvedBy){
      if(updated.find(function(h){ return h.date===date; })) dups.add(date);
      else updated.push({date:date,reason:reason,approvedBy:approvedBy});
    }
  });
  if(dups.size>0){ alert('⚠️ Duplicate dates: '+Array.from(dups).map(function(d){ return formatDate(d); }).join(', ')); return; }
  google.script.run.withSuccessHandler(function(r){ if(r.success){ notify('✅ Holidays updated'); loadHolidays(); } else notify('❌ '+r.message); }).updateHolidays(updated);
}

function deleteHoliday(idx) {
  if(!confirm('Delete this holiday?')) return;
  var h=cache.holidays[idx];
  google.script.run.withSuccessHandler(function(r){ if(r.success){ notify('✅ Holiday deleted'); loadHolidays(); } else notify('❌ '+r.message); }).deleteHoliday(h.date);
}

function exportHolidaysPDF() {
  if(!cache.holidays||cache.holidays.length===0){ notify('⚠️ No holidays'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF();
  doc.setFontSize(16); doc.text('Holiday List',105,18,{align:'center'});
  doc.autoTable({head:[['Date','Reason','Approved By']],body:cache.holidays.map(function(h){ return [formatDate(h.date),h.reason,h.approvedBy]; }),startY:28,theme:'striped',headStyles:{fillColor:[99,102,241]}});
  doc.save('Holidays_List.pdf'); notify('✅ PDF exported');
}

// ══════════════════════════════════════════════════════
// SETTINGS TAB – ADVANCE CATEGORY
// ══════════════════════════════════════════════════════
function renderCategoryList() {
  var list=document.getElementById('category-list');
  if(!list) return;
  list.innerHTML=(cache.categories||[]).map(function(c,i){
    return '<div class="cat-row"><input type="text" class="cat-input" value="'+c+'" placeholder="Category name" style="flex:1;"><button class="btn-delete-row" onclick="this.closest(\'.cat-row\').remove()" style="padding:4px 8px;">✕</button></div>';
  }).join('');
}
function addCategoryRow() {
  var list=document.getElementById('category-list');
  var div=document.createElement('div'); div.className='cat-row';
  div.innerHTML='<input type="text" class="cat-input" placeholder="Category name" style="flex:1;"><button class="btn-delete-row" onclick="this.closest(\'.cat-row\').remove()" style="padding:4px 8px;">✕</button>';
  list.appendChild(div);
}
function saveCategories() {
  var inputs=document.querySelectorAll('.cat-input');
  var cats=Array.from(inputs).map(function(i){ return i.value.trim(); }).filter(function(c){ return c!==''; });
  google.script.run.withSuccessHandler(function(r){
    if(r.success){ notify('✅ '+r.message); cache.categories=cats; updateDropdowns(); } else notify('❌ '+r.message);
  }).saveAdvanceCategories(cats);
}

// ══════════════════════════════════════════════════════
// SETTINGS TAB – PROJECTS
// ══════════════════════════════════════════════════════
function renderProjectList() {
  var list=document.getElementById('project-list');
  if(!list) return;
  list.innerHTML=(cache.projects||[]).map(function(p,i){
    return '<div class="proj-row"><input type="text" class="proj-name-input" value="'+p.name+'" placeholder="Project name" style="width:100%;"><input type="text" class="proj-loc-input" value="'+p.location+'" placeholder="Location/Notes" style="width:100%;"><button class="btn-delete-row" onclick="this.closest(\'.proj-row\').remove()" style="padding:4px 8px;">✕</button></div>';
  }).join('');
}
function addProjectRow() {
  var list=document.getElementById('project-list');
  var div=document.createElement('div'); div.className='proj-row';
  div.innerHTML='<input type="text" class="proj-name-input" placeholder="Project name" style="width:100%;"><input type="text" class="proj-loc-input" placeholder="Location/Notes" style="width:100%;"><button class="btn-delete-row" onclick="this.closest(\'.proj-row\').remove()" style="padding:4px 8px;">✕</button>';
  list.appendChild(div);
}
function saveProjects() {
  var rows=document.querySelectorAll('.proj-row'); var projects=[];
  rows.forEach(function(row){
    var name=row.querySelector('.proj-name-input').value.trim();
    var loc=row.querySelector('.proj-loc-input').value.trim();
    if(name) projects.push({name:name,location:loc});
  });
  google.script.run.withSuccessHandler(function(r){
    if(r.success){ notify('✅ '+r.message); cache.projects=projects; } else notify('❌ '+r.message);
  }).saveProjects(projects);
}

// ══════════════════════════════════════════════════════
// PDF / PRINT HELPERS
// ══════════════════════════════════════════════════════
function openPrintWindow(html,title) {
  var pw=window.open('','','width=900,height=800');
  pw.document.write('<html><head><title>'+title+'</title>');
  pw.document.write('<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">');
  pw.document.write('<style>body{font-family:"Inter",sans-serif;padding:24px;}table{width:100%;border-collapse:collapse;margin:16px 0;}th,td{border:1px solid #ccc;padding:7px;text-align:left;font-size:11px;}th{background:#6366f1;color:white;}.badge-success{background:#d1fae5;color:#065f46;padding:3px 7px;border-radius:4px;}.badge-danger{background:#fee2e2;color:#991b1b;padding:3px 7px;border-radius:4px;}.badge-holiday{background:#fff3bf;color:#e67700;padding:3px 7px;border-radius:4px;}.badge-halfday{background:#fed7aa;color:#c2410c;padding:3px 7px;border-radius:4px;}.sunday-date{background:#f3e8ff;}.salary-row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #e5e7eb;}.salary-breakdown{padding:18px;border:2px solid #6366f1;border-radius:8px;margin-top:20px;}h3{text-align:center;color:#6366f1;}</style></head><body>');
  pw.document.write(html);
  pw.document.write('</body></html>');
  pw.document.close(); pw.print();
}

function exportToPDF() {
  if(currentResults.length===0){ notify('⚠️ No data'); return; }
  var jsPDF=window.jspdf.jsPDF; var doc=new jsPDF();
  doc.autoTable({head:[['Date','Name','In','Out','OT','Site','Status']],body:currentResults.map(function(r){ return [formatDate(r.date),r.name,formatTime(r.inTime),formatTime(r.outTime),(r.status==='Holiday'||r.status==='Absent'?'-':(r.ot||'0')),r.site||'-',r.status]; }),theme:'striped',styles:{fontSize:8},headStyles:{fillColor:[99,102,241]}});
  doc.save('attendance_summary.pdf');
}
function printTable() {
  if(currentResults.length===0){ notify('⚠️ No data'); return; }
  openPrintWindow(document.getElementById('dash-results-table').outerHTML,'Attendance Report');
}
// ══════════════════════════════════════════════════════
// TIME ANALYSIS FUNCTION
// ══════════════════════════════════════════════════════
function analyzeTime() {
  var empSelect = document.getElementById('time-analysis-emp-select');
  var monthSelect = document.getElementById('time-analysis-month-select');
  var yearSelect = document.getElementById('time-analysis-year-select');
  var spinner = document.getElementById('time-analysis-spinner');
  var tbody = document.getElementById('time-analysis-body');
  var headerInfo = document.getElementById('time-analysis-header-info');
  
  if(!empSelect || !monthSelect || !yearSelect) return;
  
  var empName = empSelect.value;
  var month = monthSelect.value;
  var year = yearSelect.value;
  
  // Show spinner
  spinner.style.display = 'flex';
  tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#94a3b8;">Loading analysis...</td></tr>';
  
  // Update header
  var monthName = monthSelect.options[monthSelect.selectedIndex].text;
  headerInfo.textContent = (empName === 'ALL' ? 'All Employees' : empName) + ' • ' + monthName + ' ' + year;
  
  // Simulate server call (replace with actual google.script.run call)
  google.script.run
    .withSuccessHandler(function(data) {
      spinner.style.display = 'none';
      displayTimeAnalysis(data);
    })
    .withFailureHandler(function(error) {
      spinner.style.display = 'none';
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#ef4444;">Error loading data: ' + error.message + '</td></tr>';
    })
    .getTimeAnalysisData(empName, month, year);
}

function displayTimeAnalysis(data) {
  var tbody = document.getElementById('time-analysis-body');
  
  if(!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#94a3b8;">No attendance data found for this period.</td></tr>';
    return;
  }
  
  tbody.innerHTML = data.map(function(row) {
    var variance = row.avgVariance ? (row.avgVariance >= 0 ? '+' : '') + row.avgVariance + ' min' : '-';
    
    return '<tr>' +
      '<td style="text-align:left;font-weight:600;">' + row.employeeName + '</td>' +
      '<td class="ta-ontime">' + (row.onTime || 0) + '</td>' +
      '<td class="ta-latein">' + (row.lateIn || 0) + '</td>' +
      '<td class="ta-earlyin">' + (row.earlyIn || 0) + '</td>' +
      '<td class="ta-lateout">' + (row.lateOut || 0) + '</td>' +
      '<td class="ta-earlyout">' + (row.earlyOut || 0) + '</td>' +
      '<td class="ta-total">' + (row.totalDays || 0) + '</td>' +
      '<td class="ta-variance">' + variance + '</td>' +
      '</tr>';
  }).join('');
}
</script>
</body>
</html>
